---
title: "HDFS 源码阅读：15. 高可用机制 (HA)"
date: 2026-01-26T10:00:00+08:00
description: "NameNode HA 是生产环境的标配。解析 ZKFC 选举机制与 QJM 共享存储原理。"
tags: [Hadoop, HDFS, HA, Availability]
weight: 15
---

单点故障 (SPOF) 曾是 HDFS 的噩梦。Hadoop 2.x 引入了 HA，允许配置两个 NameNode：Active 和 Standby。

## 1. 架构概览

*   **Active NameNode**: 对外提供服务。
*   **Standby NameNode**: 实时同步元数据，随时准备接管。
*   **JournalNodes (JN)**: 共享存储，用于存放 EditLog。
*   **ZKFC (ZooKeeper Failover Controller)**: 监控 NameNode 健康状态，并借助 ZK 进行选主。

## 2. 元数据同步 (QJM)

Active NN 将 EditLog 写入 JournalNodes。Standby NN 实时从 JournalNodes 读取 EditLog 并回放。

**Quorum Journal Manager (QJM)**: 基于 Paxos 思想。
*   写入时，只要大多数 JN (N/2+1) 写入成功，即视为成功。
*   解决了“脑裂”问题时的 EditLog 一致性。

## 3. 自动故障转移 (Failover)

**ZKFC** 是一个独立的进程（通常和 NameNode 跑在一起）。

1.  **HealthMonitor**: 周期性调用 NameNode 的 RPC (`monitorHealth`) 检查健康。
2.  **ActiveStandbyElector**: 
    *   在 ZooKeeper 创建临时锁节点 (`/hadoop-ha/nameservice/ActiveStandbyElectorLock`)。
    *   谁创建成功，谁就是 Active。
3.  **Fencing (隔离)**:
    *   如果 Active NN 只是网络断了但进程没死（假死），ZK 锁会过期，Standby 试图成为 Active。
    *   为了防止“双 Active”导致数据错乱，新 Active 必须先把旧 Active "Fence" 掉（比如调用 ssh kill 掉旧进程，或通过 QJM 拒绝旧 Active 的写请求）。

## 4. 脑裂 (Split-Brain) 防护

QJM 提供了天然的脑裂防护。
*   每个 EditLog Segment 都有一个 Epoch (Era)。
*   新 Active 也就是新的 Epoch。
*   JN 承诺只接受更高 Epoch 的写入，拒绝旧 Epoch 的写入。
*   因此，旧 Active 即使还活着，也写不进数据了。
