<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Kafka 源码阅读：12. Rebalance 机制 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/kafka/> /kafka </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2026-01-15</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Kafka 源码阅读：12. Rebalance 机制</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p>Rebalance 是消费者组最重要也最容易出问题的机制。<h2 id=1-hong-fa-tiao-jian>1. 触发条件</h2><ul><li>新成员加入 (Join)。<li>成员主动离开 (Leave)。<li>成员崩溃 (Heartbeat Timeout)。<li>订阅的 Topic Partition 数量变化。</ul><h2 id=2-liu-cheng-liang-jie-duan>2. 流程 (两阶段)</h2><h3 id=phase-1-joingroup>Phase 1: JoinGroup</h3><ul><li>所有成员发送 <code>JoinGroupRequest</code> 给 Coordinator。<li>Coordinator 选出一个 Leader（通常是第一个加入的）。<li>Coordinator 将所有成员的 Metadata 发送给 Leader。</ul><h3 id=phase-2-syncgroup>Phase 2: SyncGroup</h3><ul><li>Leader 在本地计算分区分配方案（如 Range, RoundRobin）。<li>Leader 发送 <code>SyncGroupRequest</code> 给 Coordinator（包含分配方案）。<li>其他成员也发送 <code>SyncGroupRequest</code>（不含方案，仅获取结果）。<li>Coordinator 将方案下发给所有成员。</ul><h2 id=3-you-hua-static-membership>3. 优化 (Static Membership)</h2><p>为了避免临时网络抖动导致的 Rebalance，Kafka 引入了 <strong>Static Membership</strong> (<code>group.instance.id</code>)。 设置了 ID 的消费者重启后，只要在 Session Timeout 内回来，就不会触发 Rebalance。<hr><p><strong>Next</strong>: <a href=../13-fetcher/>Kafka 源码阅读：13. Fetcher</a></div></div></section>