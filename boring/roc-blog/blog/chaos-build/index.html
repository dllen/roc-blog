<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>ChaosBlade 二次开发实践 | Roc's Blog</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2024-08-18</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">ChaosBlade 二次开发实践</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><ul><li><p>背景与目标</p> <ul><li>在企业落地混沌工程时，往往需要定制符合自身技术栈与业务场景的故障注入能力；二次开发的目标是扩展官方场景、统一 CLI/HTTP 入口，并在平台侧形成可审计、可回滚、可观测的闭环。（参考 [0]）</ul><li><p>架构认知（把握扩展点）</p> <ul><li>模块拆分：<code>chaosblade</code>（CLI/HTTP 管理）、<code>chaosblade-spec-go</code>（规范定义）、<code>chaosblade-exec-os</code>/<code>-docker</code>/<code>-cri</code>/<code>-operator</code>/<code>-jvm</code>/<code>-cplus</code> 等领域场景，统一由 CLI 调用，遵循混沌实验模型。（参考 [0]）<li>统一命令：<code>prepare</code>/<code>revoke</code>（环境准备与撤销）、<code>create</code>（创建实验）、<code>destroy</code>（销毁实验）、<code>status</code>（查询状态）。示例：<code>blade create [TARGET] [ACTION] [FLAGS]</code>；Dubbo 延迟示例：<code>blade create dubbo delay --consumer --time 3000 --Service xxx.xxx.Service</code>（参考 [0]）。</ul><li><p>开发准备</p> <ul><li>建议环境：<code>Go >= 1.20</code>、Linux 主机（或容器/K8s 节点）、必要的系统工具（如 <code>tc/iptables/stress-ng</code>）、可选：<code>JDK 8+</code>（JVM 场景）、<code>GDB</code>（C++ 场景）。</ul><li><p>设计你的场景（Spec）</p> <ul><li>明确 <code>Target/Action/Flags</code> 与约束：例如目标是 <code>os.network</code>，动作是 <code>delay/loss</code>，参数含义与合法范围（单位、最小/最大值、是否必填、默认值），以及对环境的依赖与回收策略。<li>在 <code>chaosblade-spec-go</code> 中定义规范结构，声明校验规则与示例用法；完成后在对应 <code>exec-*</code> 项目实现执行逻辑。（参考 [0]）</ul><li><p>实现与注册（以 OS 场景为例）</p> <ul><li>新增 Spec：在 <code>chaosblade-exec-os</code> 中增加你的场景 Spec（如 <code>os network delay</code>），补充参数校验与帮助说明。<li>编写 Executor：根据 Spec 解析参数，调用系统工具注入与回收（例如 <code>tc qdisc</code> 注入延时、<code>iptables</code> 配合丢包、或通过 <code>stress-ng</code> 做 CPU/内存压力）。<li>注册到 CLI/HTTP：在 <code>chaosblade</code> 工程侧暴露新场景（帮助文本、参数说明），保证 <code>blade create ...</code> 能识别并执行。<li>编译验证：执行 <code>blade create ...</code> 获得 <code>uid</code>；用 <code>blade status UID</code> 查看状态；用 <code>blade destroy UID</code> 回收；如涉及 JVM，需先 <code>blade p jvm --process &lt;app></code>，结束后 <code>blade revoke UID</code>（参考 [0]）。</ul><li><p>测试与工程化</p> <ul><li>覆盖正/反/异常路径：非法参数、权限不足、环境缺依赖、重复注入、异常中断后的回收。<li>幂等与回收：确保多次执行不会污染环境；任何失败都能走到回收分支；对系统资源设定超时/重试/保护阈值。<li>可观测性：输出清晰的 <code>uid</code>、阶段日志、关键指标（延时/丢包/CPU/内存等），便于平台观测与审计。</ul><li><p>实战命令片段（示例）</p> <ul><li>环境准备：<code>blade p jvm --process business</code> → 返回 <code>uid</code>；撤销：<code>blade revoke UID</code>。<li>创建实验：<code>blade create os network delay --time 3000 --interface eth0</code>；查询：<code>blade status UID</code>；销毁：<code>blade destroy UID</code>。（命令形态与参数以你的 Spec 为准，参考 [0]）</ul><li><p>常见坑与排错</p> <ul><li>权限与依赖：<code>tc/iptables</code> 需 root；容器内需 CAP 能力；K8s 场景需正确的 CRD 与 Operator。<li>JVM attach 失败：进程名不匹配/无权限/目标 JDK 版本不兼容；优先用 <code>prepare</code> 返回的 <code>uid</code> 做状态跟踪（参考 [0]）。<li>资源回收不彻底：为每一步注入动作设计对称的回收；失败时也要进入回收分支。</ul></ul><h2 id=chaosblade-box-ping-tai-ji-cheng-shi-jian>Chaosblade-box 平台集成实践</h2><ul><li><p>目标与价值</p> <ul><li>将自定义场景在平台侧可视化、流程化管理：支持编排、权限控制、审计与留痕、统一的执行/回收闭环，并与企业现有运维与治理体系对接。（参考 [1]）</ul><li><p>编译与运行（Host/K8s）</p> <ul><li>打包：<code>mvn clean package -Dmaven.test.skip=true</code>。（参考 [1]）<li>MySQL（Docker 示例，需替换密码）： <ul><li><code>docker run -d -it -p 3306:3306 \       -e MYSQL_DATABASE=chaosblade \       -e MYSQL_ROOT_PASSWORD=[DATASOURCE_PASSWORD] \       --name mysql-5.6 mysql:5.6 \       --character-set-server=utf8mb4 \       --collation-server=utf8mb4_unicode_ci \       --default-time_zone='+8:00' \       --lower_case_table_names=1</code></ul><li>启动应用（Host）： <ul><li><code>nohup java -Duser.timezone=Asia/Shanghai -jar chaosblade-box-1.0.0.jar --spring.datasource.url="jdbc:mysql://DATASOURCE_HOST:3306/chaosblade?characterEncoding=utf8&useSSL=false" --spring.datasource.username=DATASOURCE_USERNAME --spring.datasource.password=DATASOURCE_PASSWORD --chaos.server.domain=BOX-HOST > chaosblade-box.log 2>&1 &</code>（参考 [1]）</ul><li>Kubernetes（Helm）： <ul><li><code>helm install chaosblade-box chaosblade-box-1.0.0.tgz --namespace chaosblade --set spring.datasource.password=DATASOURCE_PASSWORD</code>（参考 [1]）</ul></ul><li><p>首次数据与 Agent 参数（节选）</p> <ul><li><code>chaos.function.sync.type</code>：首启可用 <code>ALL</code> 预置数据；可选值 <code>ALL/ChaosBlade/UserApp/None/LITMUS_CHAOS</code>（参考 [1]）。<li><code>chaos.agent.version/chaos.agent.repository/chaos.agent.url/chaos.agent.helm</code>：配置 Agent 包版本与仓库地址（参考 [1]）。</ul><li><p>集成你的自定义场景</p> <ul><li>平台端注册函数定义：绑定 CLI/Operator 场景，维护参数表单与校验；对接执行器与状态查询。<li>K8s 场景建议通过 <code>chaosblade-operator</code> 以 CRD 标准定义与编排，复用平台与 CLI 的统一模型。（参考 [0]）</ul><li><p>平台化流程建议</p> <ul><li>变更审批 → 预检查（依赖、权限、风险）→ 创建实验 → 观测（日志/指标）→ 回收/销毁 → 审计归档。<li>多租户与 RBAC、白名单/黑名单、窗口期与最小化 blast radius、SLO/SLA 保护阈值。</ul><li><p>常见问题与排错</p> <ul><li>数据库连接与权限：确认 <code>DATASOURCE_HOST/USERNAME/PASSWORD</code> 与字符集/时区设置；容器网络与端口暴露。<li>Agent 下载与版本：仓库地址可用自建镜像；确保与目标环境（K8s/Host）兼容；首次同步完成后再执行实验。<li>Helm values：根据集群需求调整资源配额与节点亲和；服务暴露方式与域名解析（参考 [1]）。</ul></ul><h2 id=da-gui-mo-yan-lian-jian-kong-yu-wen-ding-xing-bao-zhang>大规模演练监控与稳定性保障</h2><ul><li><p>设计原则</p> <ul><li>演练前-中-后三段监控闭环：容量评估、实时指标、回收确认。<li>指标分层：资源/平台/中间件/应用四层，设置 SLO 与熔断阈值。<li>平台联动：在 chaosblade-box 中定义“停止条件”，当触发阈值自动终止实验并回收。</ul><li><p>演练熔断与降速建议</p> <ul><li>触发任一核心阈值时：自动执行 <code>destroy</code>/回收，记录 <code>uid</code> 与原因。<li>阀值分级：预警（黄）→ 降速（橙，降低并发/扩大批次间隔）→ 熔断（红）。<li>分批策略：分域/分租户/分环境逐步推进，控制 blast radius。<li>观测确认：回收后持续观察 5–10 分钟，指标回归正常再进入下一批。</ul><li><p>实施清单</p> <ul><li>在 <code>chaosblade-box</code> 配置“停止条件”与告警；对接 Alertmanager。<li>在实验模板/表单中暴露 Redis/MySQL/K8s 指标的阈值可配置项。<li>对关键指标设置 Dashboard 与 Runbook，确保排错路径明确。</ul></ul><h2 id=can-kao-zi-liao>参考资料</h2><ul><li><p>ChaosBlade 项目与规范</p> <ul><li>官方仓库与 CLI 文档：https://github.com/chaosblade-io/chaosblade<li>规范定义（Golang）：https://github.com/chaosblade-io/chaosblade-spec-go<li>OS 场景实现：https://github.com/chaosblade-io/chaosblade-exec-os<li>Docker 场景实现：https://github.com/chaosblade-io/chaosblade-exec-docker<li>CRI 场景实现：https://github.com/chaosblade-io/chaosblade-exec-cri<li>JVM 场景实现：https://github.com/chaosblade-io/chaosblade-exec-jvm<li>C++ 场景实现：https://github.com/chaosblade-io/chaosblade-exec-cplus<li>Kubernetes Operator（CRD）：https://github.com/chaosblade-io/chaosblade-operator</ul><li><p>Chaosblade-box 平台</p> <ul><li>平台仓库与部署说明：https://github.com/chaosblade-io/chaosblade-box</ul><li><p>监控与告警（Prometheus 生态）</p> <ul><li>PromQL 基础与语法：https://prometheus.io/docs/prometheus/latest/querying/basics/<li>Alertmanager 文档：https://prometheus.io/docs/alerting/latest/alertmanager/<li>Redis Exporter（指标项）：https://github.com/oliver006/redis_exporter<li>MySQLd Exporter（指标项）：https://github.com/prometheus/mysqld_exporter<li>Node Exporter（节点指标）：https://github.com/prometheus/node_exporter<li>kube-state-metrics（K8s 对象指标）：https://github.com/kubernetes/kube-state-metrics</ul><li><p>社区文章</p> <ul><li>https://zhuanlan.zhihu.com/p/598323365<li>https://mp.weixin.qq.com/s?__biz=Mzg3MzgxMjc3NA==&mid=2247484031&idx=1&sn=4bfc81c1ee268dc0c8d529a4b5fc9949<li><a href=https://juejin.cn/post/7266092256372998196>混沌工程之 ChaosBlade 利刃出鞘 - 掘金</a><li><a href=https://juejin.cn/post/7267919801779470397>ChaosBlade Tool 故障注入百宝箱 - 掘金</a></ul></ul></div></div></section>