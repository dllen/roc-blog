<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>容器不同网络模式下iptables配置 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2024-01-14</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">容器不同网络模式下iptables配置</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><h2 id=rong-qi-de-wang-luo-mo-shi>容器的网络模式</h2><table><thead><tr><th>Driver<th>Description<tbody><tr><td><code>bridge</code><td>The default network driver.<tr><td><code>host</code><td>Remove network isolation between the container and the Docker host.<tr><td><code>none</code><td>Completely isolate a container from the host and other containers.<tr><td><code>overlay</code><td>Overlay networks connect multiple Docker daemons together.<tr><td><code>ipvlan</code><td>IPvlan networks provide full control over both IPv4 and IPv6 addressing.<tr><td><code>macvlan</code><td>Assign a MAC address to a container.</table><h2 id=hostwang-luo-mo-shi>Host网络模式</h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88># Create a new cgroup and assign it a classid</span></span>
<span class=giallo-l><span style=color:#88c0d0>mkdir</span><span style=color:#a3be8c> /sys/fs/cgroup/net_cls/my_cgroup</span></span>
<span class=giallo-l><span style=color:#88c0d0>echo</span><span style=color:#b48ead> 0x100001</span><span style=color:#81a1c1> ></span><span style=color:#a3be8c> /sys/fs/cgroup/net_cls/my_cgroup/net_cls.classid</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># Run a Docker container and move its process to the newly created cgroup</span></span>
<span class=giallo-l><span style=color:#88c0d0>docker</span><span style=color:#a3be8c> run -d --name my_container my_image</span></span>
<span class=giallo-l><span style=color:#88c0d0>echo</span><span style=color:#eceff4> $(</span><span style=color:#88c0d0>docker</span><span style=color:#a3be8c> inspect -f</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>{{.State.Pid}}</span><span style=color:#eceff4>'</span><span style=color:#a3be8c> my_container</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> ></span><span style=color:#a3be8c> /sys/fs/cgroup/net_cls/my_cgroup/cgroup.procs</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># Use iptables to mark the packets based on the classid</span></span>
<span class=giallo-l><span style=color:#88c0d0>iptables</span><span style=color:#a3be8c> -t mangle -A OUTPUT -m cgroup --cgroup</span><span style=color:#b48ead> 0x100001</span><span style=color:#a3be8c> -j MARK --set-mark</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># Use tc</span></span>
<span class=giallo-l><span style=color:#616e88># configuring tc</span></span>
<span class=giallo-l><span style=color:#88c0d0>tc</span><span style=color:#a3be8c> qdisc add dev eth0 root handle 10: htb</span></span>
<span class=giallo-l><span style=color:#88c0d0>tc</span><span style=color:#a3be8c> class add dev eth0 parent 10: classid 10:1 htb rate 40mbit</span></span>
<span class=giallo-l><span style=color:#616e88># creating traffic class 10:1</span></span>
<span class=giallo-l><span style=color:#88c0d0>tc</span><span style=color:#a3be8c> filter add dev eth0 parent 10: protocol ip prio</span><span style=color:#b48ead> 10</span><span style=color:#a3be8c> handle 1: cgroup</span></span></code></pre><p>说明：<blockquote><p><strong>Host模式，容器与主机的网络配置没有隔离</strong>，需要通过设置 net_cls.classid 标记流量<p>参考文档：<a href=https://www.kernel.org/doc/html/v5.3/admin-guide/cgroup-v1/net_cls.html rel=external>Network classifier cgroup</a></blockquote><blockquote><p>net_cls.classid 数据格式：0xAAAABBBB， AAAA is the major handle number and BBBB is the minor handle number，eg： 0x100001 => 10:1</blockquote><h2 id=fei-hostwang-luo-mo-shi>非Host网络模式</h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88># Get the PID of the container's network namespace</span></span>
<span class=giallo-l><span>PID</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>$(</span><span style=color:#88c0d0>docker</span><span style=color:#a3be8c> inspect -f</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>{{.State.Pid}}</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>container_name_or_i</span><span>d</span><span style=color:#81a1c1>></span><span style=color:#eceff4>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># Enter the network namespace using nsenter</span></span>
<span class=giallo-l><span style=color:#88c0d0>nsenter</span><span style=color:#a3be8c> --net=/proc/</span><span>$PID</span><span style=color:#a3be8c>/ns/net iptables -t nat -A PREROUTING -p tcp --dport</span><span style=color:#b48ead> 80</span><span style=color:#a3be8c> -j REDIRECT --to-port</span><span style=color:#b48ead> 8080</span></span></code></pre><p>说明：<blockquote><p><strong>非Host模式，容器与主机网络配置通过 <a href=https://lwn.net/Articles/580893/ rel=external>Network namespaces</a> 隔离</strong>，需要切换 network namespace 进行配置</blockquote><blockquote><p>network_namespaces手册：<a href=https://man7.org/linux/man-pages/man7/network_namespaces.7.html rel=external>network_namespaces(7) - Linux manual page</a></blockquote><p><strong>namespace 执行小工具</strong>，<code>nsexec.c</code> <a href=https://github.com/chaosblade-io/chaosblade/blob/master/nsexec.c rel=external>nsexec.c</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>define</span><span style=color:#88c0d0> _GNU_SOURCE</span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>stdio.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>unistd.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>errno.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>sched.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>stdio.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>stdlib.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>string.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>fcntl.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>getopt.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>sys/types.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>sys/wait.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>sys/prctl.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>sys/stat.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>sys/syscall.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>extern char**</span><span> environ</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>int</span><span style=color:#88c0d0> enter_ns</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span> pid</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> const char*</span><span> type</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#ifdef</span><span style=color:#88c0d0> __NR_setns</span></span>
<span class=giallo-l><span style=color:#81a1c1>    char</span><span> path</span><span style=color:#eceff4>[</span><span style=color:#b48ead>64</span><span style=color:#eceff4>],</span><span> selfpath</span><span style=color:#eceff4>[</span><span style=color:#b48ead>64</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    snprintf</span><span style=color:#eceff4>(</span><span>path</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> sizeof</span><span style=color:#eceff4>(</span><span>path</span><span style=color:#eceff4>), "</span><span style=color:#a3be8c>/proc/%d/ns/%s</span><span style=color:#eceff4>",</span><span> pid</span><span style=color:#eceff4>,</span><span> type</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    snprintf</span><span style=color:#eceff4>(</span><span>selfpath</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> sizeof</span><span style=color:#eceff4>(</span><span>selfpath</span><span style=color:#eceff4>), "</span><span style=color:#a3be8c>/proc/self/ns/%s</span><span style=color:#eceff4>",</span><span> type</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    struct</span><span> stat oldns_stat</span><span style=color:#eceff4>,</span><span> newns_stat</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>stat</span><span style=color:#eceff4>(</span><span>selfpath</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>oldns_stat</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1> &&</span><span style=color:#88c0d0> stat</span><span style=color:#eceff4>(</span><span>path</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>newns_stat</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Don't try to call setns() if we're in the same namespace already</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span>oldns_stat</span><span style=color:#eceff4>.</span><span>st_ino</span><span style=color:#81a1c1> !=</span><span> newns_stat</span><span style=color:#eceff4>.</span><span>st_ino</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            int</span><span> newns </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> open</span><span style=color:#eceff4>(</span><span>path</span><span style=color:#eceff4>,</span><span> O_RDONLY</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#eceff4> (</span><span>newns </span><span style=color:#81a1c1>&lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return -</span><span style=color:#b48ead>1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // Some ancient Linux distributions do not have setns() function</span></span>
<span class=giallo-l><span style=color:#81a1c1>            int</span><span> result </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> syscall</span><span style=color:#eceff4>(</span><span>__NR_setns</span><span style=color:#eceff4>,</span><span> newns</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>            close</span><span style=color:#eceff4>(</span><span>newns</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span> result </span><span style=color:#81a1c1>&lt;</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1> ? -</span><span style=color:#b48ead>1</span><span style=color:#81a1c1> :</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#endif</span><span style=color:#616e88> // __NR_setns</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>void</span><span style=color:#88c0d0> sig</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span> signum</span><span style=color:#eceff4>){}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>int</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span> argc</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> char *</span><span>argv</span><span style=color:#81a1c1>[]</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> target </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    char *</span><span>cmd</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> stop </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> opt</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> option_index </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    char *</span><span>string </span><span style=color:#81a1c1>=</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>st:mpuni</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> ipcns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> utsns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> netns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> pidns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> mntns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    while</span><span style=color:#eceff4>((</span><span>opt </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0>getopt</span><span style=color:#eceff4>(</span><span>argc</span><span style=color:#eceff4>,</span><span> argv</span><span style=color:#eceff4>,</span><span> string</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>!= -</span><span style=color:#b48ead>1</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        switch</span><span style=color:#eceff4> (</span><span>opt</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            case</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>s</span><span style=color:#eceff4>':</span></span>
<span class=giallo-l><span>                stop </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            case</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>t</span><span style=color:#eceff4>':</span></span>
<span class=giallo-l><span>                target </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> atoi</span><span style=color:#eceff4>(</span><span>optarg</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            case</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>m</span><span style=color:#eceff4>':</span></span>
<span class=giallo-l><span>                mntns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            case</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>p</span><span style=color:#eceff4>':</span></span>
<span class=giallo-l><span>                pidns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            case</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>u</span><span style=color:#eceff4>':</span></span>
<span class=giallo-l><span>                utsns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            case</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>n</span><span style=color:#eceff4>':</span></span>
<span class=giallo-l><span>                netns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            case</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>i</span><span style=color:#eceff4>':</span></span>
<span class=giallo-l><span>                ipcns </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            default</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // check target pid</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4> (</span><span>target </span><span style=color:#81a1c1>&lt;=</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        fprintf</span><span style=color:#eceff4>(</span><span>stderr</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>%s is not a valid process ID</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>",</span><span> target</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // pause</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4>(</span><span>stop</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            char *</span><span>pe </span><span style=color:#81a1c1>=</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>pause</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>            prctl</span><span style=color:#eceff4>(</span><span>PR_SET_NAME</span><span style=color:#eceff4>,</span><span> pe</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>            signal</span><span style=color:#eceff4>(</span><span>SIGCONT</span><span style=color:#eceff4>,</span><span>sig</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>            pause</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            char *</span><span>nc </span><span style=color:#81a1c1>=</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>nsexec</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>            prctl</span><span style=color:#eceff4>(</span><span>PR_SET_NAME</span><span style=color:#eceff4>,</span><span> nc</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // enter namespace</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4>(</span><span>ipcns</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        enter_ns</span><span style=color:#eceff4>(</span><span>target</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>ipc</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4>(</span><span>utsns</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        enter_ns</span><span style=color:#eceff4>(</span><span>target</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>uts</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4>(</span><span>netns</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        enter_ns</span><span style=color:#eceff4>(</span><span>target</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>net</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4>(</span><span>pidns</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        enter_ns</span><span style=color:#eceff4>(</span><span>target</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>pid</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4>(</span><span>mntns</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        enter_ns</span><span style=color:#eceff4>(</span><span>target</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>mnt</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // fork exec</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pid_t</span><span> pid</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> status</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4>((</span><span>pid </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> fork</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>&lt;</span><span style=color:#b48ead>0</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>        status </span><span style=color:#81a1c1>= -</span><span style=color:#b48ead>1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else if</span><span style=color:#eceff4>(</span><span>pid </span><span style=color:#81a1c1>==</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>){</span></span>
<span class=giallo-l><span style=color:#616e88>        // args</span></span>
<span class=giallo-l><span style=color:#81a1c1>        int</span><span> i</span><span style=color:#eceff4>,</span><span>j</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        char *</span><span>args</span><span style=color:#eceff4>[</span><span style=color:#b48ead>256</span><span style=color:#eceff4>]</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span style=color:#81a1c1>NULL</span><span style=color:#eceff4>}</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span style=color:#eceff4>(</span><span>i </span><span style=color:#81a1c1>=</span><span> optind</span><span style=color:#81a1c1>;</span><span> i </span><span style=color:#81a1c1>&lt;</span><span> argc</span><span style=color:#81a1c1>;</span><span> i</span><span style=color:#81a1c1>++</span><span style=color:#eceff4>,</span><span> j</span><span style=color:#81a1c1>++</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>            args</span><span style=color:#eceff4>[</span><span>j</span><span style=color:#eceff4>]</span><span style=color:#81a1c1> =</span><span> argv</span><span style=color:#eceff4>[</span><span>i</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#88c0d0>        execvp</span><span style=color:#eceff4>(</span><span>argv</span><span style=color:#eceff4>[</span><span>optind</span><span style=color:#eceff4>],</span><span> args</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>        _exit</span><span style=color:#eceff4>(</span><span style=color:#b48ead>127</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        while</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>waitpid</span><span style=color:#eceff4>(</span><span>pid</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>status</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>){</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#eceff4>(</span><span>errno </span><span style=color:#81a1c1>!=</span><span> EINTR</span><span style=color:#eceff4>){</span></span>
<span class=giallo-l><span>                status </span><span style=color:#81a1c1>= -</span><span style=color:#b48ead>1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>WIFEXITED</span><span style=color:#eceff4>(</span><span>status</span><span style=color:#eceff4>)){</span></span>
<span class=giallo-l><span style=color:#88c0d0>            exit</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>WEXITSTATUS</span><span style=color:#eceff4>(</span><span>status</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88># 测试</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># compile</span></span>
<span class=giallo-l><span style=color:#88c0d0>gcc</span><span style=color:#a3be8c> nsexec.c -o nsexec</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># Get the PID of the container's network namespace</span></span>
<span class=giallo-l><span>PID</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>$(</span><span style=color:#88c0d0>docker</span><span style=color:#a3be8c> inspect -f</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>{{.State.Pid}}</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>container_name_or_i</span><span>d</span><span style=color:#81a1c1>></span><span style=color:#eceff4>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># exec</span></span>
<span class=giallo-l><span style=color:#88c0d0>./nsexec</span><span style=color:#a3be8c> -n -t PID -- /bin/sh -c</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># check</span></span>
<span class=giallo-l><span style=color:#88c0d0>./nsexec</span><span style=color:#a3be8c> -n -t PID -- /bin/sh -c</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>iptables -t nat -L</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>Chain</span><span style=color:#a3be8c> PREROUTING</span><span> (policy</span><span style=color:#a3be8c> ACCEPT</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>target</span><span style=color:#a3be8c>     prot opt source               destination</span></span>
<span class=giallo-l><span style=color:#88c0d0>REDIRECT</span><span style=color:#a3be8c>   tcp  --  anywhere             anywhere             tcp dpt:http redir ports</span><span style=color:#b48ead> 8080</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>Chain</span><span style=color:#a3be8c> INPUT</span><span> (policy</span><span style=color:#a3be8c> ACCEPT</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>target</span><span style=color:#a3be8c>     prot opt source               destination</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>Chain</span><span style=color:#a3be8c> POSTROUTING</span><span> (policy</span><span style=color:#a3be8c> ACCEPT</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>target</span><span style=color:#a3be8c>     prot opt source               destination</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>Chain</span><span style=color:#a3be8c> OUTPUT</span><span> (policy</span><span style=color:#a3be8c> ACCEPT</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>target</span><span style=color:#a3be8c>     prot opt source               destination</span></span></code></pre></div></div></section>