<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>How to Write a Javaagent | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2021-03-18</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">How to Write a Javaagent</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><h2 id=shen-me-shi-java-agentji-shu>什么是Java Agent技术</h2><p>Java Agent本质上可以理解为一个插件，该插件就是一个精心提供的Jar包，这个Jar包通过JVMTI（JVM Tool Interface）完成加载，最终借助<a href=https://github.com/openjdk/jdk/blob/master/src/java.instrument/share/native/libinstrument/JPLISAgent.c rel=external>JPLISAgent</a>（Java Programming Language Instrumentation Services Agent）完成对目标代码的修改。<p><strong>Java agent的功能</strong><ul><li>可以在加载Java文件之前做拦截把字节码做修改<li>可以在运行期将已经加载的类的字节码做变更<li>………..</ul><p>使用场景<ul><li><p>APM 工具：如 Pinpoint、SkyWalking 等</p><li><p>动态调试和诊断：比较流行的 btrace、arthas 等</p><li><p>热部署：jrebel</p><li><p>混沌工程：jvm-sandbox 等</p></ul><p><img alt src=https://scp-net-cn.oss-cn-beijing.aliyuncs.com/blog-images/java-agent-overview-min.png><h4 id=shi-xian-agentqi-dong-fang-fa>实现Agent启动方法</h4><p>Java Agent支持目标JVM启动时加载，也支持在目标JVM运行时加载，这两种不同的加载模式会使用不同的入口函数，如果需要在目标JVM启动的同时加载Agent，那么可以选择实现下面的方法：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>[1] public static void premain(String agentArgs, Instrumentation inst);</span></span>
<span class=giallo-l><span>[2] public static void premain(String agentArgs);</span></span></code></pre><p>JVM将首先寻找[1]，如果没有发现[1]，再寻找[2]。如果希望在目标JVM运行时加载Agent，则需要实现下面的方法：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>[1] public static void agentmain(String agentArgs, Instrumentation inst);</span></span>
<span class=giallo-l><span>[2] public static void agentmain(String agentArgs);</span></span></code></pre><p>这两组方法的第一个参数AgentArgs是随同 <code>–javaagent</code> 一起传入的程序参数，如果这个字符串代表了多个参数，就需要自己解析这些参数。inst是<code>Instrumentation</code>类型的对象，是JVM自动传入的，我们可以拿这个参数进行类增强等操作。<h4 id=zhi-ding-main-class>指定Main-Class</h4><p>Agent需要打包成一个jar包，在ManiFest属性中指定<code>Premain-Class</code>或者<code>Agent-Class</code>：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>Premain-Class: class</span></span>
<span class=giallo-l><span>Agent-Class: class</span></span></code></pre><h4 id=gua-zai-dao-mu-biao-jvm>挂载到目标JVM</h4><p>将编写的Agent打成jar包后，就可以挂载到目标JVM上去了。如果选择在目标JVM启动时加载Agent，则可以使用<code>-javaagent:[=]</code>，具体的使用方法可以使用<code>Java -Help</code>来查看。<p>如果想要在运行时挂载Agent到目标JVM，就需要做一些额外的开发了。<p>``com.sun.tools.attach.VirtualMachine 这个类代表一个JVM抽象，可以通过这个类找到目标JVM，并且将Agent挂载到目标JVM上。<p>下面是使用<code>com.sun.tools.attach.VirtualMachine</code>进行动态挂载Agent的一般实现：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>    private void</span><span style=color:#88c0d0> attachAgentToTargetJVM</span><span style=color:#eceff4>()</span><span> throws Exception </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        List</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>VirtualMachineDescriptor</span><span style=color:#eceff4>></span><span> virtualMachineDescriptors</span><span style=color:#81a1c1> =</span><span> VirtualMachine</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>list</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        VirtualMachineDescriptor</span><span> targetVM</span><span style=color:#81a1c1> = null;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>VirtualMachineDescriptor</span><span> descriptor</span><span style=color:#81a1c1> :</span><span> virtualMachineDescriptors</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#eceff4> (</span><span>descriptor</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>equals</span><span style=color:#eceff4>(</span><span>configure</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getPid</span><span style=color:#eceff4>())) {</span></span>
<span class=giallo-l><span>                targetVM </span><span style=color:#81a1c1>=</span><span> descriptor</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span>targetVM </span><span style=color:#81a1c1>== null</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            throw new</span><span style=color:#88c0d0> IllegalArgumentException</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>could not find the target jvm by process id:</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> +</span><span> configure</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getPid</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        VirtualMachine</span><span> virtualMachine</span><span style=color:#81a1c1> = null;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        try</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            virtualMachine </span><span style=color:#81a1c1>=</span><span> VirtualMachine</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>attach</span><span style=color:#eceff4>(</span><span>targetVM</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>            virtualMachine</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>loadAgent</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>{agent}</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>{params}</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> catch</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>Exception</span><span> e</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#eceff4> (</span><span>virtualMachine </span><span style=color:#81a1c1>!= null</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>                virtualMachine</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>detach</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p>首先通过指定的进程ID找到目标JVM，然后通过Attach挂载到目标JVM上，执行加载Agent操作。VirtualMachine的Attach方法就是用来将Agent挂载到目标JVM上去的，而Detach则是将Agent从目标JVM卸载。<p><strong><a href=https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/Instrumentation.html rel=external>Instrumentation (Java Platform SE 8 )</a></strong> 类提供检测 Java 编程语言代码所需的服务。Instrumentation 是在方法中添加字节码，以收集工具使用的数据。由于更改纯粹是附加的，因此这些工具不会修改应用程序状态或行为。这种良性工具的示例包括监控代理、分析器、覆盖分析器和事件记录器。<ul><li><code>addTransformer</code>: 添加一个类转换器<li><code>removeTransformer</code>: 删除一个类转换器<li><code>isRetransformClassesSupported</code>: 判断是否支持类的重新转换<li><code>retransformClasses</code>: 在类加载后，重新定义该类<li><code>isRedefineClassesSupported</code>: 判断是否支持重新定义类<li><code>redefineClasses</code>: 重新进行类的定义<li><code>isModifiableClass</code>: 确定一个类是否可以通过重新转换或重新定义来修改<li><code>getAllLoadedClasses</code>: 返回 JVM 当前加载的所有类的数组<li><code>getInitiatedClasses</code>: 返回 loader 为其初始加载器的所有类的数组。如果提供的加载器为空，则返回由引导类加载器启动的类<li>……</ul><h3 id=premain-jing-tai-fang-shi>premain 静态方式</h3><blockquote><p>大多数中间件/工具的使用方式<p>使用方法：java -javaagent:xxx.jar MyApp</blockquote><p>代码地址：<a href=https://gitee.com/dllen/dllen-demos/tree/master/application-premain rel=external>application-premain</a><p>编译和测试：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88># 编译打包</span></span>
<span class=giallo-l><span style=color:#88c0d0>mvn</span><span style=color:#a3be8c> clean package</span></span>
<span class=giallo-l><span style=color:#616e88># 执行</span></span>
<span class=giallo-l><span style=color:#88c0d0>java</span><span style=color:#a3be8c> -javaagent:target/application-premain-jar-with-dependencies.jar  -cp target/application-premain-jar-with-dependencies.jar com.ks.test.app.MyApp</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># 执行结果（方法执行前后添加代码）</span></span>
<span class=giallo-l><span style=color:#a3be8c>=====start=====</span></span>
<span class=giallo-l><span style=color:#88c0d0>Hello</span><span style=color:#a3be8c> World!</span></span>
<span class=giallo-l><span style=color:#a3be8c>=====end=====</span></span>
<span class=giallo-l><span style=color:#a3be8c>=====start=====</span></span>
<span class=giallo-l><span style=color:#88c0d0>Hello</span><span style=color:#a3be8c> World!</span></span>
<span class=giallo-l><span style=color:#a3be8c>=====end=====</span></span></code></pre><h4 id=he-xin-dai-ma>核心代码</h4><p><code>MyTransformer.java</code> 类是具体实现字节码植入的实现类<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>instrument</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassFileTransformer</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>instrument</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>IllegalClassFormatException</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>security</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ProtectionDomain</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>util</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Objects</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassPool</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CtClass</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CtMethod</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> MyTransformer</span><span style=color:#81a1c1> implements</span><span style=color:#8fbcbb;font-weight:700> ClassFileTransformer</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public byte</span><span style=color:#eceff4>[]</span><span style=color:#88c0d0> transform</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ClassLoader</span><span> loader</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> String</span><span> className</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Class</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>?</span><span style=color:#eceff4>></span><span> classBeingRedefined</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ProtectionDomain</span><span> protectionDomain</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> byte</span><span style=color:#eceff4>[]</span><span> classfileBuffer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> throws</span><span style=color:#8fbcbb> IllegalClassFormatException</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        //跳过java自带方法</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span>className</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>startsWith</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>java</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> ||</span><span> className</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>startsWith</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>sun</span><span style=color:#eceff4>")) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span> classfileBuffer</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        //好像使用premain这个className是没问题的，但使用attach时className的.变成了/，所以如果是attach，那么这里需要替换</span></span>
<span class=giallo-l><span>        className </span><span style=color:#81a1c1>=</span><span> className</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>replace</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>.</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        //只处理MyApp类</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span>className</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>endsWith</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>MyApp</span><span style=color:#eceff4>")) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span> classfileBuffer</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#616e88>        //使用javassist类库对字节码修改</span></span>
<span class=giallo-l><span style=color:#81a1c1>        try</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            ClassPool</span><span> classPool</span><span style=color:#81a1c1> =</span><span> ClassPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDefault</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            CtClass</span><span> ctClass</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span>className</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            CtMethod</span><span style=color:#eceff4>[]</span><span> declaredMethods</span><span style=color:#81a1c1> =</span><span> ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDeclaredMethods</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            for</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>CtMethod</span><span> declaredMethod</span><span style=color:#81a1c1> :</span><span> declaredMethods</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>                //只处理printSth方法</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span style=color:#eceff4> (</span><span>Objects</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>equals</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>printHello</span><span style=color:#eceff4>",</span><span> declaredMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>())) {</span></span>
<span class=giallo-l><span style=color:#616e88>                    //在方法执行前插入打印语句</span></span>
<span class=giallo-l><span>                    declaredMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>insertBefore</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>System.out.println(</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>=====start=====</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>);</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>                    //在方法执行后插入打印语句</span></span>
<span class=giallo-l><span>                    declaredMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>insertAfter</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>System.out.println(</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>=====end=====</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>);</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                    break;</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span> ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>toBytecode</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> catch</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>Exception</span><span> e</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>            e</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>printStackTrace</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span> classfileBuffer</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>PremainMain.java</code> Java Agent内部约定的 <code>premain</code> 实现：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>instrument</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Instrumentation</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> PremainMain</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /*</span></span>
<span class=giallo-l><span style=color:#616e88>     * 注意，这个premain方法签名是Java Agent约定的，不要随意修改</span></span>
<span class=giallo-l><span style=color:#616e88>     * @param agentArgs</span></span>
<span class=giallo-l><span style=color:#616e88>     * @param instrumentation</span></span>
<span class=giallo-l><span style=color:#616e88>     */</span></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> premain</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span> agentArgs</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Instrumentation</span><span> instrumentation</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>        instrumentation</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>addTransformer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>new</span><span style=color:#88c0d0> MyTransformer</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    //PremainMain#premain的方法签名是Java Agent内部约定的，不能随意修改。</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>resouces/META-INF/MANIFEST.MF</code>通过 <code>MANIFEST.MF</code> 文件找到 <code>premain</code> 的实现类<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span>Manifest</span><span style=color:#81a1c1>-</span><span>Version</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 1.0</span></span>
<span class=giallo-l><span>Created</span><span style=color:#81a1c1>-</span><span>By</span><span style=color:#81a1c1>:</span><span> dllen</span></span>
<span class=giallo-l><span>Premain</span><span style=color:#81a1c1>-</span><span>Class</span><span style=color:#81a1c1>:</span><span> com</span><span style=color:#eceff4>.</span><span>ks</span><span style=color:#eceff4>.</span><span>test</span><span style=color:#eceff4>.</span><span>app</span><span style=color:#eceff4>.</span><span>PremainMain</span></span></code></pre><blockquote><p>注意：最后一行需要留一个空行</blockquote><p><code>MyApp.java</code> 测试应用<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>util</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>concurrent</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>TimeUnit</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> MyApp</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>[]</span><span> args</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        while</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            printHello</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    private static void</span><span style=color:#88c0d0> printHello</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>        System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Hello World!</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        try</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            TimeUnit</span><span style=color:#eceff4>.</span><span>SECONDS</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span style=color:#b48ead>5</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> catch</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>InterruptedException</span><span> e</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>            e</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>printStackTrace</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h3 id=attach-dong-tai-fang-shi>attach 动态方式</h3><blockquote><p>混沌工程-故障注入，应用调试和诊断的实现方式</blockquote><p>代码地址：<a href=https://gitee.com/dllen/dllen-demos/tree/master/application-attach rel=external>application-attach</a><p>编译和测试：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88># 编译打包</span></span>
<span class=giallo-l><span style=color:#88c0d0>mvn</span><span style=color:#a3be8c> clean package</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># 终端 1</span></span>
<span class=giallo-l><span style=color:#88c0d0>java</span><span style=color:#a3be8c> -cp target/application-premain-jar-with-dependencies.jar com.ks.test.app.MyApp</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># 终端 2</span></span>
<span class=giallo-l><span style=color:#616e88># 使用 ps 找到 进程id</span></span>
<span class=giallo-l><span style=color:#88c0d0>java</span><span style=color:#a3be8c> -cp ./target/application-premain-jar-with-dependencies.jar com.ks.test.app.AttachMain</span><span style=color:#81a1c1> ${</span><span>pid</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c> ./target/application-premain-jar-with-dependencies.jar</span></span>
<span class=giallo-l><span style=color:#616e88># attach success!</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># 终端 1 结果</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>Hello</span><span style=color:#a3be8c> World!</span></span>
<span class=giallo-l><span style=color:#88c0d0>Hello</span><span style=color:#a3be8c> World!</span></span>
<span class=giallo-l><span style=color:#88c0d0>Hello</span><span style=color:#a3be8c> World!</span></span>
<span class=giallo-l><span style=color:#88c0d0>Hello</span><span style=color:#a3be8c> World!</span></span>
<span class=giallo-l><span style=color:#88c0d0>Hello</span><span style=color:#a3be8c> World!</span></span>
<span class=giallo-l><span style=color:#88c0d0>come</span><span style=color:#a3be8c> in agentmain</span></span>
<span class=giallo-l><span style=color:#88c0d0>clazz</span><span style=color:#a3be8c> = com.ks.test.app.AttachAgent</span></span>
<span class=giallo-l><span style=color:#88c0d0>clazz</span><span style=color:#a3be8c> = com.ks.test.app.MyApp</span></span>
<span class=giallo-l><span style=color:#a3be8c>=====start=====</span></span>
<span class=giallo-l><span style=color:#88c0d0>Hello</span><span style=color:#a3be8c> World!</span></span>
<span class=giallo-l><span style=color:#a3be8c>=====end=====</span></span>
<span class=giallo-l><span style=color:#a3be8c>=====start=====</span></span>
<span class=giallo-l><span style=color:#88c0d0>Hello</span><span style=color:#a3be8c> World!</span></span>
<span class=giallo-l><span style=color:#a3be8c>=====end=====</span></span></code></pre><h4 id=he-xin-dai-ma-1>核心代码</h4><p><code>MyAttachTransformer.java</code> 代码植入类<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>instrument</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassFileTransformer</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>instrument</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>IllegalClassFormatException</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>security</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ProtectionDomain</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>util</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Objects</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassPool</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CtClass</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CtMethod</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> MyAttachTransformer</span><span style=color:#81a1c1> implements</span><span style=color:#8fbcbb;font-weight:700> ClassFileTransformer</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public byte</span><span style=color:#eceff4>[]</span><span style=color:#88c0d0> transform</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ClassLoader</span><span> loader</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> String</span><span> className</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Class</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>?</span><span style=color:#eceff4>></span><span> classBeingRedefined</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ProtectionDomain</span><span> protectionDomain</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> byte</span><span style=color:#eceff4>[]</span><span> classfileBuffer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> throws</span><span style=color:#8fbcbb> IllegalClassFormatException</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        //跳过java自带方法</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span>className</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>startsWith</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>java</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> ||</span><span> className</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>startsWith</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>sun</span><span style=color:#eceff4>")) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span> classfileBuffer</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        //好像使用premain这个className是没问题的，但使用attach时className的.变成了/，所以如果是attach，那么这里需要替换</span></span>
<span class=giallo-l><span>        className </span><span style=color:#81a1c1>=</span><span> className</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>replace</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>.</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        //只处理MyApp类</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span>className</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>endsWith</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>MyApp</span><span style=color:#eceff4>")) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span> classfileBuffer</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        try</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            ClassPool</span><span> classPool</span><span style=color:#81a1c1> =</span><span> ClassPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDefault</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            CtClass</span><span> ctClass</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span>className</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            CtMethod</span><span style=color:#eceff4>[]</span><span> declaredMethods</span><span style=color:#81a1c1> =</span><span> ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDeclaredMethods</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            for</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>CtMethod</span><span> declaredMethod</span><span style=color:#81a1c1> :</span><span> declaredMethods</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>                //只处理printSth方法</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span style=color:#eceff4> (</span><span>Objects</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>equals</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>printHello</span><span style=color:#eceff4>",</span><span> declaredMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>())) {</span></span>
<span class=giallo-l><span style=color:#616e88>                    //在方法执行前插入打印语句</span></span>
<span class=giallo-l><span>                    declaredMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>insertBefore</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>System.out.println(</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>=====start=====</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>);</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>                    //在方法执行后插入打印语句</span></span>
<span class=giallo-l><span>                    declaredMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>insertAfter</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>System.out.println(</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>=====end=====</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>);</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                    break;</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span> ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>toBytecode</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> catch</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>Exception</span><span> e</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>            e</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>printStackTrace</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span> classfileBuffer</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>AttachAgent.java</code>实现 <code>agentmain</code> 方法<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>instrument</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Instrumentation</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>instrument</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>UnmodifiableClassException</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> AttachAgent</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /*</span></span>
<span class=giallo-l><span style=color:#616e88>     * 注意：agentmain的方法签名也是约定好的，不能随意修改</span></span>
<span class=giallo-l><span style=color:#616e88>     *</span></span>
<span class=giallo-l><span style=color:#616e88>     * 其实如果要支持premain和attach两种方式的话，可以把premain和agentmain两个方法写在一个类里，这里为了方便演示，写成了两个</span></span>
<span class=giallo-l><span style=color:#616e88>     *</span></span>
<span class=giallo-l><span style=color:#616e88>     * @param agentArgs</span></span>
<span class=giallo-l><span style=color:#616e88>     * @param instrumentation</span></span>
<span class=giallo-l><span style=color:#616e88>     */</span></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> agentmain</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span> agentArgs</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Instrumentation</span><span> instrumentation</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        String</span><span> targetClassPath</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>com.ks.test.app.MyApp</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>come in agentmain</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>Class</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>?</span><span style=color:#eceff4>></span><span> clazz</span><span style=color:#81a1c1> :</span><span> instrumentation</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getAllLoadedClasses</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // 过滤掉不能修改的类</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span>instrumentation</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>isModifiableClass</span><span style=color:#eceff4>(</span><span>clazz</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                continue;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>clazz = </span><span style=color:#eceff4>"</span><span style=color:#81a1c1> +</span><span> clazz</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // 只修改我们关心的类</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#eceff4> (</span><span>clazz</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>equals</span><span style=color:#eceff4>(</span><span>targetClassPath</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#616e88>                // 最根本的目的还是把MyTransformer添加到instrumentation中</span></span>
<span class=giallo-l><span>                instrumentation</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>addTransformer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>new</span><span style=color:#88c0d0> MyAttachTransformer</span><span style=color:#eceff4>(),</span><span style=color:#81a1c1> true</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                try</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    instrumentation</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>retransformClasses</span><span style=color:#eceff4>(</span><span>clazz</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span><span style=color:#81a1c1> catch</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>UnmodifiableClassException</span><span> e</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>                    e</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>printStackTrace</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                return;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>resouces/META-INF/MANIFEST.MF</code>通过 <code>MANIFEST.MF</code> 文件找到 <code>agentmain</code> 的实现类<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>Manifest-Version: 1.0</span></span>
<span class=giallo-l><span>Created-By: dllen</span></span>
<span class=giallo-l><span>Agent-Class: com.ks.test.app.AttachAgent</span></span>
<span class=giallo-l><span>Can-Redefine-Classes: true</span></span>
<span class=giallo-l><span>Can-Retransform-Classes: true</span></span></code></pre><p><code>AttachMain.java</code> 在运行时挂载Agent到目标JVM<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> com</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>sun</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>tools</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>attach</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>VirtualMachine</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>io</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>File</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>reflect</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>InvocationTargetException</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>reflect</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Method</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>net</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>MalformedURLException</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>net</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>URL</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>net</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>URLClassLoader</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> AttachMain</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /*</span></span>
<span class=giallo-l><span style=color:#616e88>     * 加载 tools.jar</span></span>
<span class=giallo-l><span style=color:#616e88>     *</span></span>
<span class=giallo-l><span style=color:#616e88>     * @throws NoSuchMethodException</span></span>
<span class=giallo-l><span style=color:#616e88>     * @throws MalformedURLException</span></span>
<span class=giallo-l><span style=color:#616e88>     * @throws InvocationTargetException</span></span>
<span class=giallo-l><span style=color:#616e88>     * @throws IllegalAccessException</span></span>
<span class=giallo-l><span style=color:#616e88>     */</span></span>
<span class=giallo-l><span style=color:#81a1c1>    private static void</span><span style=color:#88c0d0> prepareAttach</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> throws</span><span style=color:#8fbcbb> NoSuchMethodException</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MalformedURLException</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> InvocationTargetException</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> IllegalAccessException</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        String</span><span> binPath</span><span style=color:#81a1c1> =</span><span> System</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getProperty</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>sun.boot.library.path</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        // remove jre/bin, replace with lib</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        String</span><span> libPath</span><span style=color:#81a1c1> =</span><span> binPath</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>substring</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>,</span><span> binPath</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>length</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -</span><span style=color:#b48ead> 7</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>lib</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        URLClassLoader</span><span> loader</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> (</span><span>URLClassLoader</span><span style=color:#eceff4>)</span><span> AttachMain</span><span style=color:#eceff4>.</span><span>class</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getClassLoader</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Method</span><span> addURLMethod</span><span style=color:#81a1c1> =</span><span> URLClassLoader</span><span style=color:#eceff4>.</span><span>class</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDeclaredMethod</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>addURL</span><span style=color:#eceff4>",</span><span> URL</span><span style=color:#eceff4>.</span><span>class</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        addURLMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>setAccessible</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        File</span><span> toolsJar</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> File</span><span style=color:#eceff4>(</span><span>libPath </span><span style=color:#81a1c1>+</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/tools.jar</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span>toolsJar</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>exists</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            throw new</span><span style=color:#88c0d0> RuntimeException</span><span style=color:#eceff4>(</span><span>toolsJar</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getAbsolutePath</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> "</span><span style=color:#a3be8c> does not exist</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        addURLMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>invoke</span><span style=color:#eceff4>(</span><span>loader</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> new</span><span style=color:#88c0d0> File</span><span style=color:#eceff4>(</span><span>libPath </span><span style=color:#81a1c1>+</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/tools.jar</span><span style=color:#eceff4>").</span><span style=color:#88c0d0>toURI</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>toURL</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>[]</span><span> args</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        String</span><span> pid</span><span style=color:#81a1c1> =</span><span> args</span><span style=color:#eceff4>[</span><span style=color:#b48ead>0</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        String</span><span> agentPath</span><span style=color:#81a1c1> =</span><span> args</span><span style=color:#eceff4>[</span><span style=color:#b48ead>1</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        File</span><span> agentFile</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> File</span><span style=color:#eceff4>(</span><span>agentPath</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span>agentFile</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>exists</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span>            System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Agent not exist!</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        try</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>            prepareAttach</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>            VirtualMachine</span><span> virtualMachine</span><span style=color:#81a1c1> =</span><span> VirtualMachine</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>attach</span><span style=color:#eceff4>(</span><span>pid</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>            virtualMachine</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>loadAgent</span><span style=color:#eceff4>(</span><span>agentFile</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getAbsolutePath</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            virtualMachine</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>detach</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>attach success!</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> catch</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>Exception</span><span> e</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>            e</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>printStackTrace</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // attach ok</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><blockquote><p>需要传递2个参数<p>    目标Java进程ID<p>    Agent的路径</blockquote><h3 id=can-kao-zi-liao>参考资料</h3><ul><li><p><a href=http://www.taoxuefeng.com/JAVA/jdk/agent.html rel=external>java agent · GitBook</a></p><li><p><a href=https://zhengw-tech.com/2023/05/27/java-agent/ rel=external>JavaAgent使用及原理 | 个人网页</a></p><li><p><a href=https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html rel=external>Java 动态调试技术原理及实践 - 美团技术团队</a></p><li><p><a href=https://www.cnblogs.com/rickiyang/p/11368932.html rel=external>javaagent使用指南 - rickiyang - 博客园</a></p><li><p><a href=https://www.kancloud.cn/alex_wsc/javajvm/1844993 rel=external>第21讲：深入剖析：如何使用 Java Agent 技术对字节码进行修改 · 深入浅出Java虚拟机 · 看云</a></p><li><p><a href=https://cloud.tencent.com/developer/article/2161810 rel=external>谈谈Java Agent技术的实现-腾讯云开发者社区-腾讯云</a></p><li><p>https://segmentfault.com/a/1190000039731381</p><li><p><a href=https://veryjj.github.io/2021/01/01/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0Java%E5%AD%97%E8%8A%82%E7%A0%81Demo/ rel=external>手把手教你Java字节码Demo</a></p><li><p><a href=https://www.hollischuang.com/archives/592 rel=external>深入探索 Java 热部署</a></p></ul><h3 id=zi-jie-ma-cao-zuo-ku>字节码操作库</h3><ul><li><p>https://asm.ow2.io/</p><li><p><a href=https://github.com/cglib/cglib rel=external>GitHub - cglib/cglib</a></p><li><p>https://www.javassist.org/</p><li><p><a href=https://bytebuddy.net/#/ rel=external>Byte Buddy - runtime code generation for the Java virtual machine</a></p></ul><h3 id=kai-yuan-xiang-mu>开源项目</h3><ul><li><p><a href=https://github.com/alibaba/jvm-sandbox rel=external>GitHub - alibaba/jvm-sandbox: Real - time non-invasive AOP framework container based on JVM</a></p><li><p><a href=https://github.com/btraceio/btrace rel=external>GitHub - btraceio/btrace: BTrace - a safe, dynamic tracing tool for the Java platform</a></p><li><p><a href=https://github.com/alibaba/arthas rel=external>GitHub - alibaba/arthas: Alibaba Java Diagnostic Tool Arthas/Alibaba Java诊断利器Arthas</a></p><li><p><a href=https://github.com/pinpoint-apm/pinpoint rel=external>GitHub - pinpoint-apm/pinpoint: APM, (Application Performance Management) tool for large-scale distributed systems.</a></p><li><p><a href=https://github.com/apache/skywalking rel=external>GitHub - apache/skywalking: APM, Application Performance Monitoring System</a></p><li><p><a href=https://github.com/pandening/Java-debug-tool rel=external>GitHub - pandening/Java-debug-tool: Java dynamic debug tool</a></p></ul></div></div></section>