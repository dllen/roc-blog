<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>高性能开发参考手册 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2025-12-13</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">高性能开发参考手册</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><h2 id=he-xin-yuan-ze>核心原则</h2><ul><li>明确目标：以端到端延迟、99/99.9 分位、吞吐、稳定性为一等指标，避免只优化平均值。<li>数据驱动：先度量后优化，建立可复现的基准与环境隔离，避免“改参数碰运气”。<li>贴近瓶颈：围绕 CPU、内存、锁、I/O、网络、存储逐层定位，逐个消除；不要平均用力。<li>简化路径：减少层次、减少拷贝、减少分配、减少上下文切换、减少序列化复杂度。<li>面向故障设计：考虑抖动、拥塞、反压、尾延迟的治理与保护带（降级、限流、超时）。</ul><h2 id=jia-gou-yu-mo-shi>架构与模式</h2><ul><li>零拷贝与最少拷贝：<code>sendfile</code>、<code>splice</code>、<code>mmap</code>；缓冲复用与批处理（batching）。<li>内存池与对象复用：绕过频繁 <code>malloc/free</code>，用 slab/pool、arena（<code>jemalloc</code>/<code>tcmalloc</code>）。<li>无锁与低锁：无锁环形队列、读写锁分离、分段锁、尽量使用原子与 CAS。<li>异步与事件驱动：<code>io_uring</code>、<code>epoll</code>、<code>kqueue</code>、AIO；避免阻塞调用和线程爆炸。<li>数据面/控制面分离：热路径最短化，慢路径（日志、遥测、管理）异步或旁路。<li>背压与负载整形：生产者-消费者配额、漏桶/令牌桶、优雅丢弃（tail-drop）与降级策略。</ul><h2 id=yu-yan-yu-yun-xing-shi>语言与运行时</h2><ul><li>C/C++： <ul><li>使用 <code>-O2/-O3</code>、<code>-march=native</code>、<code>-flto</code>；热点用 <code>restrict</code>/<code>constexpr</code>/<code>inline</code>。<li>明确对象生命周期，避免小对象频繁分配；内联小函数，消除虚调用开销。</ul><li>Rust： <ul><li><code>no_std</code> 场景下最短路径；<code>tokio</code>/<code>monoio</code> 选择基于工作负载；善用 <code>#[inline]</code> 与 <code>Pin</code>。<li>使用 <code>tracing</code> 收敛热路径指标；<code>bytes</code>/<code>smallvec</code> 降低分配。</ul><li>Go： <ul><li>减少逃逸与分配；控制 <code>GOMAXPROCS</code>；用 <code>pprof</code>/<code>trace</code> 定位 GC 与调度热点。<li>大量并发时首选通道背压或工作池；避免每请求起新 goroutine。</ul><li>Java/JVM： <ul><li>选择适合延迟目标的 GC（G1/ZGC/Shenandoah）；合理 <code>Xms=Xmx</code>、<code>MaxGCPauseMillis</code>。<li>直堆外内存 <code>DirectByteBuffer</code>/<code>Netty</code> <code>PooledByteBufAllocator</code>；避免对象风暴。</ul></ul><h2 id=nei-cun-yu-dui-xiang-guan-li>内存与对象管理</h2><ul><li>分配器：<code>jemalloc</code>/<code>tcmalloc</code> 替换系统 <code>malloc</code>，降低碎片与锁争用。<li>NUMA 与局部性：<code>numactl --cpunodebind --membind</code>；尽量让线程与数据同节点。<li>缓存友好：紧凑结构体、消除 false-sharing（使用 <code>cacheline</code> 对齐）；预取 <code>__builtin_prefetch</code>。<li>批处理：批量分配/释放、批量序列化；减少系统调用次数与锁进入次数。</ul><h2 id=bing-fa-yu-suo>并发与锁</h2><ul><li>尽量用无锁结构：环形缓冲、MPSC/MCSP 队列；热点读路径用 RCU/版本号。<li>降低锁粒度：分段锁、局部计数、跨线程通信用消息传递代替共享状态。<li>自旋与阻塞平衡：短临界区自旋，长临界区阻塞；避免在热路径打印日志或做 I/O。</ul><h2 id=i-o-yu-wang-luo>I/O 与网络</h2><ul><li>网络栈： <ul><li>优先 <code>epoll</code>/<code>kqueue</code>/<code>io_uring</code>；减少阻塞套接字；禁用 Nagle（<code>TCP_NODELAY</code>）。<li>调优 <code>SO_RCVBUF/SO_SNDBUF</code>、<code>TCP_QUICKACK</code>；根据场景考虑 <code>busy-poll</code>。</ul><li>协议设计： <ul><li>序列化选择以延迟为先：<code>flatbuffers</code>/<code>capnproto</code>/自定义紧凑二进制；避免深层嵌套 JSON。<li>明确超时、重试与幂等；避免惊群（accept 多线程）与 head-of-line 阻塞。</ul><li>工具与压测：<code>wrk</code>/<code>fortio</code>/<code>iperf3</code>/<code>tc</code>；使用 <code>flamegraph</code> 识别热函数。</ul><h2 id=cun-chu-yu-chi-jiu-hua>存储与持久化</h2><ul><li>日志落盘：异步、批量、顺序写；日志与数据面分离磁盘或队列。<li>数据库：选择适合延迟目标的引擎（LSM vs B-Tree），按工作负载调优写放大与缓存命中。<li>缓存层：本地 LRU/LFU、跨节点一致性哈希；避免穿透与雪崩（限流、预热、降级）。</ul><h2 id=cao-zuo-xi-tong-yu-nei-he>操作系统与内核</h2><ul><li>进程/线程：合理 <code>taskset</code> 绑核，降低迁移；为关键线程提升调度类与优先级。<li>文件与磁盘：<code>O_DIRECT</code>/<code>O_NONBLOCK</code> 场景化选择；I/O 调度器选择 <code>none</code>/<code>mq-deadline</code>。<li>网络设备：<code>ethtool</code> 关闭不必要的 offload，按负载调节 <code>RPS/RFS/XPS</code> 与队列并行度。<li>系统参数：<code>sysctl</code> 中 <code>net.core.*</code>、<code>net.ipv4.*</code> 根据并发与突发特性进行整形。</ul><h2 id=ke-guan-ce-xing-yu-fen-xi>可观测性与分析</h2><ul><li>采样与火焰图：<code>perf</code>/<code>bcc</code>/<code>async-profiler</code>/<code>pprof</code>；以采样证据驱动优化。<li>端到端追踪：<code>OpenTelemetry</code>/<code>Jaeger</code>；记录关键自定义 span 和业务标签。<li>指标分位：暴露 <code>p50/p95/p99/p99.9</code> 与队列深度、等待时间、批量大小、重试次数。<li>压测分层：协议层、业务层、系统层分别压测；构建稳定、可复现的基准环境。</ul><h2 id=you-hua-liu-cheng-jian-yi>优化流程（建议）</h2><ol><li>建立基准：选定代表性负载与数据规模，固定环境变量与参数快照。<li>定位瓶颈：用火焰图/追踪对齐指标（CPU、GC、锁、I/O）；画出关键路径图。<li>设计改动：优先零拷贝、批处理、对象复用、减少锁与系统调用；明确风险与回滚。<li>渐进验证：小步提交，灰度发布；以分位数回归标准判断有效性。<li>持续监控：上线后观察尾延迟与抖动，必要时加保护带（限流/降级/重试退避）。</ol><h2 id=chang-jian-xian-jing>常见陷阱</h2><ul><li>只看平均值不看分位尾巴，导致生产抖动被忽视。<li>大量细粒度 goroutine/线程造成调度震荡与上下文切换风暴。<li>对象风暴与无界队列，GC 或 OOM 尾延迟飙升。<li>过度序列化/反序列化与拷贝；日志同步写阻塞热路径。<li>盲目调大缓冲与并发，反而引起排队与头阻塞。</ul><h2 id=su-cha-qing-dan>速查清单</h2><ul><li>CPU：绑定热点线程、减少分支与虚调用、提升缓存命中。<li>内存：池化与批量、NUMA 亲和、消除 false-sharing。<li>锁：热点读路径无锁或读写锁、缩短临界区、用消息传递代替共享。<li>I/O：异步化、批处理、零拷贝、合理超时与背压。<li>网络：<code>TCP_NODELAY</code>、合理缓冲、避免惊群、压测与火焰图定位。<li>存储：顺序写、异步刷盘、缓存命中、写放大控制。<li>观测：<code>p99/p99.9</code> 指标、端到端追踪；压测稳定可复现。</ul><h2 id=can-kao-zi-liao>参考资料</h2><ul><li>Patterns 与资源集合：https://github.com/penberg/awesome-low-latency<li>Linux 性能工具：<code>perf</code>、<code>bcc</code>、<code>sysstat</code>、<code>flamegraph</code>、<code>async-profiler</code><li>压测工具：<code>wrk</code>、<code>fortio</code>、<code>hey</code>、<code>iperf3</code><li>序列化：<code>flatbuffers</code>、<code>capnproto</code>、<code>protobuf</code>（谨慎考虑层级与可选字段）</ul><p>（本文根据业界低延迟与高性能实践汇总，结合工程经验提炼为可操作的手册式清单，可作为团队性能优化与系统设计的参考。）</div></div></section>