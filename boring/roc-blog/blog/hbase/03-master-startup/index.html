<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>HBase 源码阅读：03. Master 启动流程 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/hbase/> /hbase </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2026-01-12</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">HBase 源码阅读：03. Master 启动流程</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p>HMaster 是 HBase 集群的主脑，负责元数据管理、Region 分配、负载均衡等。<h2 id=1-ru-kou-lei-hmaster>1. 入口类：<code>HMaster</code></h2><p><code>HMaster</code> 继承自 <code>HRegionServer</code>（没错，Master 也是一个特殊的 RS），并实现了 <code>MasterServices</code> 接口。 启动入口在 <code>HMaster.main()</code>，但通常由 <code>HMasterCommandLine</code> 解析参数后拉起。<h2 id=2-qi-dong-he-xin-liu-cheng-finishactivemasterinitialization>2. 启动核心流程 (<code>finishActiveMasterInitialization</code>)</h2><p>HMaster 启动后会竞争 ZK 锁，成为 Active Master 后，会执行初始化逻辑。核心方法是 <code>finishActiveMasterInitialization</code>。<h3 id=2-1-bu-zou-gai-lan>2.1 步骤概览</h3><ol><li><strong>初始化文件系统</strong>: 检查 <code>hbase.rootdir</code>，清理临时文件。<li><strong>启动 ProcedureExecutor</strong>: 加载之前的 Procedure 状态（WAL），恢复未完成的任务（如建表）。<li><strong>初始化 AssignmentManager</strong>: 这是 V2 版本的核心，负责 Region 的分配。 <ul><li>加载 <code>hbase:meta</code> 表数据。<li>构建 Region 状态机。</ul><li><strong>启动 Balancer</strong>: 负载均衡器。<li><strong>启动 CatalogJanitor</strong>: 定期清理元数据的垃圾回收线程。<li><strong>标记集群启动</strong>: 设置 Cluster ID，标记 Master 为 initialized。</ol><h2 id=3-guan-jian-zu-jian>3. 关键组件</h2><h3 id=3-1-assignmentmanager-am>3.1 <code>AssignmentManager</code> (AM)</h3><p>负责维护所有 Region 的位置信息和状态。HBase 2.x 引入了 Procedure V2，AM 严重依赖 Procedure 来进行 Region 的 Assign/Unassign，解决了旧版状态不一致的问题。<h3 id=3-2-servermanager>3.2 <code>ServerManager</code></h3><p>管理所有在线的 RegionServer。处理 RS 的 Heartbeat，检测 RS 宕机（ServerCrashProcedure）。<h3 id=3-3-masterwalmanager>3.3 <code>MasterWalManager</code></h3><p>Master 也有自己的 WAL，主要用于 Procedure 的持久化。<h2 id=4-yuan-ma-zhui-zong>4. 源码追踪</h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span>HMaster</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  -></span><span style=color:#88c0d0> becomeActiveMaster</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    -></span><span style=color:#88c0d0> finishActiveMasterInitialization</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      -></span><span> fileSystemManager</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>splitWALs</span><span style=color:#eceff4>()</span><span style=color:#616e88> // 处理旧日志</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      -></span><span> procedureExecutor</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>start</span><span style=color:#eceff4>()</span><span style=color:#616e88>     // 启动状态机</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      -></span><span> assignmentManager</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>joinCluster</span><span style=color:#eceff4>()</span><span style=color:#616e88> // 核心：加入集群管理</span></span></code></pre><hr><p><strong>Next</strong>: <a href=../04-regionserver-startup/>HBase 源码阅读：04. RegionServer 启动流程</a></div></div></section>