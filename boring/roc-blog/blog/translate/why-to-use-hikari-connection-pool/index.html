<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Why to use Hikari Connection Pool ? | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/translate/> /translate </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2019-12-18</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Why to use Hikari Connection Pool ?</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p><a href=https://www.linqz.io/2019/03/why-to-use-hikari-connection-pool.html rel=external>原文连接</a><p><a href=https://github.com/brettwooldridge/HikariCP rel=external>Hikari</a> Connection Pooling (or Hikari CP) is the new kid on the block, though a late entrant in pooling mechanisms, it is outperforming the ones offered by <a href=https://github.com/swaldman/c3p0 rel=external>C3P0</a>, <a href=https://commons.apache.org/proper/commons-dbcp/ rel=external>Apache Commons DBCP</a>, <a href=http://www.jolbox.com/ rel=external>BoneCP</a>, <a href=https://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html rel=external>Tomcat</a>, <a href=http://www.vibur.org/ rel=external>Vibur</a> etc.<p>Below benchmark graph displays connection and statement ops/ms graphs:<p>source : <a href=https://github.com/brettwooldridge/HikariCP rel=external>GitHub - brettwooldridge/HikariCP</a><p><img alt src=https://scp-net-cn.oss-cn-beijing.aliyuncs.com/blog-images/performance_benchmark_hikaricp.png><p>Multiple Blogs are already written about comparison and performance of <a href=https://github.com/brettwooldridge/HikariCP rel=external>HikariCP</a>, so this blog tries to explore some of the internal intricacies for e.g Why it is faster in comparison with its peer connection pooling libraries ? Any special code ? etc .<p>Links to other resources which has improved my understanding of HikariCP are shared at the end.<ul><li>Byte code simplification: HikariCP Library has optimized the code until the compiled byte-code is at a minimum, so that the CPU cache can load more program code, this is achieved by Javassist. (JavaAssist is used to generate dynamic proxies over JDK Proxies.Since fewer bytes are generated than the JDK Proxy, negating a lot of unnecessary byte-code, thus making it faster in execution)<li>Optimizations of Proxy and Interceptor: Hikari library has reduce a lot of code, e.g HikariCP’s Statement proxy has only 100 lines of code.<li><a href=https://github.com/openbouquet/HikariCP/blob/master/src/main/java/com/zaxxer/hikari/util/FastList.java rel=external>FastList</a> instead of ArrayList is implemented to avoid the range check every time, since the get() call is executed also during remove() call, it avoids the complete array scan from start to end. The ArrayList’s remove(Object) method traverses the array from scratch, and the FastList is traversed from the end of the array, so it’s more efficient when the removed element is at the end which is usually the case. Excerpt below from <a href=https://github.com/openbouquet/HikariCP/blob/master/src/main/java/com/zaxxer/hikari/util/FastList.java rel=external>FastList.java</a></ul><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#eceff4>@</span><span style=color:#d08770>Override</span><span>   </span></span>
<span class=giallo-l><span style=color:#81a1c1>public</span><span style=color:#8fbcbb> T</span><span style=color:#88c0d0> get</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span> index</span><span style=color:#eceff4>)</span><span>   </span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1> return</span><span> elementData</span><span style=color:#eceff4>[</span><span>index</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>;</span><span style=color:#616e88>     // no range check of ArrayList</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ul><li>Remove Method Implementation:</ul><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#eceff4>@</span><span style=color:#d08770>Override</span></span>
<span class=giallo-l><span style=color:#81a1c1>public boolean</span><span style=color:#88c0d0> remove</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Object</span><span> element</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1> for</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>int</span><span> index</span><span style=color:#81a1c1> =</span><span> size </span><span style=color:#81a1c1>-</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span><span> index </span><span style=color:#81a1c1>>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span> index</span><span style=color:#81a1c1>--</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>element </span><span style=color:#81a1c1>==</span><span> elementData</span><span style=color:#eceff4>[</span><span>index</span><span style=color:#eceff4>])</span></span>
<span class=giallo-l><span style=color:#eceff4>  {</span></span>
<span class=giallo-l><span style=color:#81a1c1>   final int</span><span> numMoved</span><span style=color:#81a1c1> =</span><span> size </span><span style=color:#81a1c1>-</span><span> index </span><span style=color:#81a1c1>-</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>   if</span><span style=color:#eceff4> (</span><span>numMoved </span><span style=color:#81a1c1>></span><span style=color:#b48ead> 0</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>   {</span></span>
<span class=giallo-l><span>    System</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>arraycopy</span><span style=color:#eceff4>(</span><span>elementData</span><span style=color:#eceff4>,</span><span> index </span><span style=color:#81a1c1>+</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span><span>      elementData</span><span style=color:#eceff4>,</span><span> index</span><span style=color:#eceff4>,</span><span> numMoved</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>   }</span></span>
<span class=giallo-l><span>   elementData</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>--</span><span>size</span><span style=color:#eceff4>]</span><span style=color:#81a1c1> = null;</span></span>
<span class=giallo-l><span style=color:#81a1c1>   return true;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#81a1c1> return false;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span>}</span></span></code></pre><ul><li>Custom collection type called as <a href=https://www.javadoc.io/doc/com.zaxxer/HikariCP/2.6.1/com/zaxxer/hikari/util/ConcurrentBag.html rel=external>ConcurrentBag</a> is implemented to improve the efficiency of concurrent reading and writing.<li>The ConcurrentBag implementation provides a lock-free design, ThreadLocal caching, Queue-stealing and direct hand-off optimizations resulting in a high degree of concurrency, extremely low latency, and minimized occurrences of false-sharing.<li>Other optimizations relating to method calls, that take minimum CPU time slice are implemented.<li>HikariCP jar size is just 135KB, due to the smaller amount of code, the efficiency of execution is higher. As per the popular saying in software coding practice “Lower the code lower the probability of bugs”, HikariCP has least no of bugs.</ul><p>Check the source code of lockless and thread safe implementation of ConcurrentBag <a href=https://github.com/openbouquet/HikariCP/blob/master/src/main/java/com/zaxxer/hikari/util/ConcurrentBag.java rel=external>here</a>.<p>Further Reading Material:<ul><li>How to choose database connection pool : <a href=https://techblog.topdesk.com/coding/choosing-a-database-connection-pool/ rel=external>https://techblog.topdesk.com/coding/choosing-a-database-connection-pool/</a><li><a href=http://www.programmersought.com/article/319698001/ rel=external>http://www.programmersought.com/article/319698001/</a><li>How to size the Pool : <a href=https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing rel=external>https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing</a><li>Database Down Behaviour : <a href=https://github.com/brettwooldridge/HikariCP/wiki/Bad-Behavior:-Handling-Database-Down rel=external>https://github.com/brettwooldridge/HikariCP/wiki/Bad-Behavior:-Handling-Database-Down</a><li>Performance Comparison 1 : <a href=https://www.wix.engineering/blog/how-does-hikaricp-compare-to-other-connection-pools rel=external>https://www.wix.engineering/blog/how-does-hikaricp-compare-to-other-connection-pools</a><li>Performance Comparison 2 : <a href=https://nbsoftsolutions.com/blog/the-difficulty-of-performance-evaluation-of-hikaricp-in-dropwizard rel=external>https://nbsoftsolutions.com/blog/the-difficulty-of-performance-evaluation-of-hikaricp-in-dropwizard</a><li><a href=https://blog.jooq.org/2017/02/21/jooq-tuesdays-brett-wooldridge-shows-what-it-takes-to-write-the-fastest-java-connection-pool/ rel=external>https://blog.jooq.org/2017/02/21/jooq-tuesdays-brett-wooldridge-shows-what-it-takes-to-write-the-fastest-java-connection-pool/</a></ul></div></div></section>