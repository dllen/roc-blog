<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Spring 源码阅读：05. AOP 代理机制 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/spring/> /spring </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2026-01-14</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Spring 源码阅读：05. AOP 代理机制</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p>Rod Johnson 在《J2EE without EJB》中提出，业务逻辑应该纯粹，不应该包含日志、事务、安全等代码。AOP (Aspect Oriented Programming) 是实现这一目标的关键。<h2 id=1-dai-li-gong-han-proxyfactory>1. 代理工厂 (<code>ProxyFactory</code>)</h2><p>Spring AOP 的核心是代理。Spring 不会修改字节码（除非使用 AspectJ LTW），而是通过运行期生成代理对象来拦截方法调用。 <code>ProxyFactory</code> 是生成代理的工厂，它会根据情况选择具体的实现。<h2 id=2-jdk-dong-tai-dai-li-vs-cglib>2. JDK 动态代理 vs CGLIB</h2><h3 id=2-1-jdk-dynamic-proxy>2.1 JDK Dynamic Proxy</h3><ul><li><strong>条件</strong>: 目标对象实现了至少一个接口。<li><strong>原理</strong>: 利用 <code>java.lang.reflect.Proxy</code> 生成一个实现了相同接口的类。<li><strong>优点</strong>: JDK 自带，无需第三方库。<li><strong>缺点</strong>: 只能代理接口方法。</ul><h3 id=2-2-cglib-code-generation-library>2.2 CGLIB (Code Generation Library)</h3><ul><li><strong>条件</strong>: 目标对象没有实现接口，或者是强制开启 (<code>proxyTargetClass=true</code>)。<li><strong>原理</strong>: 利用 ASM 字节码库，生成目标类的<strong>子类</strong>，并重写父类方法。<li><strong>优点</strong>: 可以代理具体的类。<li><strong>缺点</strong>: 不能代理 <code>final</code> 类或 <code>final</code> 方法（因为无法继承/重写）。</ul><h2 id=3-spring-boot-de-mo-ren-xuan-ze>3. Spring Boot 的默认选择</h2><p>在 Spring Boot 2.x 中，默认策略变成了 <strong>CGLIB</strong> (<code>spring.aop.proxy-target-class=true</code>)。 为什么？因为 CGLIB 更健壮，避免了因为没有接口而导致的注入失败（Cast Exception）。<h2 id=4-aopproxy-jie-kou>4. <code>AopProxy</code> 接口</h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>public interface</span><span style=color:#8fbcbb> AopProxy</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Object</span><span style=color:#88c0d0> getProxy</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Object</span><span style=color:#88c0d0> getProxy</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ClassLoader</span><span> classLoader</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>两个实现类：<code>JdkDynamicAopProxy</code> 和 <code>CglibAopProxy</code>。<hr><p><strong>Next</strong>: <a href=../06-pointcut-advisor/>Spring 源码阅读：06. Pointcut 与 Advisor</a></div></div></section>