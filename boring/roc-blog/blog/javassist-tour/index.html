<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Javassist tutorial | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2019-12-01</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Javassist tutorial</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p><a href=https://github.com/jboss-javassist/javassist rel=external>GitHub - jboss-javassist/javassist: Java bytecode engineering toolkit</a><ul><li><p><a href=https://www.javassist.org/tutorial/tutorial.html rel=external>tutorial</a></p><li><p><a href=https://www.javassist.org/tutorial/tutorial2.html rel=external>tutorial2</a></p><li><p><a href=https://www.javassist.org/tutorial/tutorial3.html rel=external>tutorial3</a></p></ul><p><a href=https://gitee.com/dllen/dllen-demos/tree/master/javassist-tour rel=external>示例代码地址</a><h3 id=java-bytecode>Java Bytecode</h3><p><a href=https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings rel=external>Java字节码指令列表</a><p>示例：<code>Point.java</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>package</span><span style=color:#8fbcbb> com</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ks</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>test</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>app</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> Point</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    private int</span><span> x</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    private int</span><span> y</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    public</span><span style=color:#8fbcbb> String</span><span> name</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public</span><span style=color:#88c0d0> Point</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span> x</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> int</span><span> y</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        this</span><span style=color:#eceff4>.</span><span>x</span><span style=color:#81a1c1> =</span><span> x</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        this</span><span style=color:#eceff4>.</span><span>y</span><span style=color:#81a1c1> =</span><span> y</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public int</span><span style=color:#88c0d0> getX</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span> x</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public void</span><span style=color:#88c0d0> setX</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span> x</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        this</span><span style=color:#eceff4>.</span><span>x</span><span style=color:#81a1c1> =</span><span> x</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public int</span><span style=color:#88c0d0> getY</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span> y</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public void</span><span style=color:#88c0d0> setY</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span> y</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        this</span><span style=color:#eceff4>.</span><span>y</span><span style=color:#81a1c1> =</span><span> y</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public void</span><span style=color:#88c0d0> move</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span> x</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> int</span><span> y</span><span style=color:#eceff4>){</span></span>
<span class=giallo-l><span style=color:#81a1c1>        this</span><span style=color:#eceff4>.</span><span>x</span><span style=color:#81a1c1> =</span><span> x</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        this</span><span style=color:#eceff4>.</span><span>y</span><span style=color:#81a1c1> =</span><span> y</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>编译java文件并查看字节码<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>mvn</span><span style=color:#a3be8c> clean compile</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>javap</span><span style=color:#a3be8c> -c target.classes.com.ks.test.app.Point</span></span></code></pre><p>Java 字节码<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> com</span><span>.ks.test.app.Point </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  public</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>String</span><span> name</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  public</span><span> com.ks.test.app.</span><span style=color:#88c0d0>Point</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> int</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    Code</span><span style=color:#81a1c1>:</span></span>
<span class=giallo-l><span style=color:#b48ead>       0</span><span style=color:#81a1c1>:</span><span> aload_0</span></span>
<span class=giallo-l><span style=color:#b48ead>       1</span><span style=color:#81a1c1>:</span><span> invokespecial #</span><span style=color:#b48ead>1</span><span style=color:#616e88>                  // Method java/lang/Object."&lt;init>":()V</span></span>
<span class=giallo-l><span style=color:#b48ead>       4</span><span style=color:#81a1c1>:</span><span> aload_0</span></span>
<span class=giallo-l><span style=color:#b48ead>       5</span><span style=color:#81a1c1>:</span><span> iload_1</span></span>
<span class=giallo-l><span style=color:#b48ead>       6</span><span style=color:#81a1c1>:</span><span> putfield      #</span><span style=color:#b48ead>2</span><span style=color:#616e88>                  // Field x:I</span></span>
<span class=giallo-l><span style=color:#b48ead>       9</span><span style=color:#81a1c1>:</span><span> aload_0</span></span>
<span class=giallo-l><span style=color:#b48ead>      10</span><span style=color:#81a1c1>:</span><span> iload_2</span></span>
<span class=giallo-l><span style=color:#b48ead>      11</span><span style=color:#81a1c1>:</span><span> putfield      #</span><span style=color:#b48ead>3</span><span style=color:#616e88>                  // Field y:I</span></span>
<span class=giallo-l><span style=color:#b48ead>      14</span><span style=color:#81a1c1>: return</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  public int</span><span style=color:#88c0d0> getX</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    Code</span><span style=color:#81a1c1>:</span></span>
<span class=giallo-l><span style=color:#b48ead>       0</span><span style=color:#81a1c1>:</span><span> aload_0</span></span>
<span class=giallo-l><span style=color:#b48ead>       1</span><span style=color:#81a1c1>:</span><span> getfield      #</span><span style=color:#b48ead>2</span><span style=color:#616e88>                  // Field x:I</span></span>
<span class=giallo-l><span style=color:#b48ead>       4</span><span style=color:#81a1c1>:</span><span> ireturn</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  public void</span><span style=color:#88c0d0> setX</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    Code</span><span style=color:#81a1c1>:</span></span>
<span class=giallo-l><span style=color:#b48ead>       0</span><span style=color:#81a1c1>:</span><span> aload_0</span></span>
<span class=giallo-l><span style=color:#b48ead>       1</span><span style=color:#81a1c1>:</span><span> iload_1</span></span>
<span class=giallo-l><span style=color:#b48ead>       2</span><span style=color:#81a1c1>:</span><span> putfield      #</span><span style=color:#b48ead>2</span><span style=color:#616e88>                  // Field x:I</span></span>
<span class=giallo-l><span style=color:#b48ead>       5</span><span style=color:#81a1c1>: return</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  public int</span><span style=color:#88c0d0> getY</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    Code</span><span style=color:#81a1c1>:</span></span>
<span class=giallo-l><span style=color:#b48ead>       0</span><span style=color:#81a1c1>:</span><span> aload_0</span></span>
<span class=giallo-l><span style=color:#b48ead>       1</span><span style=color:#81a1c1>:</span><span> getfield      #</span><span style=color:#b48ead>3</span><span style=color:#616e88>                  // Field y:I</span></span>
<span class=giallo-l><span style=color:#b48ead>       4</span><span style=color:#81a1c1>:</span><span> ireturn</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  public void</span><span style=color:#88c0d0> setY</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    Code</span><span style=color:#81a1c1>:</span></span>
<span class=giallo-l><span style=color:#b48ead>       0</span><span style=color:#81a1c1>:</span><span> aload_0</span></span>
<span class=giallo-l><span style=color:#b48ead>       1</span><span style=color:#81a1c1>:</span><span> iload_1</span></span>
<span class=giallo-l><span style=color:#b48ead>       2</span><span style=color:#81a1c1>:</span><span> putfield      #</span><span style=color:#b48ead>3</span><span style=color:#616e88>                  // Field y:I</span></span>
<span class=giallo-l><span style=color:#b48ead>       5</span><span style=color:#81a1c1>: return</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  public void</span><span style=color:#88c0d0> move</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> int</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    Code</span><span style=color:#81a1c1>:</span></span>
<span class=giallo-l><span style=color:#b48ead>       0</span><span style=color:#81a1c1>:</span><span> aload_0</span></span>
<span class=giallo-l><span style=color:#b48ead>       1</span><span style=color:#81a1c1>:</span><span> iload_1</span></span>
<span class=giallo-l><span style=color:#b48ead>       2</span><span style=color:#81a1c1>:</span><span> putfield      #</span><span style=color:#b48ead>2</span><span style=color:#616e88>                  // Field x:I</span></span>
<span class=giallo-l><span style=color:#b48ead>       5</span><span style=color:#81a1c1>:</span><span> aload_0</span></span>
<span class=giallo-l><span style=color:#b48ead>       6</span><span style=color:#81a1c1>:</span><span> iload_2</span></span>
<span class=giallo-l><span style=color:#b48ead>       7</span><span style=color:#81a1c1>:</span><span> putfield      #</span><span style=color:#b48ead>3</span><span style=color:#616e88>                  // Field y:I</span></span>
<span class=giallo-l><span style=color:#b48ead>      10</span><span style=color:#81a1c1>: return</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>分析一下<code>move()</code>方法的字节码<ul><li><p>aload_0: 从局部变量0加载一个引用到堆栈上</p><li><p>iload_1: 从局部变量1加载 int 值</p><li><p>putfield：给对象赋值</p><li><p>return：方法返回</p></ul><p>Java代码都会编译成字节码，使用 <em><a href=http://jboss-javassist.github.io/javassist/ rel=external>Javasisst</a></em> 可以非常容易的修改字节码；<h3 id=generating-a-java-class>Generating a Java Class</h3><p>生产一个Java类<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>reflect</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Field</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassPool</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>AccessFlag</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassFile</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>FieldInfo</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> Demo1</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>[]</span><span> args</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> throws</span><span style=color:#8fbcbb> Exception</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // 生产一个Demo类，并添加一个id字段</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassFile</span><span> cf</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> ClassFile</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>com.ks.test.app.Demo</span><span style=color:#eceff4>",</span><span style=color:#81a1c1> null</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        cf</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>setInterfaces</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>new</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>[]{"</span><span style=color:#a3be8c>java.io.Serializable</span><span style=color:#eceff4>"})</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldInfo</span><span> fieldInfo</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> FieldInfo</span><span style=color:#eceff4>(</span><span>cf</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getConstPool</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>id</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>I</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        fieldInfo</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>setAccessFlags</span><span style=color:#eceff4>(</span><span>AccessFlag</span><span style=color:#eceff4>.</span><span>PUBLIC</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        cf</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>addField</span><span style=color:#eceff4>(</span><span>fieldInfo</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassPool</span><span> classPool</span><span style=color:#81a1c1> =</span><span> ClassPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDefault</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Field</span><span style=color:#eceff4>[]</span><span> fields</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>makeClass</span><span style=color:#eceff4>(</span><span>cf</span><span style=color:#eceff4>).</span><span style=color:#88c0d0>toClass</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>getFields</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        //</span></span>
<span class=giallo-l><span>        System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>(</span><span>fields</span><span style=color:#eceff4>[</span><span style=color:#b48ead>0</span><span style=color:#eceff4>].</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h3 id=loading-bytecode-instructions-of-class>Loading Bytecode instructions of Class</h3><p>获取Java Class 的字节码<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassPool</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassFile</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CodeAttribute</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CodeIterator</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>MethodInfo</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Mnemonic</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> Demo2</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>[]</span><span> args</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> throws</span><span style=color:#8fbcbb> Exception</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassPool</span><span> classPool</span><span style=color:#81a1c1> =</span><span> ClassPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDefault</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassFile</span><span> classFile</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>com.ks.test.app.Point</span><span style=color:#eceff4>").</span><span style=color:#88c0d0>getClassFile</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        MethodInfo</span><span> methodInfo</span><span style=color:#81a1c1> =</span><span> classFile</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getMethod</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>move</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        CodeAttribute</span><span> codeAttribute</span><span style=color:#81a1c1> =</span><span> methodInfo</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getCodeAttribute</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        CodeIterator</span><span> codeIterator</span><span style=color:#81a1c1> =</span><span> codeAttribute</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>iterator</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // 打印 move 方法的字节码</span></span>
<span class=giallo-l><span>        System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>start print move byte code....</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        while</span><span style=color:#eceff4> (</span><span>codeIterator</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>hasNext</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            int</span><span> index</span><span style=color:#81a1c1> =</span><span> codeIterator</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            int</span><span> op</span><span style=color:#81a1c1> =</span><span> codeIterator</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>byteAt</span><span style=color:#eceff4>(</span><span>index</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>            System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>(</span><span>Mnemonic</span><span style=color:#eceff4>.</span><span>OPCODE</span><span style=color:#eceff4>[</span><span>op</span><span style=color:#eceff4>])</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>end print move byte code....</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h3 id=adding-fields-to-existing-class-bytecode>Adding Fields to Existing Class Bytecode</h3><p>给已有Java Class 添加字段<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>reflect</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Field</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassPool</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>AccessFlag</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassFile</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>FieldInfo</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> Demo3</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>[]</span><span> args</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> throws</span><span style=color:#8fbcbb> Exception</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassPool</span><span> classPool</span><span style=color:#81a1c1> =</span><span> ClassPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDefault</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassFile</span><span> classFile</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>com.ks.test.app.Point</span><span style=color:#eceff4>").</span><span style=color:#88c0d0>getClassFile</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        // 给 Point 类添加一个id字段</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldInfo</span><span> fieldInfo</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> FieldInfo</span><span style=color:#eceff4>(</span><span>classFile</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getConstPool</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>id</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>I</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        fieldInfo</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>setAccessFlags</span><span style=color:#eceff4>(</span><span>AccessFlag</span><span style=color:#eceff4>.</span><span>PUBLIC</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        classFile</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>addField</span><span style=color:#eceff4>(</span><span>fieldInfo</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // only get public fields</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Field</span><span style=color:#eceff4>[]</span><span> fields</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>makeClass</span><span style=color:#eceff4>(</span><span>classFile</span><span style=color:#eceff4>).</span><span style=color:#88c0d0>toClass</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>getFields</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>Field</span><span> field</span><span style=color:#81a1c1> :</span><span> fields</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>            System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>(</span><span>field</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h3 id=adding-constructor-to-class-bytecode>Adding Constructor to Class Bytecode</h3><p>添加构造方法<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassPool</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Bytecode</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassFile</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CodeIterator</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>MethodInfo</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>bytecode</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Mnemonic</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> Demo4</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>[]</span><span> args</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> throws</span><span style=color:#8fbcbb> Exception</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassPool</span><span> classPool</span><span style=color:#81a1c1> =</span><span> ClassPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDefault</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassFile</span><span> classFile</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>com.ks.test.app.Point</span><span style=color:#eceff4>").</span><span style=color:#88c0d0>getClassFile</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Bytecode</span><span> bytecode</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> Bytecode</span><span style=color:#eceff4>(</span><span>classFile</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getConstPool</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        bytecode</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>addLload</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        bytecode</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>addInvokespecial</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>java/lang/Object</span><span style=color:#eceff4>",</span><span> MethodInfo</span><span style=color:#eceff4>.</span><span>nameInit</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>()V</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        bytecode</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>addReturn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>null</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        // addInvokespecial</span></span>
<span class=giallo-l><span style=color:#616e88>        // 调用 java.lang.Object &lt;init> 方法</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        MethodInfo</span><span> methodInfo</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> MethodInfo</span><span style=color:#eceff4>(</span><span>classFile</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getConstPool</span><span style=color:#eceff4>(),</span><span> MethodInfo</span><span style=color:#eceff4>.</span><span>nameInit</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>()V</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        methodInfo</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>setCodeAttribute</span><span style=color:#eceff4>(</span><span>bytecode</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>toCodeAttribute</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        classFile</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>addMethod</span><span style=color:#eceff4>(</span><span>methodInfo</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        CodeIterator</span><span> codeIterator</span><span style=color:#81a1c1> =</span><span> bytecode</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>toCodeAttribute</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>iterator</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        // 打印字节码</span></span>
<span class=giallo-l><span style=color:#81a1c1>        while</span><span style=color:#eceff4> (</span><span>codeIterator</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>hasNext</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            int</span><span> index</span><span style=color:#81a1c1> =</span><span> codeIterator</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            int</span><span> op</span><span style=color:#81a1c1> =</span><span> codeIterator</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>byteAt</span><span style=color:#eceff4>(</span><span>index</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>            System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>(</span><span>Mnemonic</span><span style=color:#eceff4>.</span><span>OPCODE</span><span style=color:#eceff4>[</span><span>op</span><span style=color:#eceff4>])</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h3 id=hot-load-java-class>Hot load Java Class</h3><p>运行时替换 Java Class，可以通过以下2种方式：<h4 id=redefineclassagent>RedefineClassAgent</h4><p>RedefineClassAgent 工具类，生成 jvm agent，并load agent，利用 <code>Instrumentation</code> <code>redefineClasses</code> 更新运行时类字节码信息；<p>以下为关键代码：<p><strong>创建和加载Agent</strong><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#616e88>  /**</span></span>
<span class=giallo-l><span style=color:#616e88>     * Lazy loads the agent that populates {@link #instrumentation}. OK to call multiple times.</span></span>
<span class=giallo-l><span style=color:#616e88>     *</span></span>
<span class=giallo-l><span style=color:#616e88>     * </span><span style=color:#8fbcbb>@throws FailedToLoadAgentException</span><span style=color:#616e88> if agent either failed to load or if the agent wasn't able to get an</span></span>
<span class=giallo-l><span style=color:#616e88>     *                                    instance of {@link Instrumentation} that allows class redefinitions.</span></span>
<span class=giallo-l><span style=color:#616e88>     */</span></span>
<span class=giallo-l><span style=color:#81a1c1>    private static void</span><span style=color:#88c0d0> ensureAgentLoaded</span><span style=color:#eceff4>()</span><span> throws FailedToLoadAgentException </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span>instrumentation </span><span style=color:#81a1c1>!= null</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>            // already loaded</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // load the agent</span></span>
<span class=giallo-l><span style=color:#81a1c1>        try</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            File</span><span> agentJar</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> createAgentJarFile</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // Loading an agent requires the PID of the JVM to load the agent to. Find out our PID.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            String</span><span> nameOfRunningVM</span><span style=color:#81a1c1> =</span><span> ManagementFactory</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getRuntimeMXBean</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            String</span><span> pid</span><span style=color:#81a1c1> =</span><span> nameOfRunningVM</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>substring</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>,</span><span> nameOfRunningVM</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>indexOf</span><span style=color:#eceff4>('</span><span style=color:#a3be8c>@</span><span style=color:#eceff4>'))</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // load the agent</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            VirtualMachine</span><span> vm</span><span style=color:#81a1c1> =</span><span> VirtualMachine</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>attach</span><span style=color:#eceff4>(</span><span>pid</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>            vm</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>loadAgent</span><span style=color:#eceff4>(</span><span>agentJar</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getAbsolutePath</span><span style=color:#eceff4>(), "")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>            vm</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>detach</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> catch</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>Exception</span><span> e</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            throw new</span><span style=color:#88c0d0> FailedToLoadAgentException</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // wait for the agent to load</span></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>int</span><span> sec</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span> sec </span><span style=color:#81a1c1>&lt;</span><span> AGENT_LOAD_WAIT_TIME_SEC</span><span style=color:#81a1c1>;</span><span> sec</span><span style=color:#81a1c1>++</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#eceff4> (</span><span>instrumentation </span><span style=color:#81a1c1>!= null</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>                // success!</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            try</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                LOGGER</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>info</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Sleeping for 1 second while waiting for agent to load.</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>                Thread</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1000</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> catch</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>InterruptedException</span><span> e</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>                Thread</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>currentThread</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>interrupt</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                throw new</span><span style=color:#88c0d0> FailedToLoadAgentException</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // agent didn't load</span></span>
<span class=giallo-l><span style=color:#81a1c1>        throw new</span><span style=color:#88c0d0> FailedToLoadAgentException</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /**</span></span>
<span class=giallo-l><span style=color:#616e88>     * An agent must be specified as a .jar where the manifest has an Agent-Class attribute. Additionally, in order</span></span>
<span class=giallo-l><span style=color:#616e88>     * to be able to redefine classes, the Can-Redefine-Classes attribute must be true.</span></span>
<span class=giallo-l><span style=color:#616e88>     *</span></span>
<span class=giallo-l><span style=color:#616e88>     * This method creates such an agent Jar as a temporary file. The Agent-Class is this class. If the returned Jar</span></span>
<span class=giallo-l><span style=color:#616e88>     * is loaded as an agent then {</span><span style=color:#8fbcbb>@link</span><span style=color:#616e88> #</span><span>agentmain(String, Instrumentation)</span><span style=color:#616e88>} will be called by the JVM.</span></span>
<span class=giallo-l><span style=color:#616e88>     *</span></span>
<span class=giallo-l><span style=color:#616e88>     * </span><span style=color:#8fbcbb>@return</span><span style=color:#616e88> a temporary {@link File} that points at Jar that packages this class.</span></span>
<span class=giallo-l><span style=color:#616e88>     * </span><span style=color:#8fbcbb>@throws IOException</span><span style=color:#616e88> if agent Jar creation failed.</span></span>
<span class=giallo-l><span style=color:#616e88>     */</span></span>
<span class=giallo-l><span style=color:#81a1c1>    private static</span><span style=color:#8fbcbb> File</span><span style=color:#88c0d0> createAgentJarFile</span><span style=color:#eceff4>()</span><span> throws IOException </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        File</span><span> jarFile</span><span style=color:#81a1c1> =</span><span> File</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>createTempFile</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>agent</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>.jar</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        jarFile</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>deleteOnExit</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // construct a manifest that allows class redefinition</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Manifest</span><span> manifest</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> Manifest</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Attributes</span><span> mainAttributes</span><span style=color:#81a1c1> =</span><span> manifest</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getMainAttributes</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        mainAttributes</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>put</span><span style=color:#eceff4>(</span><span>Attributes</span><span style=color:#eceff4>.</span><span>Name</span><span style=color:#eceff4>.</span><span>MANIFEST_VERSION</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>1.0</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        mainAttributes</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>put</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>new</span><span> Attributes</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Name</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Agent-Class</span><span style=color:#eceff4>"),</span><span> RedefineClassAgent</span><span style=color:#eceff4>.</span><span>class</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        mainAttributes</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>put</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>new</span><span> Attributes</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Name</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Can-Retransform-Classes</span><span style=color:#eceff4>"), "</span><span style=color:#a3be8c>true</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        mainAttributes</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>put</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>new</span><span> Attributes</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Name</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Can-Redefine-Classes</span><span style=color:#eceff4>"), "</span><span style=color:#a3be8c>true</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        try</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>JarOutputStream</span><span> jos</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> JarOutputStream</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>new</span><span style=color:#88c0d0> FileOutputStream</span><span style=color:#eceff4>(</span><span>jarFile</span><span style=color:#eceff4>),</span><span> manifest</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#616e88>            // add the agent .class into the .jar</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            JarEntry</span><span> agent</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> JarEntry</span><span style=color:#eceff4>(</span><span>RedefineClassAgent</span><span style=color:#eceff4>.</span><span>class</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>replace</span><span style=color:#eceff4>('</span><span style=color:#a3be8c>.</span><span style=color:#eceff4>', '</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>')</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>.class</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>            jos</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>putNextEntry</span><span style=color:#eceff4>(</span><span>agent</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // dump the class bytecode into the entry</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            ClassPool</span><span> pool</span><span style=color:#81a1c1> =</span><span> ClassPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDefault</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            CtClass</span><span> ctClass</span><span style=color:#81a1c1> =</span><span> pool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span>RedefineClassAgent</span><span style=color:#eceff4>.</span><span>class</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getName</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>            jos</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span>ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>toBytecode</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>            jos</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>closeEntry</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> catch</span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>CannotCompileException</span><span style=color:#eceff4> |</span><span style=color:#8fbcbb> NotFoundException</span><span> e</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>            // Realistically this should never happen.</span></span>
<span class=giallo-l><span>            LOGGER</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>log</span><span style=color:#eceff4>(</span><span>Level</span><span style=color:#eceff4>.</span><span>SEVERE</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>Exception while creating RedefineClassAgent jar.</span><span style=color:#eceff4>",</span><span> e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            throw new</span><span style=color:#88c0d0> IOException</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span> jarFile</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><strong>运行时更新类字节码</strong><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#616e88>    /**</span></span>
<span class=giallo-l><span style=color:#616e88>     * Attempts to redefine class bytecode.</span></span>
<span class=giallo-l><span style=color:#616e88>     * &lt;p></span></span>
<span class=giallo-l><span style=color:#616e88>     * On first call this method will attempt to load an agent into the JVM to obtain an instance of</span></span>
<span class=giallo-l><span style=color:#616e88>     * {@link Instrumentation}. This agent load can introduce a pause (in practice 1 to 2 seconds).</span></span>
<span class=giallo-l><span style=color:#616e88>     *</span></span>
<span class=giallo-l><span style=color:#616e88>     * </span><span style=color:#8fbcbb>@see</span><span style=color:#616e88> Instrumentation#redefineClasses(ClassDefinition...)</span></span>
<span class=giallo-l><span style=color:#616e88>     *</span></span>
<span class=giallo-l><span style=color:#616e88>     * </span><span style=color:#8fbcbb>@param</span><span> definitions</span><span style=color:#616e88> classes to redefine.</span></span>
<span class=giallo-l><span style=color:#616e88>     * </span><span style=color:#8fbcbb>@throws UnmodifiableClassException</span><span style=color:#616e88> as thrown by {</span><span style=color:#8fbcbb>@link Instrumentation</span><span style=color:#616e88>#</span><span>redefineClasses(ClassDefinition...)</span><span style=color:#616e88>}</span></span>
<span class=giallo-l><span style=color:#616e88>     * </span><span style=color:#8fbcbb>@throws ClassNotFoundException</span><span style=color:#616e88> as thrown by {</span><span style=color:#8fbcbb>@link Instrumentation</span><span style=color:#616e88>#</span><span>redefineClasses(ClassDefinition...)</span><span style=color:#616e88>}</span></span>
<span class=giallo-l><span style=color:#616e88>     * </span><span style=color:#8fbcbb>@throws FailedToLoadAgentException</span><span style=color:#616e88> if agent either failed to load or if the agent wasn't able to get an</span></span>
<span class=giallo-l><span style=color:#616e88>     *                                    instance of {@link Instrumentation} that allows class redefinitions.</span></span>
<span class=giallo-l><span style=color:#616e88>     */</span></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> redefineClasses</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ClassDefinition</span><span style=color:#eceff4>...</span><span> definitions</span><span style=color:#eceff4>)</span><span> throws UnmodifiableClassException</span><span style=color:#eceff4>,</span><span> ClassNotFoundException</span><span style=color:#eceff4>,</span><span> FailedToLoadAgentException </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#88c0d0>        ensureAgentLoaded</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        instrumentation</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>redefineClasses</span><span style=color:#eceff4>(</span><span>definitions</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><strong>测试代码</strong><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> java</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>lang</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>instrument</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassDefinition</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassPool</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CtClass</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CtMethod</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> Demo5</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>[]</span><span> args</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> throws</span><span style=color:#8fbcbb> Exception</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassPool</span><span> classPool</span><span style=color:#81a1c1> =</span><span> ClassPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDefault</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        CtClass</span><span> ctClass</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>com.ks.test.app.Point</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>stopPruning</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        // javaassist freezes methods if their bytecode is saved</span></span>
<span class=giallo-l><span style=color:#616e88>        // defrost so we can still make changes.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4> (</span><span>ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>isFrozen</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span>            ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>defrost</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        CtMethod</span><span> ctMethod</span><span style=color:#81a1c1> =</span><span> ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDeclaredMethod</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>move</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        ctMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>insertBefore</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>{ System.out.println(</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>Wheeeeee!</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>); }</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        byte</span><span style=color:#eceff4>[]</span><span> bytecode</span><span style=color:#81a1c1> =</span><span> ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>toBytecode</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassDefinition</span><span> definition</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> ClassDefinition</span><span style=color:#eceff4>(</span><span>Class</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>forName</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>com.ks.test.app.Point</span><span style=color:#eceff4>"),</span><span> bytecode</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        RedefineClassAgent</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>redefineClasses</span><span style=color:#eceff4>(</span><span>definition</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Point</span><span> point</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> Point</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        point</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>move</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h4 id=hotswapper>HotSwapper</h4><p>使用 javassist HotSwapper 工具，该工具依赖 <a href=https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/introclientissues005.html rel=external>JDWP</a>；<blockquote><p>JDWP: Provides the implementation of the Java Debug Wire Protocol (JDWP) agent.<p>使用方法：<code>java -Xdebug -Xrunjdwp:transport=dt_socket,address=8888,server=y,suspend=y Test</code><p>参考文档：<ul><li><p><a href=https://www.baeldung.com/java-application-remote-debugging rel=external>Java Application Remote Debugging | Baeldung</a></p><li><p><a href=https://docs.oracle.com/en/java/javase/12/docs/specs/jpda/architecture.html rel=external>JDWP Structure Overview</a></p><li><p><a href=https://mahmoudanouti.wordpress.com/2019/07/07/remote-debugging-java-applications-with-jdwp/ rel=external>Remote Debugging Java Applications With JDWP | Learning Quest</a></p></ul></blockquote><p>测试代码：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>ClassPool</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CtClass</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>CtMethod</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#8fbcbb> javassist</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>util</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>HotSwapper</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>public class</span><span style=color:#8fbcbb> Demo6</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    //执行命令</span></span>
<span class=giallo-l><span style=color:#616e88>    //java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=10240 Demo6</span></span>
<span class=giallo-l><span style=color:#81a1c1>    public static void</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>[]</span><span> args</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> throws</span><span style=color:#8fbcbb> Exception</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        HotSwapper</span><span> hs</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> HotSwapper</span><span style=color:#eceff4>(</span><span style=color:#b48ead>10240</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        new</span><span style=color:#88c0d0> Hello</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>print</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        ClassPool</span><span> classPool</span><span style=color:#81a1c1> =</span><span> ClassPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDefault</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        byte</span><span style=color:#eceff4>[]</span><span> originBytes</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>com.ks.test.app.Hello</span><span style=color:#eceff4>").</span><span style=color:#88c0d0>toBytecode</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>** reload a v2 version</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        CtClass</span><span> ctClass</span><span style=color:#81a1c1> =</span><span> classPool</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>com.ks.test.app.Hello</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>stopPruning</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#eceff4>(</span><span>ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>isFrozen</span><span style=color:#eceff4>()){</span></span>
<span class=giallo-l><span>            ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>defrost</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        CtMethod</span><span> ctMethod</span><span style=color:#81a1c1> =</span><span> ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getDeclaredMethod</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>print</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        ctMethod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>insertBefore</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>{System.out.println(</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>** HelloWorld.print()</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>);}</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>        hs</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>reload</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>com.ks.test.app.Hello</span><span style=color:#eceff4>",</span><span> ctClass</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>toBytecode</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        new</span><span style=color:#88c0d0> Hello</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>print</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        System</span><span style=color:#eceff4>.</span><span>out</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>** reload the original version</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        hs</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>reload</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>com.ks.test.app.Hello</span><span style=color:#eceff4>",</span><span> originBytes</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        new</span><span style=color:#88c0d0> Hello</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>print</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>测试命令：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>mvn clean package</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>java -cp "$JAVA_HOME/lib/*:target/javassit-tour-jar-with-dependencies.jar" -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=10240 com.ks.test.app.Demo6</span></span></code></pre><blockquote><p>注意：需要把 jdk 目录里 lib 下 jar 加载到 classpath</blockquote><p>运行结果：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>Listening for transport dt_socket at address: 10240</span></span>
<span class=giallo-l><span>hello world</span></span>
<span class=giallo-l><span>** reload a v2 version</span></span>
<span class=giallo-l><span>** HelloWorld.print()</span></span>
<span class=giallo-l><span>hello world</span></span>
<span class=giallo-l><span>** reload the original version</span></span>
<span class=giallo-l><span>hello world</span></span></code></pre></div></div></section>