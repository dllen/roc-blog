<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Javassist tutorial | Roc's Blog</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2019-12-01</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Javassist tutorial</h1><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p><a href=https://github.com/jboss-javassist/javassist>GitHub - jboss-javassist/javassist: Java bytecode engineering toolkit</a><ul><li><p><a href=https://www.javassist.org/tutorial/tutorial.html>tutorial</a></p><li><p><a href=https://www.javassist.org/tutorial/tutorial2.html>tutorial2</a></p><li><p><a href=https://www.javassist.org/tutorial/tutorial3.html>tutorial3</a></p></ul><p><a href=https://gitee.com/dllen/dllen-demos/tree/master/javassist-tour>示例代码地址</a><h3 id=java-bytecode>Java Bytecode</h3><p><a href=https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings>Java字节码指令列表</a><p>示例：<code>Point.java</code><pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span style=color:#f92672>package </span><span>com.ks.test.app;
</span><span>
</span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>class </span><span style=color:#a6e22e;text-decoration:underline>Point </span><span>{
</span><span>
</span><span>    </span><span style=color:#f92672>private </span><span style=color:#66d9ef;font-style:italic>int </span><span>x;
</span><span>    </span><span style=color:#f92672>private </span><span style=color:#66d9ef;font-style:italic>int </span><span>y;
</span><span>    </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>String </span><span>name;
</span><span>
</span><span>    </span><span style=color:#f92672>public </span><span style=color:#a6e22e>Point</span><span>(</span><span style=color:#66d9ef;font-style:italic>int </span><span style=color:#fd971f;font-style:italic>x</span><span>, </span><span style=color:#66d9ef;font-style:italic>int </span><span style=color:#fd971f;font-style:italic>y</span><span>) {
</span><span>        this.x </span><span style=color:#f92672>=</span><span> x;
</span><span>        this.y </span><span style=color:#f92672>=</span><span> y;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>int </span><span style=color:#a6e22e>getX</span><span>() {
</span><span>        </span><span style=color:#f92672>return</span><span> x;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>setX</span><span>(</span><span style=color:#66d9ef;font-style:italic>int </span><span style=color:#fd971f;font-style:italic>x</span><span>) {
</span><span>        this.x </span><span style=color:#f92672>=</span><span> x;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>int </span><span style=color:#a6e22e>getY</span><span>() {
</span><span>        </span><span style=color:#f92672>return</span><span> y;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>setY</span><span>(</span><span style=color:#66d9ef;font-style:italic>int </span><span style=color:#fd971f;font-style:italic>y</span><span>) {
</span><span>        this.y </span><span style=color:#f92672>=</span><span> y;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>move</span><span>(</span><span style=color:#66d9ef;font-style:italic>int </span><span style=color:#fd971f;font-style:italic>x</span><span>, </span><span style=color:#66d9ef;font-style:italic>int </span><span style=color:#fd971f;font-style:italic>y</span><span>){
</span><span>        this.x </span><span style=color:#f92672>=</span><span> x;
</span><span>        this.y </span><span style=color:#f92672>=</span><span> y;
</span><span>    }
</span><span>}
</span></code></pre><p>编译java文件并查看字节码<pre class=language-shell data-lang=shell style=color:#f8f8f2;background-color:#272822><code class=language-shell data-lang=shell><span>mvn clean compile
</span><span>
</span><span>javap -c target.classes.com.ks.test.app.Point
</span></code></pre><p>Java 字节码<pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>class </span><span style=color:#a6e22e;text-decoration:underline>com</span><span>.</span><span style=color:#66d9ef;font-style:italic>ks</span><span>.</span><span style=color:#66d9ef;font-style:italic>test</span><span>.</span><span style=color:#66d9ef;font-style:italic>app</span><span>.</span><span style=color:#66d9ef;font-style:italic>Point </span><span>{
</span><span>  </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>java</span><span>.</span><span style=color:#66d9ef;font-style:italic>lang</span><span>.</span><span style=color:#66d9ef;font-style:italic>String</span><span> name;
</span><span>
</span><span>  </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>com</span><span>.</span><span style=color:#66d9ef;font-style:italic>ks</span><span>.</span><span style=color:#66d9ef;font-style:italic>test</span><span>.</span><span style=color:#66d9ef;font-style:italic>app</span><span>.</span><span style=color:#66d9ef;font-style:italic>Point</span><span>(</span><span style=color:#66d9ef;font-style:italic>int</span><span>, </span><span style=color:#66d9ef;font-style:italic>int</span><span>);
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Code</span><span style=color:#f92672>:
</span><span>       </span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span><span> aload_0
</span><span>       </span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span> invokespecial #</span><span style=color:#ae81ff>1                  </span><span style=color:#75715e>// Method java/lang/Object."&lt;init>":()V
</span><span>       </span><span style=color:#ae81ff>4</span><span style=color:#f92672>:</span><span> aload_0
</span><span>       </span><span style=color:#ae81ff>5</span><span style=color:#f92672>:</span><span> iload_1
</span><span>       </span><span style=color:#ae81ff>6</span><span style=color:#f92672>:</span><span> putfield      #</span><span style=color:#ae81ff>2                  </span><span style=color:#75715e>// Field x:I
</span><span>       </span><span style=color:#ae81ff>9</span><span style=color:#f92672>:</span><span> aload_0
</span><span>      </span><span style=color:#ae81ff>10</span><span style=color:#f92672>:</span><span> iload_2
</span><span>      </span><span style=color:#ae81ff>11</span><span style=color:#f92672>:</span><span> putfield      #</span><span style=color:#ae81ff>3                  </span><span style=color:#75715e>// Field y:I
</span><span>      </span><span style=color:#ae81ff>14</span><span style=color:#f92672>: return
</span><span>
</span><span>  </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>int </span><span>getX();
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Code</span><span style=color:#f92672>:
</span><span>       </span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span><span> aload_0
</span><span>       </span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span> getfield      #</span><span style=color:#ae81ff>2                  </span><span style=color:#75715e>// Field x:I
</span><span>       </span><span style=color:#ae81ff>4</span><span style=color:#f92672>:</span><span> ireturn
</span><span>
</span><span>  </span><span style=color:#f92672>public</span><span> void setX(</span><span style=color:#66d9ef;font-style:italic>int</span><span>);
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Code</span><span style=color:#f92672>:
</span><span>       </span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span><span> aload_0
</span><span>       </span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span> iload_1
</span><span>       </span><span style=color:#ae81ff>2</span><span style=color:#f92672>:</span><span> putfield      #</span><span style=color:#ae81ff>2                  </span><span style=color:#75715e>// Field x:I
</span><span>       </span><span style=color:#ae81ff>5</span><span style=color:#f92672>: return
</span><span>
</span><span>  </span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>int </span><span>getY();
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Code</span><span style=color:#f92672>:
</span><span>       </span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span><span> aload_0
</span><span>       </span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span> getfield      #</span><span style=color:#ae81ff>3                  </span><span style=color:#75715e>// Field y:I
</span><span>       </span><span style=color:#ae81ff>4</span><span style=color:#f92672>:</span><span> ireturn
</span><span>
</span><span>  </span><span style=color:#f92672>public</span><span> void setY(</span><span style=color:#66d9ef;font-style:italic>int</span><span>);
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Code</span><span style=color:#f92672>:
</span><span>       </span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span><span> aload_0
</span><span>       </span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span> iload_1
</span><span>       </span><span style=color:#ae81ff>2</span><span style=color:#f92672>:</span><span> putfield      #</span><span style=color:#ae81ff>3                  </span><span style=color:#75715e>// Field y:I
</span><span>       </span><span style=color:#ae81ff>5</span><span style=color:#f92672>: return
</span><span>
</span><span>  </span><span style=color:#f92672>public</span><span> void move(</span><span style=color:#66d9ef;font-style:italic>int</span><span>, </span><span style=color:#66d9ef;font-style:italic>int</span><span>);
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Code</span><span style=color:#f92672>:
</span><span>       </span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span><span> aload_0
</span><span>       </span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span> iload_1
</span><span>       </span><span style=color:#ae81ff>2</span><span style=color:#f92672>:</span><span> putfield      #</span><span style=color:#ae81ff>2                  </span><span style=color:#75715e>// Field x:I
</span><span>       </span><span style=color:#ae81ff>5</span><span style=color:#f92672>:</span><span> aload_0
</span><span>       </span><span style=color:#ae81ff>6</span><span style=color:#f92672>:</span><span> iload_2
</span><span>       </span><span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span> putfield      #</span><span style=color:#ae81ff>3                  </span><span style=color:#75715e>// Field y:I
</span><span>      </span><span style=color:#ae81ff>10</span><span style=color:#f92672>: return
</span><span>}
</span></code></pre><p>分析一下<code>move()</code>方法的字节码<ul><li><p>aload_0: 从局部变量0加载一个引用到堆栈上</p><li><p>iload_1: 从局部变量1加载 int 值</p><li><p>putfield：给对象赋值</p><li><p>return：方法返回</p></ul><p>Java代码都会编译成字节码，使用 <em><a href=http://jboss-javassist.github.io/javassist/>Javasisst</a></em> 可以非常容易的修改字节码；<h3 id=generating-a-java-class>Generating a Java Class</h3><p>生产一个Java类<pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>java</span><span>.</span><span style=color:#66d9ef;font-style:italic>lang</span><span>.</span><span style=color:#66d9ef;font-style:italic>reflect</span><span>.</span><span style=color:#66d9ef;font-style:italic>Field</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>AccessFlag</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassFile</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>FieldInfo</span><span>;
</span><span>
</span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>class </span><span style=color:#a6e22e;text-decoration:underline>Demo1 </span><span>{
</span><span>
</span><span>    </span><span style=color:#f92672>public static </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>main</span><span>(</span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#f92672>[] </span><span style=color:#fd971f;font-style:italic>args</span><span>) </span><span style=color:#f92672>throws </span><span style=color:#66d9ef;font-style:italic>Exception </span><span>{
</span><span>
</span><span>        </span><span style=color:#75715e>// 生产一个Demo类，并添加一个id字段
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassFile</span><span> cf </span><span style=color:#f92672>= new </span><span style=color:#66d9ef;font-style:italic>ClassFile</span><span>(</span><span style=color:#ae81ff>false</span><span>, </span><span style=color:#e6db74>"com.ks.test.app.Demo"</span><span>, </span><span style=color:#ae81ff>null</span><span>);
</span><span>
</span><span>        cf.setInterfaces(</span><span style=color:#f92672>new </span><span style=color:#66d9ef;font-style:italic>String</span><span>[]{</span><span style=color:#e6db74>"java.io.Serializable"</span><span>});
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>FieldInfo</span><span> fieldInfo </span><span style=color:#f92672>= new </span><span style=color:#66d9ef;font-style:italic>FieldInfo</span><span>(cf.getConstPool(), </span><span style=color:#e6db74>"id"</span><span>, </span><span style=color:#e6db74>"I"</span><span>);
</span><span>        fieldInfo.setAccessFlags(</span><span style=color:#66d9ef;font-style:italic>AccessFlag</span><span>.</span><span style=color:#ae81ff>PUBLIC</span><span>);
</span><span>        cf.addField(fieldInfo);
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span> classPool </span><span style=color:#f92672>= </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>.getDefault();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>Field</span><span style=color:#f92672>[]</span><span> fields </span><span style=color:#f92672>=</span><span> classPool.makeClass(cf).toClass().getFields();
</span><span>
</span><span>        </span><span style=color:#75715e>//
</span><span>        </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println(fields[</span><span style=color:#ae81ff>0</span><span>].getName());
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><h3 id=loading-bytecode-instructions-of-class>Loading Bytecode instructions of Class</h3><p>获取Java Class 的字节码<pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassFile</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>CodeAttribute</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>CodeIterator</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>MethodInfo</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>Mnemonic</span><span>;
</span><span>
</span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>class </span><span style=color:#a6e22e;text-decoration:underline>Demo2 </span><span>{
</span><span>
</span><span>    </span><span style=color:#f92672>public static </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>main</span><span>(</span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#f92672>[] </span><span style=color:#fd971f;font-style:italic>args</span><span>) </span><span style=color:#f92672>throws </span><span style=color:#66d9ef;font-style:italic>Exception </span><span>{
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span> classPool </span><span style=color:#f92672>= </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>.getDefault();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassFile</span><span> classFile </span><span style=color:#f92672>=</span><span> classPool.get(</span><span style=color:#e6db74>"com.ks.test.app.Point"</span><span>).getClassFile();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>MethodInfo</span><span> methodInfo </span><span style=color:#f92672>=</span><span> classFile.getMethod(</span><span style=color:#e6db74>"move"</span><span>);
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>CodeAttribute</span><span> codeAttribute </span><span style=color:#f92672>=</span><span> methodInfo.getCodeAttribute();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>CodeIterator</span><span> codeIterator </span><span style=color:#f92672>=</span><span> codeAttribute.iterator();
</span><span>
</span><span>        </span><span style=color:#75715e>// 打印 move 方法的字节码
</span><span>        </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println(</span><span style=color:#e6db74>"start print move byte code...."</span><span>);
</span><span>        </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println();
</span><span>        </span><span style=color:#f92672>while </span><span>(codeIterator.hasNext()) {
</span><span>            </span><span style=color:#66d9ef;font-style:italic>int</span><span> index </span><span style=color:#f92672>=</span><span> codeIterator.next();
</span><span>            </span><span style=color:#66d9ef;font-style:italic>int</span><span> op </span><span style=color:#f92672>=</span><span> codeIterator.byteAt(index);
</span><span>            </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println(</span><span style=color:#66d9ef;font-style:italic>Mnemonic</span><span>.</span><span style=color:#ae81ff>OPCODE</span><span>[op]);
</span><span>        }
</span><span>        </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println();
</span><span>        </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println(</span><span style=color:#e6db74>"end print move byte code...."</span><span>);
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><h3 id=adding-fields-to-existing-class-bytecode>Adding Fields to Existing Class Bytecode</h3><p>给已有Java Class 添加字段<pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>java</span><span>.</span><span style=color:#66d9ef;font-style:italic>lang</span><span>.</span><span style=color:#66d9ef;font-style:italic>reflect</span><span>.</span><span style=color:#66d9ef;font-style:italic>Field</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>AccessFlag</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassFile</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>FieldInfo</span><span>;
</span><span>
</span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>class </span><span style=color:#a6e22e;text-decoration:underline>Demo3 </span><span>{
</span><span>
</span><span>    </span><span style=color:#f92672>public static </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>main</span><span>(</span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#f92672>[] </span><span style=color:#fd971f;font-style:italic>args</span><span>) </span><span style=color:#f92672>throws </span><span style=color:#66d9ef;font-style:italic>Exception </span><span>{
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span> classPool </span><span style=color:#f92672>= </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>.getDefault();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassFile</span><span> classFile </span><span style=color:#f92672>=</span><span> classPool.get(</span><span style=color:#e6db74>"com.ks.test.app.Point"</span><span>).getClassFile();
</span><span>        </span><span style=color:#75715e>// 给 Point 类添加一个id字段
</span><span>        </span><span style=color:#66d9ef;font-style:italic>FieldInfo</span><span> fieldInfo </span><span style=color:#f92672>= new </span><span style=color:#66d9ef;font-style:italic>FieldInfo</span><span>(classFile.getConstPool(), </span><span style=color:#e6db74>"id"</span><span>, </span><span style=color:#e6db74>"I"</span><span>);
</span><span>        fieldInfo.setAccessFlags(</span><span style=color:#66d9ef;font-style:italic>AccessFlag</span><span>.</span><span style=color:#ae81ff>PUBLIC</span><span>);
</span><span>
</span><span>        classFile.addField(fieldInfo);
</span><span>
</span><span>        </span><span style=color:#75715e>// only get public fields
</span><span>        </span><span style=color:#66d9ef;font-style:italic>Field</span><span style=color:#f92672>[]</span><span> fields </span><span style=color:#f92672>=</span><span> classPool.makeClass(classFile).toClass().getFields();
</span><span>
</span><span>        </span><span style=color:#f92672>for </span><span>(</span><span style=color:#66d9ef;font-style:italic>Field</span><span> field </span><span style=color:#f92672>:</span><span> fields) {
</span><span>            </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println(field.getName());
</span><span>        }
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><h3 id=adding-constructor-to-class-bytecode>Adding Constructor to Class Bytecode</h3><p>添加构造方法<pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>Bytecode</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassFile</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>CodeIterator</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>MethodInfo</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>bytecode</span><span>.</span><span style=color:#66d9ef;font-style:italic>Mnemonic</span><span>;
</span><span>
</span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>class </span><span style=color:#a6e22e;text-decoration:underline>Demo4 </span><span>{
</span><span>
</span><span>    </span><span style=color:#f92672>public static </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>main</span><span>(</span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#f92672>[] </span><span style=color:#fd971f;font-style:italic>args</span><span>) </span><span style=color:#f92672>throws </span><span style=color:#66d9ef;font-style:italic>Exception </span><span>{
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span> classPool </span><span style=color:#f92672>= </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>.getDefault();
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassFile</span><span> classFile </span><span style=color:#f92672>=</span><span> classPool.get(</span><span style=color:#e6db74>"com.ks.test.app.Point"</span><span>).getClassFile();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>Bytecode</span><span> bytecode </span><span style=color:#f92672>= new </span><span style=color:#66d9ef;font-style:italic>Bytecode</span><span>(classFile.getConstPool());
</span><span>        bytecode.addLload(</span><span style=color:#ae81ff>0</span><span>);
</span><span>        bytecode.addInvokespecial(</span><span style=color:#e6db74>"java/lang/Object"</span><span>, </span><span style=color:#66d9ef;font-style:italic>MethodInfo</span><span>.nameInit, </span><span style=color:#e6db74>"()V"</span><span>);
</span><span>        bytecode.addReturn(</span><span style=color:#ae81ff>null</span><span>);
</span><span>        </span><span style=color:#75715e>// addInvokespecial
</span><span>        </span><span style=color:#75715e>// 调用 java.lang.Object &lt;init> 方法
</span><span>        </span><span style=color:#66d9ef;font-style:italic>MethodInfo</span><span> methodInfo </span><span style=color:#f92672>= new </span><span style=color:#66d9ef;font-style:italic>MethodInfo</span><span>(classFile.getConstPool(), </span><span style=color:#66d9ef;font-style:italic>MethodInfo</span><span>.nameInit, </span><span style=color:#e6db74>"()V"</span><span>);
</span><span>        methodInfo.setCodeAttribute(bytecode.toCodeAttribute());
</span><span>        classFile.addMethod(methodInfo);
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>CodeIterator</span><span> codeIterator </span><span style=color:#f92672>=</span><span> bytecode.toCodeAttribute().iterator();
</span><span>        </span><span style=color:#75715e>// 打印字节码
</span><span>        </span><span style=color:#f92672>while </span><span>(codeIterator.hasNext()) {
</span><span>            </span><span style=color:#66d9ef;font-style:italic>int</span><span> index </span><span style=color:#f92672>=</span><span> codeIterator.next();
</span><span>            </span><span style=color:#66d9ef;font-style:italic>int</span><span> op </span><span style=color:#f92672>=</span><span> codeIterator.byteAt(index);
</span><span>            </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println(</span><span style=color:#66d9ef;font-style:italic>Mnemonic</span><span>.</span><span style=color:#ae81ff>OPCODE</span><span>[op]);
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h3 id=hot-load-java-class>Hot load Java Class</h3><p>运行时替换 Java Class，可以通过以下2种方式：<h4 id=redefineclassagent>RedefineClassAgent</h4><p>RedefineClassAgent 工具类，生成 jvm agent，并load agent，利用 <code>Instrumentation</code> <code>redefineClasses</code> 更新运行时类字节码信息；<p>以下为关键代码：<p><strong>创建和加载Agent</strong><pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span>  </span><span style=color:#75715e>/**
</span><span style=color:#75715e>     * Lazy loads the agent that populates {</span><span style=color:#f92672>@link </span><span style=color:#75715e>#instrumentation}. OK to call multiple times.
</span><span style=color:#75715e>     *
</span><span style=color:#75715e>     * </span><span style=color:#f92672>@throws </span><span style=color:#75715e>FailedToLoadAgentException if agent either failed to load or if the agent wasn't able to get an
</span><span style=color:#75715e>     *                                    instance of {</span><span style=color:#f92672>@link </span><span style=color:#75715e>Instrumentation} that allows class redefinitions.
</span><span style=color:#75715e>     */
</span><span style=color:#75715e>    private static void ensureAgentLoaded() throws FailedToLoadAgentException {
</span><span style=color:#75715e>        if (instrumentation != null) {
</span><span style=color:#75715e>            // already loaded
</span><span style=color:#75715e>            return;
</span><span style=color:#75715e>        }
</span><span style=color:#75715e>
</span><span style=color:#75715e>        // load the agent
</span><span style=color:#75715e>        try {
</span><span style=color:#75715e>            File agentJar = createAgentJarFile();
</span><span style=color:#75715e>
</span><span style=color:#75715e>            // Loading an agent requires the PID of the JVM to load the agent to. Find out our PID.
</span><span style=color:#75715e>            String nameOfRunningVM = ManagementFactory.getRuntimeMXBean().getName();
</span><span style=color:#75715e>            String pid = nameOfRunningVM.substring(0, nameOfRunningVM.indexOf('@'));
</span><span style=color:#75715e>
</span><span style=color:#75715e>            // load the agent
</span><span style=color:#75715e>            VirtualMachine vm = VirtualMachine.attach(pid);
</span><span style=color:#75715e>            vm.loadAgent(agentJar.getAbsolutePath(), "");
</span><span style=color:#75715e>            vm.detach();
</span><span style=color:#75715e>        } catch (Exception e) {
</span><span style=color:#75715e>            throw new FailedToLoadAgentException(e);
</span><span style=color:#75715e>        }
</span><span style=color:#75715e>
</span><span style=color:#75715e>        // wait for the agent to load
</span><span style=color:#75715e>        for (int sec = 0; sec &lt; AGENT_LOAD_WAIT_TIME_SEC; sec++) {
</span><span style=color:#75715e>            if (instrumentation != null) {
</span><span style=color:#75715e>                // success!
</span><span style=color:#75715e>                return;
</span><span style=color:#75715e>            }
</span><span style=color:#75715e>
</span><span style=color:#75715e>            try {
</span><span style=color:#75715e>                LOGGER.info("Sleeping for 1 second while waiting for agent to load.");
</span><span style=color:#75715e>                Thread.sleep(1000);
</span><span style=color:#75715e>            } catch (InterruptedException e) {
</span><span style=color:#75715e>                Thread.currentThread().interrupt();
</span><span style=color:#75715e>                throw new FailedToLoadAgentException();
</span><span style=color:#75715e>            }
</span><span style=color:#75715e>        }
</span><span style=color:#75715e>
</span><span style=color:#75715e>        // agent didn't load
</span><span style=color:#75715e>        throw new FailedToLoadAgentException();
</span><span style=color:#75715e>    }
</span><span style=color:#75715e>
</span><span style=color:#75715e>    /**
</span><span style=color:#75715e>     * An agent must be specified as a .jar where the manifest has an Agent-Class attribute. Additionally, in order
</span><span style=color:#75715e>     * to be able to redefine classes, the Can-Redefine-Classes attribute must be true.
</span><span style=color:#75715e>     *
</span><span style=color:#75715e>     * This method creates such an agent Jar as a temporary file. The Agent-Class is this class. If the returned Jar
</span><span style=color:#75715e>     * is loaded as an agent then {</span><span style=color:#f92672>@link </span><span style=color:#75715e>#agentmain(String, Instrumentation)} will be called by the JVM.
</span><span style=color:#75715e>     *
</span><span style=color:#75715e>     * </span><span style=color:#f92672>@return</span><span style=color:#75715e> a temporary {</span><span style=color:#f92672>@link </span><span style=color:#75715e>File} that points at Jar that packages this class.
</span><span style=color:#75715e>     * </span><span style=color:#f92672>@throws </span><span style=color:#75715e>IOException if agent Jar creation failed.
</span><span style=color:#75715e>     */
</span><span style=color:#75715e>    private static File createAgentJarFile() throws IOException {
</span><span style=color:#75715e>        File jarFile = File.createTempFile("agent", ".jar");
</span><span style=color:#75715e>        jarFile.deleteOnExit();
</span><span style=color:#75715e>
</span><span style=color:#75715e>        // construct a manifest that allows class redefinition
</span><span style=color:#75715e>        Manifest manifest = new Manifest();
</span><span style=color:#75715e>        Attributes mainAttributes = manifest.getMainAttributes();
</span><span style=color:#75715e>        mainAttributes.put(Attributes.Name.MANIFEST_VERSION, "1.0");
</span><span style=color:#75715e>        mainAttributes.put(new Attributes.Name("Agent-Class"), RedefineClassAgent.class.getName());
</span><span style=color:#75715e>        mainAttributes.put(new Attributes.Name("Can-Retransform-Classes"), "true");
</span><span style=color:#75715e>        mainAttributes.put(new Attributes.Name("Can-Redefine-Classes"), "true");
</span><span style=color:#75715e>
</span><span style=color:#75715e>        try (JarOutputStream jos = new JarOutputStream(new FileOutputStream(jarFile), manifest)) {
</span><span style=color:#75715e>            // add the agent .class into the .jar
</span><span style=color:#75715e>            JarEntry agent = new JarEntry(RedefineClassAgent.class.getName().replace('.', '/') + ".class");
</span><span style=color:#75715e>            jos.putNextEntry(agent);
</span><span style=color:#75715e>
</span><span style=color:#75715e>            // dump the class bytecode into the entry
</span><span style=color:#75715e>            ClassPool pool = ClassPool.getDefault();
</span><span style=color:#75715e>            CtClass ctClass = pool.get(RedefineClassAgent.class.getName());
</span><span style=color:#75715e>            jos.write(ctClass.toBytecode());
</span><span style=color:#75715e>            jos.closeEntry();
</span><span style=color:#75715e>        } catch (CannotCompileException | NotFoundException e) {
</span><span style=color:#75715e>            // Realistically this should never happen.
</span><span style=color:#75715e>            LOGGER.log(Level.SEVERE, "Exception while creating RedefineClassAgent jar.", e);
</span><span style=color:#75715e>            throw new IOException(e);
</span><span style=color:#75715e>        }
</span><span style=color:#75715e>
</span><span style=color:#75715e>        return jarFile;
</span><span style=color:#75715e>    }
</span></code></pre><p><strong>运行时更新类字节码</strong><pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span>    </span><span style=color:#75715e>/**
</span><span style=color:#75715e>     * Attempts to redefine class bytecode.
</span><span style=color:#75715e>     * &lt;</span><span style=color:#f92672>p</span><span style=color:#75715e>>
</span><span style=color:#75715e>     * On first call this method will attempt to load an agent into the JVM to obtain an instance of
</span><span style=color:#75715e>     * {</span><span style=color:#f92672>@link </span><span style=color:#75715e>Instrumentation}. This agent load can introduce a pause (in practice 1 to 2 seconds).
</span><span style=color:#75715e>     *
</span><span style=color:#75715e>     * </span><span style=color:#f92672>@see </span><span style=color:#75715e>Instrumentation#redefineClasses(ClassDefinition...)
</span><span style=color:#75715e>     *
</span><span style=color:#75715e>     * </span><span style=color:#f92672>@param </span><span style=color:#fd971f;font-style:italic>definitions</span><span style=color:#75715e> classes to redefine.
</span><span style=color:#75715e>     * </span><span style=color:#f92672>@throws </span><span style=color:#75715e>UnmodifiableClassException as thrown by {</span><span style=color:#f92672>@link </span><span style=color:#75715e>Instrumentation#redefineClasses(ClassDefinition...)}
</span><span style=color:#75715e>     * </span><span style=color:#f92672>@throws </span><span style=color:#75715e>ClassNotFoundException as thrown by {</span><span style=color:#f92672>@link </span><span style=color:#75715e>Instrumentation#redefineClasses(ClassDefinition...)}
</span><span style=color:#75715e>     * </span><span style=color:#f92672>@throws </span><span style=color:#75715e>FailedToLoadAgentException if agent either failed to load or if the agent wasn't able to get an
</span><span style=color:#75715e>     *                                    instance of {</span><span style=color:#f92672>@link </span><span style=color:#75715e>Instrumentation} that allows class redefinitions.
</span><span style=color:#75715e>     */
</span><span style=color:#75715e>    public static void redefineClasses(ClassDefinition... definitions) throws UnmodifiableClassException, ClassNotFoundException, FailedToLoadAgentException {
</span><span style=color:#75715e>        ensureAgentLoaded();
</span><span style=color:#75715e>        instrumentation.redefineClasses(definitions);
</span><span style=color:#75715e>    }
</span></code></pre><p><strong>测试代码</strong><pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>java</span><span>.</span><span style=color:#66d9ef;font-style:italic>lang</span><span>.</span><span style=color:#66d9ef;font-style:italic>instrument</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassDefinition</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>CtClass</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>CtMethod</span><span>;
</span><span>
</span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>class </span><span style=color:#a6e22e;text-decoration:underline>Demo5 </span><span>{
</span><span>
</span><span>    </span><span style=color:#f92672>public static </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>main</span><span>(</span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#f92672>[] </span><span style=color:#fd971f;font-style:italic>args</span><span>) </span><span style=color:#f92672>throws </span><span style=color:#66d9ef;font-style:italic>Exception </span><span>{
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span> classPool </span><span style=color:#f92672>= </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>.getDefault();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>CtClass</span><span> ctClass </span><span style=color:#f92672>=</span><span> classPool.get(</span><span style=color:#e6db74>"com.ks.test.app.Point"</span><span>);
</span><span>
</span><span>        ctClass.stopPruning(</span><span style=color:#ae81ff>true</span><span>);
</span><span>        </span><span style=color:#75715e>// javaassist freezes methods if their bytecode is saved
</span><span>        </span><span style=color:#75715e>// defrost so we can still make changes.
</span><span>        </span><span style=color:#f92672>if </span><span>(ctClass.isFrozen()) {
</span><span>            ctClass.defrost();
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>CtMethod</span><span> ctMethod </span><span style=color:#f92672>=</span><span> ctClass.getDeclaredMethod(</span><span style=color:#e6db74>"move"</span><span>);
</span><span>        ctMethod.insertBefore(</span><span style=color:#e6db74>"{ System.out.println(</span><span style=color:#ae81ff>\"</span><span style=color:#e6db74>Wheeeeee!</span><span style=color:#ae81ff>\"</span><span style=color:#e6db74>); }"</span><span>);
</span><span>        </span><span style=color:#66d9ef;font-style:italic>byte</span><span style=color:#f92672>[]</span><span> bytecode </span><span style=color:#f92672>=</span><span> ctClass.toBytecode();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassDefinition</span><span> definition </span><span style=color:#f92672>= new </span><span style=color:#66d9ef;font-style:italic>ClassDefinition</span><span>(</span><span style=color:#66d9ef;font-style:italic>Class</span><span>.forName(</span><span style=color:#e6db74>"com.ks.test.app.Point"</span><span>), bytecode);
</span><span>        </span><span style=color:#66d9ef;font-style:italic>RedefineClassAgent</span><span>.redefineClasses(definition);
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>Point</span><span> point </span><span style=color:#f92672>= new </span><span style=color:#66d9ef;font-style:italic>Point</span><span>(</span><span style=color:#ae81ff>1</span><span>, </span><span style=color:#ae81ff>1</span><span>);
</span><span>        point.move(</span><span style=color:#ae81ff>1</span><span>, </span><span style=color:#ae81ff>2</span><span>);
</span><span>    }
</span><span>}
</span></code></pre><h4 id=hotswapper>HotSwapper</h4><p>使用 javassist HotSwapper 工具，该工具依赖 <a href=https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/introclientissues005.html>JDWP</a>；<blockquote><p>JDWP: Provides the implementation of the Java Debug Wire Protocol (JDWP) agent.<p>使用方法：<code>java -Xdebug -Xrunjdwp:transport=dt_socket,address=8888,server=y,suspend=y Test</code><p>参考文档：<ul><li><p><a href=https://www.baeldung.com/java-application-remote-debugging>Java Application Remote Debugging | Baeldung</a></p><li><p><a href=https://docs.oracle.com/en/java/javase/12/docs/specs/jpda/architecture.html>JDWP Structure Overview</a></p><li><p><a href=https://mahmoudanouti.wordpress.com/2019/07/07/remote-debugging-java-applications-with-jdwp/>Remote Debugging Java Applications With JDWP | Learning Quest</a></p></ul></blockquote><p>测试代码：<pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>CtClass</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>CtMethod</span><span>;
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>javassist</span><span>.</span><span style=color:#66d9ef;font-style:italic>util</span><span>.</span><span style=color:#66d9ef;font-style:italic>HotSwapper</span><span>;
</span><span>
</span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>class </span><span style=color:#a6e22e;text-decoration:underline>Demo6 </span><span>{
</span><span>
</span><span>    </span><span style=color:#75715e>//执行命令
</span><span>    </span><span style=color:#75715e>//java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=10240 Demo6
</span><span>    </span><span style=color:#f92672>public static </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>main</span><span>(</span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#f92672>[] </span><span style=color:#fd971f;font-style:italic>args</span><span>) </span><span style=color:#f92672>throws </span><span style=color:#66d9ef;font-style:italic>Exception </span><span>{
</span><span>        </span><span style=color:#66d9ef;font-style:italic>HotSwapper</span><span> hs </span><span style=color:#f92672>= new </span><span style=color:#66d9ef;font-style:italic>HotSwapper</span><span>(</span><span style=color:#ae81ff>10240</span><span>);
</span><span>        </span><span style=color:#f92672>new </span><span style=color:#66d9ef;font-style:italic>Hello</span><span>().print();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span> classPool </span><span style=color:#f92672>= </span><span style=color:#66d9ef;font-style:italic>ClassPool</span><span>.getDefault();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>byte</span><span style=color:#f92672>[]</span><span> originBytes </span><span style=color:#f92672>=</span><span> classPool.get(</span><span style=color:#e6db74>"com.ks.test.app.Hello"</span><span>).toBytecode();
</span><span>        </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println(</span><span style=color:#e6db74>"** reload a v2 version"</span><span>);
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>CtClass</span><span> ctClass </span><span style=color:#f92672>=</span><span> classPool.get(</span><span style=color:#e6db74>"com.ks.test.app.Hello"</span><span>);
</span><span>        ctClass.stopPruning(</span><span style=color:#ae81ff>true</span><span>);
</span><span>        </span><span style=color:#f92672>if</span><span>(ctClass.isFrozen()){
</span><span>            ctClass.defrost();
</span><span>        }
</span><span>        </span><span style=color:#66d9ef;font-style:italic>CtMethod</span><span> ctMethod </span><span style=color:#f92672>=</span><span> ctClass.getDeclaredMethod(</span><span style=color:#e6db74>"print"</span><span>);
</span><span>        ctMethod.insertBefore(</span><span style=color:#e6db74>"{System.out.println(</span><span style=color:#ae81ff>\"</span><span style=color:#e6db74>** HelloWorld.print()</span><span style=color:#ae81ff>\"</span><span style=color:#e6db74>);}"</span><span>);
</span><span>        hs.reload(</span><span style=color:#e6db74>"com.ks.test.app.Hello"</span><span>, ctClass.toBytecode());
</span><span>
</span><span>        </span><span style=color:#f92672>new </span><span style=color:#66d9ef;font-style:italic>Hello</span><span>().print();
</span><span>
</span><span>        </span><span style=color:#66d9ef;font-style:italic>System</span><span>.out.println(</span><span style=color:#e6db74>"** reload the original version"</span><span>);
</span><span>
</span><span>        hs.reload(</span><span style=color:#e6db74>"com.ks.test.app.Hello"</span><span>, originBytes);
</span><span>        </span><span style=color:#f92672>new </span><span style=color:#66d9ef;font-style:italic>Hello</span><span>().print();
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><p>测试命令：<pre style=color:#f8f8f2;background-color:#272822><code><span>mvn clean package
</span><span>
</span><span>java -cp "$JAVA_HOME/lib/*:target/javassit-tour-jar-with-dependencies.jar" -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=10240 com.ks.test.app.Demo6
</span></code></pre><blockquote><p>注意：需要把 jdk 目录里 lib 下 jar 加载到 classpath</blockquote><p>运行结果：<pre style=color:#f8f8f2;background-color:#272822><code><span>Listening for transport dt_socket at address: 10240
</span><span>hello world
</span><span>** reload a v2 version
</span><span>** HelloWorld.print()
</span><span>hello world
</span><span>** reload the original version
</span><span>hello world
</span></code></pre></div></div></section>