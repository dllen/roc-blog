<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>HDFS 源码阅读：12. DFSClient 初始化 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/hdfs/> /hdfs </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2026-01-23</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">HDFS 源码阅读：12. DFSClient 初始化</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p>当我们调用 <code>FileSystem.get(conf)</code> 时，发生了什么？<h2 id=1-filesystem-yu-distributedfilesystem>1. FileSystem 与 DistributedFileSystem</h2><p><code>FileSystem</code> 是 Hadoop 的抽象基类，支持 LocalFileSystem, S3AFileSystem, DistributedFileSystem (HDFS) 等多种实现。<p>HDFS 的实现类是 <code>org.apache.hadoop.hdfs.DistributedFileSystem</code>。<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#616e88>// DistributedFileSystem.java</span></span>
<span class=giallo-l><span style=color:#81a1c1>public void</span><span style=color:#88c0d0> initialize</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>URI</span><span> uri</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Configuration</span><span> conf</span><span style=color:#eceff4>)</span><span> throws IOException </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    super</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>initialize</span><span style=color:#eceff4>(</span><span>uri</span><span style=color:#eceff4>,</span><span> conf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    setConf</span><span style=color:#eceff4>(</span><span>conf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#616e88>    // 核心：创建 DFSClient</span></span>
<span class=giallo-l><span style=color:#81a1c1>    this</span><span style=color:#eceff4>.</span><span>dfs</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> DFSClient</span><span style=color:#eceff4>(</span><span>uri</span><span style=color:#eceff4>,</span><span> conf</span><span style=color:#eceff4>,</span><span> statistics</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>DistributedFileSystem</code> 基本上只是 <code>DFSClient</code> 的一层包装。<h2 id=2-dfsclient-gou-zao-han-shu>2. DFSClient 构造函数</h2><p><code>DFSClient</code> 是真正干活的类。它的构造函数非常庞大。<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#616e88>// DFSClient.java</span></span>
<span class=giallo-l><span style=color:#81a1c1>public</span><span style=color:#88c0d0> DFSClient</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>URI</span><span> nameNodeUri</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Configuration</span><span> conf</span><span style=color:#eceff4>, ...) {</span></span>
<span class=giallo-l><span style=color:#616e88>    // 1. 获取 NameNode 代理 (NameNodeProxies)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    this</span><span style=color:#eceff4>.</span><span>namenode</span><span style=color:#81a1c1> =</span><span> NameNodeProxies</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>createProxy</span><span style=color:#eceff4>(</span><span>conf</span><span style=color:#eceff4>,</span><span> nameNodeUri</span><span style=color:#eceff4>,</span><span> ClientProtocol</span><span style=color:#eceff4>.</span><span>class</span><span style=color:#eceff4>).</span><span style=color:#88c0d0>getProxy</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#616e88>    // 2. 初始化一些配置</span></span>
<span class=giallo-l><span style=color:#81a1c1>    this</span><span style=color:#eceff4>.</span><span>dfsClientConf</span><span style=color:#81a1c1> = new</span><span style=color:#88c0d0> DfsClientConf</span><span style=color:#eceff4>(</span><span>conf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#616e88>    // 3. 启动 LeaseRenewer (如果需要)</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=3-rpc-dai-li-proxy>3. RPC 代理 (Proxy)</h2><p><code>NameNodeProxies.createProxy</code> 负责创建一个实现了 <code>ClientProtocol</code> 接口的动态代理对象。<ul><li><strong>RetryPolicy</strong>: 代理对象封装了重试逻辑。例如，如果连接失败，会自动重试；如果是 HA 模式，会自动切换到 Standby NameNode 试探。<li><strong>FailoverProxyProvider</strong>: 决定了 HA 切换的策略（如 <code>ConfiguredFailoverProxyProvider</code>）。</ul><p>因此，我们在写代码时调用 <code>dfs.mkdirs("/tmp")</code>，实际上是调用了代理对象，代理对象通过 Protobuf RPC 发送请求给 NameNode，如果失败则自动重试，对用户代码透明。<h2 id=4-zong-jie>4. 总结</h2><p><code>DFSClient</code> 初始化建立了与 NameNode 的控制通道。接下来的读写操作，将由 <code>DFSClient</code> 指挥，并在必要时建立与 DataNode 的数据通道。</div></div></section>