<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>cosid 项目学习 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2023-03-18</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">cosid 项目学习</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><h2 id=xiang-mu-gai-shu>项目概述</h2><p>me.ahoo.cosid 是一个分布式 ID 生成器框架，提供了多种 ID 生成策略，支持雪花算法（Snowflake）、号段模式（Segment）等多种分布式 ID 生成方案。该项目旨在解决分布式系统中唯一 ID 生成的问题，具有高性能、可扩展、易用等特点。<h2 id=zhu-yao-te-xing>主要特性</h2><ol><li><p><strong>多种 ID 生成策略</strong>：</p> <ul><li>雪花算法（Snowflake）<li>号段模式（Segment）<li>基于时间的 ID 生成<li>自定义 ID 生成器</ul><li><p><strong>丰富的存储支持</strong>：</p> <ul><li>Redis<li>Zookeeper<li>JDBC<li>MongoDB</ul><li><p><strong>高性能</strong>：</p> <ul><li>本地缓存<li>批量获取<li>异步预分配</ul><li><p><strong>易于集成</strong>：</p> <ul><li>Spring Boot Starter<li>支持多种框架集成</ul><li><p><strong>可观测性</strong>：</p> <ul><li>提供监控指标<li>支持 Micrometer</ul></ol><h2 id=he-xin-gai-nian>核心概念</h2><h3 id=1-fen-bu-shi-id-sheng-cheng-ce-lue>1. 分布式 ID 生成策略</h3><h4 id=1-1-xue-hua-suan-fa-snowflake>1.1 雪花算法（Snowflake）</h4><p>雪花算法是一种基于时间的分布式 ID 生成算法，生成的 ID 是一个 64 位的长整型数字，由以下部分组成：<ul><li>符号位（1 位）：始终为 0<li>时间戳（41 位）：毫秒级时间戳<li>工作机器 ID（10 位）：包括 5 位数据中心 ID 和 5 位机器 ID<li>序列号（12 位）：毫秒内的计数器</ul><p>CosId 对雪花算法进行了优化和扩展，提供了更灵活的位分配方案和机器号分配策略。<h4 id=1-2-hao-duan-mo-shi-segment>1.2 号段模式（Segment）</h4><p>号段模式是一种基于数据库的 ID 生成策略，通过预先分配一段 ID 范围（号段）给应用实例，应用实例在内存中生成 ID，当号段用完时再去数据库获取新的号段。这种方式减少了数据库访问频率，提高了性能。<p>CosId 的号段模式支持多种存储介质，如 Redis、Zookeeper、JDBC、MongoDB 等。<h3 id=2-ji-qi-hao-fen-pei>2. 机器号分配</h3><p>在分布式环境中，为每个节点分配唯一的机器号是雪花算法的关键。CosId 提供了多种机器号分配策略：<ul><li>静态分配：通过配置文件指定<li>基于 Redis 的分配<li>基于 Zookeeper 的分配<li>基于数据库的分配</ul><h3 id=3-shi-zhong-hui-bo-chu-li>3. 时钟回拨处理</h3><p>时钟回拨是分布式系统中的常见问题，可能导致 ID 重复。CosId 提供了多种时钟回拨处理策略：<ul><li>抛出异常<li>等待时钟追赶<li>使用备用时钟源</ul><h2 id=shi-yong-shi-li>使用示例</h2><h3 id=maven-yi-lai>Maven 依赖</h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=xml><span class=giallo-l><span style=color:#81a1c1>&lt;dependency></span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;groupId></span><span>me.ahoo.cosid</span><span style=color:#81a1c1>&lt;/groupId></span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;artifactId></span><span>cosid-core</span><span style=color:#81a1c1>&lt;/artifactId></span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;version></span><span>${cosid.version}</span><span style=color:#81a1c1>&lt;/version></span></span>
<span class=giallo-l><span style=color:#81a1c1>&lt;/dependency></span></span></code></pre><h3 id=spring-boot-ji-cheng>Spring Boot 集成</h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=xml><span class=giallo-l><span style=color:#81a1c1>&lt;dependency></span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;groupId></span><span>me.ahoo.cosid</span><span style=color:#81a1c1>&lt;/groupId></span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;artifactId></span><span>cosid-spring-boot-starter</span><span style=color:#81a1c1>&lt;/artifactId></span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;version></span><span>${cosid.version}</span><span style=color:#81a1c1>&lt;/version></span></span>
<span class=giallo-l><span style=color:#81a1c1>&lt;/dependency></span></span></code></pre><h3 id=pei-zhi-shi-li>配置示例</h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>cosid</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  namespace</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> ${spring.application.name}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  snowflake</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    epoch</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 1577203200000</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    machine</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      distributor</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        type</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> redis</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  segment</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    mode</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> chain</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    distributor</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      type</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> redis</span></span></code></pre><h3 id=dai-ma-shi-li>代码示例</h3><h4 id=xue-hua-suan-fa>雪花算法</h4><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#616e88>// 获取雪花算法 ID 生成器</span></span>
<span class=giallo-l><span style=color:#8fbcbb>IdGenerator</span><span> idGenerator</span><span style=color:#81a1c1> =</span><span> cosIdContainer</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getIdGenerator</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>snowflake</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>// 生成 ID</span></span>
<span class=giallo-l><span style=color:#81a1c1>long</span><span> id</span><span style=color:#81a1c1> =</span><span> idGenerator</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>generate</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span></code></pre><h4 id=hao-duan-mo-shi>号段模式</h4><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=java><span class=giallo-l><span style=color:#616e88>// 获取号段模式 ID 生成器</span></span>
<span class=giallo-l><span style=color:#8fbcbb>IdGenerator</span><span> idGenerator</span><span style=color:#81a1c1> =</span><span> cosIdContainer</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>getIdGenerator</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>segment</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>// 生成 ID</span></span>
<span class=giallo-l><span style=color:#81a1c1>long</span><span> id</span><span style=color:#81a1c1> =</span><span> idGenerator</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>generate</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span></span></code></pre><h2 id=xing-neng-you-hua>性能优化</h2><p>CosId 在性能方面做了多种优化：<ol><li><strong>本地缓存</strong>：减少远程调用<li><strong>批量获取</strong>：一次获取多个 ID<li><strong>异步预分配</strong>：在后台异步获取下一个号段<li><strong>无锁设计</strong>：使用 CAS 操作减少锁竞争</ol><h2 id=zui-jia-shi-jian>最佳实践</h2><ol><li><p><strong>选择合适的 ID 生成策略</strong>：</p> <ul><li>对于高并发场景，推荐使用雪花算法<li>对于需要连续 ID 的场景，推荐使用号段模式</ul><li><p><strong>机器号分配</strong>：</p> <ul><li>在生产环境中，推荐使用分布式机器号分配策略<li>在开发环境中，可以使用静态分配</ul><li><p><strong>监控</strong>：</p> <ul><li>启用 Micrometer 监控，及时发现性能问题<li>关注时钟回拨事件</ul><li><p><strong>容灾</strong>：</p> <ul><li>配置多个 ID 生成器，互为备份<li>使用 Redis 集群或主从架构提高可用性</ul></ol><h2 id=kuo-zhan-yue-du>扩展阅读</h2><ol><li><a href=https://tech.meituan.com/2017/04/21/mt-leaf.html rel=external>分布式 ID 生成算法的比较</a><li><a href=https://juejin.cn/post/6844903562007314440 rel=external>雪花算法的优化</a><li><a href=https://www.cnblogs.com/haoxinyue/p/5208136.html rel=external>号段模式的实现原理</a></ol><h2 id=chang-jian-wen-ti>常见问题</h2><ol><li><p><strong>ID 重复问题</strong>：</p> <ul><li>检查时钟是否回拨<li>确保机器号唯一<li>验证序列号生成逻辑</ul><li><p><strong>性能问题</strong>：</p> <ul><li>使用本地缓存<li>批量获取 ID<li>调整号段大小</ul><li><p><strong>集成问题</strong>：</p> <ul><li>检查依赖版本兼容性<li>确认配置正确<li>查看日志排查问题</ul></ol><h2 id=zong-jie>总结</h2><p>me.ahoo.cosid 是一个功能丰富、性能优秀的分布式 ID 生成框架，提供了多种 ID 生成策略和存储支持，适用于各种分布式系统场景。通过合理配置和使用，可以解决分布式系统中唯一 ID 生成的问题，提高系统的可扩展性和性能。</div></div></section>