<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>BTrace User's Guide | Roc's Blog</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2020-03-18</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">BTrace User's Guide</h1><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><ul><li><p><a href=https://gist.github.com/yulewei/53339ccced8837686895e3c9f45557cc>原文地址</a></p><li><p><a href=https://gitee.com/dllen/dllen-demos/tree/master/btrace-demo>实验Demo</a></p></ul><blockquote><p>注意：btrace 版本和包名已经更新，编写 btrace 脚本时使用以下依赖，但是整体使用方式基本没有变化；<p>Q：Maven 无法下载 BTrace 的包。<p>A：手动将 BTrace bin 文件夹下的 jar 安装到本地 Maven 仓库。<pre class=language-shell data-lang=shell style=color:#f8f8f2;background-color:#272822><code class=language-shell data-lang=shell><span>export BTRACE_HOME=
</span><span>
</span><span>mvn install:install-file -Dfile=${BTRACE_HOME}/libs/btrace-agent.jar -DgroupId=org.openjdk.btrace -DartifactId=btrace-agent -Dversion=2.1.1 -Dpackaging=jar
</span><span>mvn install:install-file -Dfile=${BTRACE_HOME}/libs/btrace-client.jar -DgroupId=org.openjdk.btrace -DartifactId=btrace-client -Dversion=2.0.1 -Dpackaging=jar
</span><span>mvn install:install-file -Dfile=${BTRACE_HOME}/libs/btrace-boot.jar -DgroupId=org.openjdk.btrace -DartifactId=btrace-boot -Dversion=2.0.1 -Dpackaging=jar
</span></code></pre><pre class=language-xml data-lang=xml style=color:#f8f8f2;background-color:#272822><code class=language-xml data-lang=xml><span>&lt;</span><span style=color:#f92672>dependency</span><span>>
</span><span>    &lt;</span><span style=color:#f92672>groupId</span><span>>org.openjdk.btrace&lt;/</span><span style=color:#f92672>groupId</span><span>>
</span><span>    &lt;</span><span style=color:#f92672>artifactId</span><span>>btrace-client&lt;/</span><span style=color:#f92672>artifactId</span><span>>
</span><span>    &lt;</span><span style=color:#f92672>version</span><span>>2.1.0&lt;/</span><span style=color:#f92672>version</span><span>>
</span><span>&lt;/</span><span style=color:#f92672>dependency</span><span>>
</span><span>&lt;</span><span style=color:#f92672>dependency</span><span>>
</span><span>    &lt;</span><span style=color:#f92672>groupId</span><span>>org.openjdk.btrace&lt;/</span><span style=color:#f92672>groupId</span><span>>
</span><span>    &lt;</span><span style=color:#f92672>artifactId</span><span>>btrace-boot&lt;/</span><span style=color:#f92672>artifactId</span><span>>
</span><span>    &lt;</span><span style=color:#f92672>version</span><span>>2.1.0&lt;/</span><span style=color:#f92672>version</span><span>>
</span><span>&lt;/</span><span style=color:#f92672>dependency</span><span>>
</span><span>&lt;</span><span style=color:#f92672>dependency</span><span>>
</span><span>    &lt;</span><span style=color:#f92672>groupId</span><span>>org.openjdk.btrace&lt;/</span><span style=color:#f92672>groupId</span><span>>
</span><span>    &lt;</span><span style=color:#f92672>artifactId</span><span>>btrace-agent&lt;/</span><span style=color:#f92672>artifactId</span><span>>
</span><span>    &lt;</span><span style=color:#f92672>version</span><span>>2.1.0&lt;/</span><span style=color:#f92672>version</span><span>>
</span><span>&lt;/</span><span style=color:#f92672>dependency</span><span>>
</span></code></pre></blockquote><h1 id=btrace-user-s-guide>BTrace User’s Guide</h1><p><a href=https://github.com/btraceio/btrace/blob/master/docs/usersguide.html>https://github.com/btraceio/btrace/blob/master/docs/usersguide.html</a> <a href=https://web.archive.org/web/20170410014122/https://kenai.com/projects/btrace/pages/UserGuide>https://web.archive.org/web/20170410014122/https://kenai.com/projects/btrace/pages/UserGuide</a><ul><li><a href=https://scp.net.cn/blog/java-btrace-tour/#btrace-terminology>BTrace Terminology</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#btrace-program-structure>BTrace Program Structure</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#btrace-restrictions>BTrace Restrictions</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#a-simple-btrace-program>A simple BTrace program</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#steps-to-run-btrace>Steps to run BTrace</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#btrace-command-line>BTrace Command Line</a> <ul><li><a href=https://scp.net.cn/blog/java-btrace-tour/#optional>optional</a></ul><li><a href=https://scp.net.cn/blog/java-btrace-tour/#pre-compiling-btrace-scripts>Pre-compiling BTrace scripts</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#starting-an-application-with-btrace-agent>Starting an application with BTrace agent</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#btrace-annotations>BTrace Annotations</a> <ul><li><a href=https://scp.net.cn/blog/java-btrace-tour/#method-annotations>Method Annotations</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#argument-annotations>Argument Annotations</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#field-annotations>Field Annotations</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#class-annotations>Class Annotations</a></ul><li><a href=https://scp.net.cn/blog/java-btrace-tour/#dtrace-integration>DTrace Integration</a><li><a href=https://scp.net.cn/blog/java-btrace-tour/#btrace-samples>BTrace Samples</a></ul><hr><p><strong>BTrace</strong> is a safe, dynamic tracing tool for Java. BTrace works by dynamically (bytecode) instrumenting classes of a running Java program. BTrace inserts tracing actions into the classes of a running Java program and hotswaps the traced program classes.<h2 id=btrace-terminology>BTrace Terminology</h2><p><strong>Probe Point</strong><br> “location” or “event” at which a set of tracing statements are executed. Probe point is “place” or “event” of interest where we want to execute some tracing statements.<p><strong>Trace Actions or Actions</strong><br> Trace statements that are executed whenever a probe “fires”.<p><strong>Action Methods</strong><br> BTrace trace statements that are executed when a probe fires are defined inside a static method a class. Such methods are called “action” methods.<h2 id=btrace-program-structure>BTrace Program Structure</h2><p>A BTrace program is a plain Java class that has one or more <code>public static void</code> methods that are annotated with <a href=https://scp.net.cn/blog/java-btrace-tour/#btrace-annotations>BTrace annotations</a>. The annotations are used to specify traced program “locations” (also known as “probe points”). The tracing actions are specified inside the static method bodies. These static methods are referred as “action” methods.<h2 id=btrace-restrictions>BTrace Restrictions</h2><p>To guarantee that the tracing actions are “read-only” (i.e., the trace actions don’t change the state of the program traced) and bounded (i.e., trace actions terminate in bounded time), a BTrace program is allowed to do only a restricted set of actions. In particular, a BTrace class<ul><li><p>can <strong>not</strong> create new objects.</p><li><p>can <strong>not</strong> create new arrays.</p><li><p>can <strong>not</strong> throw exceptions.</p><li><p>can <strong>not</strong> catch exceptions.</p><li><p>can <strong>not</strong> make arbitrary instance or static method calls - only the <strong><code>public static</code></strong> methods of <strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/BTraceUtils.html>com.sun.btrace.BTraceUtils</a></strong> class may be called from a BTrace program.</p><li><p>can <strong>not</strong> assign to static or instance fields of target program’s classes and objects. But, BTrace class can assign to it’s own static fields (“trace state” can be mutated).</p><li><p>can <strong>not</strong> have instance fields and methods. Only <strong><code>static public void</code></strong> returning methods are allowed for a BTrace class. And all fields have to be static.</p><li><p>can <strong>not</strong> have outer, inner, nested or local classes.</p><li><p>can <strong>not</strong> have synchronized blocks or synchronized methods.</p><li><p>can <strong>not</strong> have loops (<strong><code>for, while, do..while</code></strong>)</p><li><p>can <strong>not</strong> extend arbitrary class (super class has to be java.lang.Object)</p><li><p>can <strong>not</strong> implement interfaces.</p><li><p>can <strong>not</strong> contains assert statements.</p><li><p>can <strong>not</strong> use class literals.</p> <h2 id=a-simple-btrace-program>A simple BTrace program</h2> <pre class=language-java data-lang=java style=color:#f8f8f2;background-color:#272822><code class=language-java data-lang=java><span style=color:#75715e>// import all BTrace annotations
</span><span style=color:#f92672>import </span><span style=color:#66d9ef;font-style:italic>com</span><span>.</span><span style=color:#66d9ef;font-style:italic>sun</span><span>.</span><span style=color:#66d9ef;font-style:italic>btrace</span><span>.</span><span style=color:#66d9ef;font-style:italic>annotations</span><span>.</span><span style=color:#f92672>*</span><span>;
</span><span style=color:#75715e>// import statics from BTraceUtils class
</span><span style=color:#f92672>import static </span><span style=color:#66d9ef;font-style:italic>com</span><span>.</span><span style=color:#66d9ef;font-style:italic>sun</span><span>.</span><span style=color:#66d9ef;font-style:italic>btrace</span><span>.</span><span style=color:#66d9ef;font-style:italic>BTraceUtils</span><span>.</span><span style=color:#f92672>*</span><span>;
</span><span style=color:#75715e>// @BTrace annotation tells that this is a BTrace program
</span><span>@BTrace
</span><span style=color:#f92672>public </span><span style=color:#66d9ef;font-style:italic>class </span><span style=color:#a6e22e;text-decoration:underline>HelloWorld </span><span>{
</span><span>  </span><span style=color:#75715e>// @OnMethod annotation tells where to probe.
</span><span>  </span><span style=color:#75715e>// In this example, we are interested in entry 
</span><span>  </span><span style=color:#75715e>// into the Thread.start() method. 
</span><span>  @OnMethod(
</span><span>      </span><span style=color:#fd971f;font-style:italic>clazz</span><span style=color:#f92672>=</span><span style=color:#e6db74>"java.lang.Thread"</span><span>,
</span><span>      </span><span style=color:#fd971f;font-style:italic>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>"start"
</span><span>  )
</span><span>  </span><span style=color:#f92672>public static </span><span style=color:#66d9ef;font-style:italic>void </span><span style=color:#a6e22e>func</span><span>() {
</span><span>      </span><span style=color:#75715e>// println is defined in BTraceUtils
</span><span>      </span><span style=color:#75715e>// you can only call the static methods of BTraceUtils
</span><span>      println(</span><span style=color:#e6db74>"about to start a thread!"</span><span>);
</span><span>  }
</span><span>}
</span></code></pre> <p>The above BTrace program can be run against a running Java process. This program will print “about to start a thread!” at the BTrace client whenever the target program is about to start a thread by <code>Thread.start()</code> method. There are other interesting probe points possible. For example, we can insert trace action at return from a method, exception return from a method, a field get or set within method(s), object/array creation, line number(s), throwing an exception. Please refer to the <a href=https://scp.net.cn/blog/java-btrace-tour/#btrace-annotations>@OnMethod and other annotations</a> for details.</p> <h2 id=steps-to-run-btrace>Steps to run BTrace</h2></ul><ol><li><p>Find the process id of the target Java process that you want to trace. You can use <strong><a href=http://java.sun.com/javase/6/docs/technotes/tools/share/jps.html>jps</a></strong> tool to find the pid.</p><li><p>Write a BTrace program - you may want to start modifying one of the <strong><a href=https://scp.net.cn/blog/java-btrace-tour/#btrace-samples>samples</a></strong>.</p><li><p>Run <strong>btrace</strong> tool by the following command line:</p> <pre style=color:#f8f8f2;background-color:#272822><code><span>btrace &lt;pid> &lt;btrace-script>
</span></code></pre> <h2 id=btrace-command-line>BTrace Command Line</h2> <p>BTrace is run using the command line tool <strong>btrace</strong> as shown below:</p> <pre style=color:#f8f8f2;background-color:#272822><code><span>btrace [-I &lt;include-path>] [-p &lt;port>] [-cp &lt;classpath>] &lt;pid> &lt;btrace-script> [&lt;args>]
</span></code></pre> <p>where</p></ol><ul><li><p><code>include-path</code> is a set of include directories that are searched for header files. BTrace includes a simple preprocess with support for #define, #include and conditional compilation. It is <strong>not</strong> like a complete C/C++ preprocessor - but a useful subset. See the sample “ThreadBean.java”. If -I is not specified, BTrace skips the preprocessor invocation step.</p><li><p><code>port</code> is the port in which BTrace agent listens. This is optional argument.</p><li><p><code>classpath</code> is set of directories, jar files where BTrace searches for classes during compilation. Default is “.”.</p><li><p><code>pid</code> is the process id of the traced Java program</p><li><p><code>btrace-script</code> is the trace program. If it is a “.java”, then it is compiled before submission. Or else, it is assumed to be pre-compiled [i.e., it has to be a .class] and submitted.</p> <h3 id=optional>optional</h3><li><p><code>port</code> is the server socket port at which BTrace agent listens for clients. Default is 2020.</p><li><p><code>path</code> is the classpath used for compiling BTrace program. Default is “.”.</p><li><p><code>args</code> is command line arguments passed to BTrace program. BTrace program can access these using the built-in functions “$” and “$length”.</p> <h2 id=pre-compiling-btrace-scripts>Pre-compiling BTrace scripts</h2> <p>It is possible to precompile BTrace program using <strong>btracec</strong> script. btracec is a javac-like program that takes a BTrace program and produces a .class file.</p> <pre style=color:#f8f8f2;background-color:#272822><code><span>btracec [-I &lt;include-path>] [-cp &lt;classpath>] [-d &lt;directory>] &lt;one-or-more-BTrace-.java-files>
</span></code></pre> <p>where</p><li><p><code>include-path</code> is a set of include directories that are searched for header files. BTrace includes a simple preprocess with support for #define, #include and conditional compilation. It is <strong>not</strong> like a complete C/C++ preprocessor - but a useful subset. See the sample “ThreadBean.java”. If -I is not specified, BTrace skips the preprocessor invocation step.</p><li><p><code>classpath</code> is the classpath used for compiling BTrace program(s). Default is “.”</p><li><p><code>directory</code> is the output directory where compiled .class files are stored. Default is “.”. This script uses BTrace compiler class - rather than regular javac and therefore will validate your BTrace program at compile time [so that you can avoid BTrace verify error at runtime].</p> <h2 id=starting-an-application-with-btrace-agent>Starting an application with BTrace agent</h2> <p>So far, we saw how to trace a running Java program. It is also possible to start an application with BTrace agent in it. If you want to start tracing the application from the very “beginning”, you may want to start the app with BTrace agent and specify a trace script along with it [i.e., BTrace agent is attach-on-demand loadable as well as pre-loadable agent] You can use the following command to start an app and specify BTrace script file. But, you need to <a href=https://scp.net.cn/blog/java-btrace-tour/#pre-compiling-btrace-scripts>precompile your BTrace script</a> for this kind of usage.</p> <pre style=color:#f8f8f2;background-color:#272822><code><span>java -javaagent:btrace-agent.jar=script=&lt;pre-compiled-btrace-script> &lt;MainClass> &lt;AppArguments>
</span></code></pre> <p>When starting the application this way, the trace output goes to a file named &lt;btrace-class-file-name>.btrace in the current directory. Also, you can avoid starting server for other remote BTrace clients by specifying <code>noServer=true</code> as an argument to the BTrace agent. There is a convenient script called <strong>btracer</strong> to do the above:</p> <pre style=color:#f8f8f2;background-color:#272822><code><span>btracer &lt;pre-compiled-btrace.class> &lt;application-main-class> &lt;application-args>
</span></code></pre> <h2 id=btrace-annotations>BTrace Annotations</h2> <h3 id=method-annotations>Method Annotations</h3><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/OnMethod.html>@com.sun.btrace.annotations.OnMethod</a></strong> annotation can be used to specify target class(es), target method(s) and “location(s)” within the method(s). An action method annotated by this annotation is called when the matching method(s) reaches specified the location. In <code>OnMethod</code> annotation, traced class name is specified by “clazz” property and traced method is specified by “method” property. “clazz” may be a fully qualified class name (like <strong><code>java.awt.Component</code></strong> or a regular expression specified within two forward slashes. Refer to the samples <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/NewComponent.java>NewComponent.java</a></strong> and <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/Classload.java> Classload.java</a></strong>. The regular expression can match zero or more classes in which case all matching classes are instrumented. For example <strong><code>/java\\.awt\\..+/</code></strong> matches all classes in java.awt package. Also, method name can be a regular expression as well - matching zero or more methods. Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/MultiClass.java>MultiClass.java</a></strong>. There is another way to abstractly specify traced class(es) and method(s). Traced classes and methods may be specified by annotation. For example, if the “clazz” attribute is specified as <strong><code>@javax.jws.WebService</code></strong> BTrace will instrument all classes that are annotated by the WebService annotation. Similarly, method level annotations may be used to specify methods abstractly. Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/WebServiceTracker.java>WebServiceTracker.java</a></strong>. It is also possible to combine regular expressions with annotations - like <strong><code>@/com\\.acme\\..+/</code></strong> matches any class that is annotated by any annotation that matches the given regular expression. It is possible to match multiple classes by specifying super type. i.e., match all classes that are subtypes of a given super type. <strong><code>+java.lang.Runnable</code></strong> matches all classes implementing java.lang.Runnable interface. Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/SubtypeTracer.java>SubtypeTracer.java</a></strong>.</p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/OnTimer.html>@com.sun.btrace.annotations.OnTimer</a></strong> annotation can be used to specify tracing actions that have to run periodically once every N milliseconds. Time period is specified as long “value” property of this annotation. Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/Histogram.java>Histogram.java</a></strong></p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/OnError.html>@com.sun.btrace.annotations.OnError</a></strong> annotation can be used to specify actions that are run whenever any exception is thrown by tracing actions of some other probe. BTrace method annotated by this annotation is called when any exception is thrown by any of the other BTrace action methods in the same BTrace class.</p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/OnExit.html>@com.sun.btrace.annotations.OnExit</a></strong> annotation can be used to specify actions that are run when BTrace code calls “exit(int)” built-in function to finish the tracing “session”. Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/ProbeExit.java>ProbeExit.java</a></strong>.</p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/OnEvent.html>@com.sun.btrace.annotations.OnEvent</a></strong> annotation is used to associate tracing methods with “external” events send by BTrace client. BTrace methods annotated by this annotation are called when BTrace client sends an “event”. Client may send an event based on some form of user request to send (like pressing Ctrl-C or a GUI menu). String value may used as the name of the event. This way certain tracing actions can be executed whenever an external event “fires”. As of now, the command line BTrace client sends “events” whenever use presses Ctrl-C (SIGINT). On SIGINT, a console menu is shown to send an event or exit the client [which is the default for SIGINT]. Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/HistoOnEvent.java>HistoOnEvent.java</a></strong></p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/OnLowMemory.html>@com.sun.btrace.annotations.OnLowMemory</a></strong> annotation can be used to trace memory threshold exceed event. See sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/MemAlerter.java>MemAlerter.java</a></strong></p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/OnProbe.html>@com.sun.btrace.annotations.OnProbe</a></strong> annotation can be used to specify to avoid using implementation internal classes in BTrace scripts. <code>@OnProbe</code> probe specifications are mapped to one or more <code>@OnMethod</code> specifications by the BTrace VM agent. Currently, this mapping is done using a XML probe descriptor file [accessed by the BTrace agent]. Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/SocketTracker1.java>SocketTracker1.java</a></strong> and associated probe descriptor file <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/java.net.socket.xml>java.net.socket.xml</a></strong>. When running this sample, this xml file needs to be copied in the directory where the target JVM runs (or fix probeDescPath option in btracer.bat to point to whereever the .xml file is).</p> <h3 id=argument-annotations>Argument Annotations</h3><li><p><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/Self.html>@com.sun.btrace.annotations.Self</a> annotation can be used to mark an argument to hold <strong>this</strong> (or <strong>self</strong>) value. Refer to the samples <a href=https://github.com/btraceio/btrace/tree/master/samples/AWTEventTracer.java>AWTEventTracer.java</a> or <a href=https://github.com/btraceio/btrace/tree/master/samples/AllCalls1.java>AllCalls1.java</a></p><li><p><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/Return.html>@com.sun.btrace.annotations.Return</a> annotation can be used to mark an argument to hold the return value. Refer to the sample <a href=https://github.com/btraceio/btrace/tree/master/samples/Classload.java>Classload.java</a></p><li><p><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/ProbeClassName.html>@com.sun.btrace.annotations.ProbeClassName (since 1.1)</a> annotation can be used to mark an argument to hold the probed class name value. Refer to the sample <a href=https://github.com/btraceio/btrace/tree/master/samples/AllMethods.java>AllMethods.java</a></p><li><p><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/ProbeMethodName.html>@com.sun.btrace.annotations.ProbeMethodName (since 1.1)</a> annotation can be used to mark an argument to hold the probed method name. Refer to the sample <a href=https://github.com/btraceio/btrace/tree/master/samples/WebServiceTracker.java>WebServiceTracker.java</a></p> <ul><li>since 1.2 it accepts boolean parameter <strong>fqn</strong> to get a fully qualified probed method name</ul><li><p><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/Duration.html>@com.sun.btrace.annotations.Duration</a> annotation can be used to mark an argument to hold the duration of the method call in nanoseconds. The argument must be a long. Use with <strong>Kind.RETURN</strong> or <strong>Kind.ERROR</strong> locations.</p><li><p><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/TargetInstance.htm>@com.sun.btrace.annotations.TargetInstance (since 1.1)</a> annotation can be used to mark an argument to hold the called instance value. Refer to the sample <a href=https://github.com/btraceio/btrace/tree/master/samples/AllCalls2.java>AllCalls2.java</a></p><li><p><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/TargetMethodOrField.html>@com.sun.btrace.annotations.TargetMethodOrField (since 1.1)</a> can be used to mark an argument to hold the called method name. Refer to the samples <a href=https://github.com/btraceio/btrace/tree/master/samples/AllCalls1.java>AllCalls1.java</a> or <a href=https://github.com/btraceio/btrace/tree/master/samples/AllCalls2.java>AllCalls2.java</a></p> <ul><li><p>since 1.2 it accepts boolean parameter <strong>fqn</strong> to get a fully qualified target method name</p> <h4 id=unannotated-arguments>Unannotated arguments</h4> <p>The unannotated BTrace probe method arguments are used for the signature matching and therefore they must appear in the order they are defined in the traced method. However, they can be interleaved with any number of annotated arguments. If an argument of type *AnyType[]* is used it will “eat” all the rest of the arguments in they order. The exact meaning of the unannotated arguments depends on the <strong>Location</strong> used:</p></ul><li><p><strong>Kind.ENTRY, Kind.RETURN</strong>- the probed method arguments</p><li><p><strong>Kind.THROW</strong> - the thrown exception</p><li><p><strong>Kind.ARRAY_SET, Kind.ARRAY_GET</strong> - the array index</p><li><p><strong>Kind.CATCH</strong> - the caught exception</p><li><p><strong>Kind.FIELD_SET</strong> - the field value</p><li><p><strong>Kind.LINE</strong> - the line number</p><li><p><strong>Kind.NEW</strong> - the class name</p><li><p><strong>Kind.ERROR</strong> - the thrown exception</p> <h3 id=field-annotations>Field Annotations</h3><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/Export.html>@com.sun.btrace.annotations.Export</a></strong> annotation can be used with BTrace fields (static fields) to specify that the field has to be mapped to a jvmstat counter. Using this, a BTrace program can expose tracing counters to external jvmstat clients (such as jstat). Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/ThreadCounter.java>ThreadCounter.java</a></strong></p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/Property.html>@com.sun.btrace.annotations.Property</a></strong> annotation can be used to flag a specific (static) field as a MBean attribute. If a BTrace class has atleast one static field with <code>@Property</code> attribute, then a MBean is created and registered with platform MBean server. JMX clients such as VisualVM, jconsole can be used to view such BTrace MBeans. After attaching BTrace to the target program, you can attach VisualVM or jconsole to the same program and view the newly created BTrace MBean. With VisualVM and jconsole, you can use MBeans tab to view the BTrace domain and check out it’s attributes. Refer to the samples <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/ThreadCounterBean.java>ThreadCounterBean</a></strong> and <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/HistogramBean.java>HistogramBean.java</a></strong>.</p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/TLS.html>@com.sun.btrace.annotations.TLS</a></strong> annotation can be used with BTrace fields (static fields) to specify that the field is a thread local field. Each Java thread gets a separate “copy” of the field. These thread local fields may be used by BTrace programs to identify whether we reached multiple probe actions from the same thread or not. Refer to the samples <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/OnThrow.java>OnThrow.java</a></strong> and <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/WebServiceTracker.java>WebServiceTracker.java</a></strong></p> <h3 id=class-annotations>Class Annotations</h3><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/DTrace.html>@com.sun.btrace.annotations.DTrace</a></strong> annotation can be used to associate a simple one-liner D-script (inlined in BTrace Java class) with the BTrace program. Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/DTraceInline.java>DTraceInline.java</a></strong>.</p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/DTraceRef.html>@com.sun.btrace.annotations.DTraceRef</a></strong> annotation can be used to associate a D-script (stored in a separate file) with the BTrace program. Refer to the sample <strong><a href=https://github.com/btraceio/btrace/tree/master/samples/DTraceRefDemo.java>DTraceRefDemo.java</a></strong>.</p><li><p><strong><a href=https://static.javadoc.io/com.sun.tools.btrace/btrace-client/1.2.3/com/sun/btrace/annotations/BTrace.html>@com.sun.btrace.annotations.BTrace</a></strong> annotation must be used to designate a given Java class as a BTrace program. This annotation is enforced by the BTrace compiler as well as by the BTrace agent.</p> <h2 id=dtrace-integration>DTrace Integration</h2> <p>Solaris DTrace is a dynamic, safe tracing system for Solaris programs - both kernel and user land programs. Because of the obvious parallels b/w DTrace and BTrace, it is natural to expect integration b/w BTrace and DTrace. There are two ways in which BTrace is integrated with DTrace.</p><li><p>BTrace program can raise a DTrace probe - by calling <code>dtraceProbe</code> – see <code>BTraceUtils</code> javadoc referred above. For this feature to work, you need to be running on <strong>Solaris 10 or beyond</strong>. For other platforms (Solaris 9 or below or any other OS), <code>dtraceProbe()</code> will be a no-op.</p><li><p>BTrace program can associate a D-script with it– by <code>@DTrace</code> annotation (if the D-script is a simple one liner) or by <code>@DTraceRef</code> if the D-script is longer and hence stored outside of the BTrace program. See DTrace integration samples in the BTrace samples section below. This feature works using the <strong><a href=http://www.opensolaris.org/os/project/dtrace-chime/java_dtrace_api/>DTrace Java API</a></strong>. For this DTrace feature to work (o.e., being able to run associated D-script), you need to be running on <strong>Solaris 11 build 35 or beyond</strong>. You may want to check whether you have <strong>/usr/share/lib/java/dtrace.jar</strong> on your machine or not. <code>@DTrace</code> and <code>@DTraceRef</code> annotations are ignored on other platforms (Solaris 10 or below or any other OS).</p> <h2 id=btrace-samples>BTrace Samples</h2> <p><strong><a href=https://github.com/btraceio/btrace/tree/master/samples>BTrace samples</a></strong> One lines about samples:</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/AWTEventTracer.java>AWTEventTracer.java</a> - demonstates tracing of AWT events by instrumenting <code>EventQueue.dispatchEvent()</code> method. Can filter events by instanceof check. This sample filters and prints only focus events.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/AllLines.java>AllLines.java</a> - demonstates line number based BTrace probes. It is possible to probe into any class (or classes) and line number(s). When the specified line number(s) of specified class(es) is reached, the BTrace probe fires and the corresponding action is executed.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/ArgArray.java>ArgArray.java</a> - prints all input arguments in every <code>readXXX</code> method of every class in java.io package. Demonstrates argument array access and multiple class/method matching in probe specifications.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/Classload.java>Classload.java</a> - prints stack trace on every successful classload (<code>defineClass</code> returns) by any userdefined class loader.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/CommandArg.java>CommandArg.java</a> - demonstrates BTrace command line argument access.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/Deadlock.java>Deadlock.java</a> - demonstrates <code>@OnTimer</code> probe and <code>deadlock()</code> built-in function.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/DTraceInline.java>DTraceInline.java</a> - demonstrates <code>@DTrace</code> annotation to associate a simple one-line D-script with the BTrace program.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/DTraceRefDemo.java>DTraceRefDemo.java</a> - demonstrates <code>@DTraceRef</code> annotation to associate a D-script file with the BTrace program. This sample associates <a href=https://github.com/btraceio/btrace/tree/master/samples/classload.d>classload.d</a> with itself.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/FileTracker.java>FileTracker.java</a> - prints file open for read/write by probing into <code>File{Input/Output}Stream</code> constructor entry points.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/FinalizeTracker.java>FinalizeTracker.java</a> - demonstrates that we can print all fields of an object and access (private) fields (read-only) as well. This is useful in debugging / troubleshooting scenarios. This sample prints info on <code>close() /finalize()</code> methods of <code>java.io.FileInputStream</code> class.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/Histogram.java>Histogram.java</a> - demonstates usage of BTrace maps for collecting histogram (of <code>javax.swing.JComponent</code> objects created by an app - histogram by subclass name and count).</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/HistogramBean.java>HistogramBean.java</a> - demonstates JMX integration. This sample exposes a Map as MBean attribute using <code>@Property</code> annotation.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/HistoOnEvent.java>HistoOnEvent.java</a> - demonstrates getting trace output based on client side event. After starting the script by BTrace client, press Ctrl-C to get menu to send event or exit. On sending event, histogram is printed. This way client can “pull” trace output whenever needed rather than BTrace agent pushing the trace output always or based on timer.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/JdbcQueries.java>JdbcQueries.java</a> - demonstrates BTrace aggregation facility. This facility is similar to <strong><a href=http://dlc.sun.com/osol/docs/content/DTRCUG/gcggh.html> DTrace aggregation</a></strong> facility.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/JInfo.java>JInfo.java</a> - demonstrates <code>printVmArguments()</code>, <code>printProperties()</code> and <code>printEnv()</code> built-in functions.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/JMap.java>JMap.java</a> - demonstrates <code>dumpHeap()</code> built-in function to dump (hprof binary format) heap dump of the target application.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/JStack.java>JStack.java</a> - demonstrates <code>jstackAll()</code> built-in function to print stack traces of all the threads.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/LogTracer.java>LogTracer.java</a> - demonstrates trapping into an instance method (Logger.log) and printing private field value (of LogRecord object) by <code>field()</code> and <code>objectValue()</code> built-in functions.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/MemAlerter.java>MemAlerter.java</a> - demonstrates tracing low memory event by <code>@OnLowMememory</code> annotation.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/Memory.java>Memory.java</a> - prints memory stat once every 4 seconds by a timer probe. Demonstrates memory stat built-in functions.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/MultiClass.java>MultiClass.java</a> - demonstrates inserting trace code into multiple methods of multiple classes using regular expressions for <code>clazz</code> and <code>method</code> fields of <code>@OnMethod</code> annotation.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/NewComponent.java>NewComponent.java</a> - tracks every <code>java.awt.Component</code> creation and increments a counter and prints the counter based on a timer.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/OnThrow.java>OnThrow.java</a> - prints exception stack trace every time any exception instance is created. In most scenarios, exceptions are thrown immediately after creation. So, it we get stack trace of throw points.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/ProbeExit.java>ProbeExit.java</a> - demonstrates <code>@OnExit</code> probe and <code>exit(int)</code> built-in function.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/Sizeof.java>Sizeof.java</a> - demonstates “sizeof” built-in function that can be used to get (approx.) size of a given Java object. It is possible to get size-wise histogram etc. using this built-in.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/SocketTracker.java>SocketTracker.java</a> - prints every server socker creation/bind and client socket accepts.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/SocketTracker1.java>SocketTracker1.java</a> - similar to SocketTracker.java sample, except that this sample uses <code>@OnProbe</code> probes to avoid using Sun specific socket channel implementation classes in BTrace program. Instead <code>@OnProbe</code> probes are mapped to <code>@OnMethod</code> probes by BTrace agent.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/SysProp.java>SysProp.java</a> - demonstrates that it is okay to probe into System classes (like <code>java.lang.System</code>) and call BTrace built-in functions in the action method.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/SubtypeTracer.java>SubtypeTracer.java</a> - demonstrates that it is possible to match all subtypes of a given supertype.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/ThreadCounter.java>ThreadCounter.java</a> - demonstrates use of jvmstat counters from BTrace programs.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/ThreadCounterBean.java>ThreadCounterBean.java</a> - demonstrates exposing the BTrace program as a JMX bean with one attribute (using <code>@Property</code> annotation).</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/ThreadBean.java>ThreadBean.java</a> - demonstrates the use of preprocessor of BTrace [and JMX integratio].</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/ThreadStart.java>ThreadStart.java</a> - demonstrates raising DTrace probes from BTrace programs. See also <a href=https://github.com/btraceio/btrace/tree/master/samples/jthread.d>jthread.d</a> - the associated D-script. This sample raises a DTrace USDT probe whenever the traced program enters <code>java.lang.Thread.start()</code> method. The BTrace program passes JavaThread’s name to DTrace.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/Timers.java>Timers.java</a> - demonstrates multiple timer probes (<code>@OnTimer</code>) in a BTrace program.</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/URLTracker.java>URLTracker.java</a> - prints URL every time <code>URL.openConnection</code> returns successfully. This program uses <a href=https://github.com/btraceio/btrace/tree/master/samples/jurls.d>jurls.d</a> D-script as well (to show histogram of URLs opened via DTrace).</p><li><p><a href=https://github.com/btraceio/btrace/tree/master/samples/WebServiceTracker.java>WebServiceTracker.java</a> - demonstates tracing classes and methods by specifying class and method level annotations rather than class and method names.</p></ul></div></div></section>