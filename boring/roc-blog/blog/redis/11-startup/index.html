<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Redis 源码阅读：11. Server 启动流程 (main 函数) | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/redis/> /redis </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2026-01-11</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Redis 源码阅读：11. Server 启动流程 (main 函数)</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p>Redis 的入口位于 <code>src/server.c</code> 的 <code>main</code> 函数。整个启动过程可以概括为以下几个步骤：<h2 id=1-chu-shi-hua-quan-ju-pei-zhi>1. 初始化全局配置</h2><p><code>initServerConfig()</code>：设置 <code>server</code> 结构体的默认值。<ul><li>默认端口 6379<li>默认 DB 数量 16<li>默认持久化策略等</ul><h2 id=2-jia-zai-pei-zhi-wen-jian>2. 加载配置文件</h2><p>如果启动时指定了配置文件（如 <code>./redis-server redis.conf</code>），Redis 会调用 <code>loadServerConfig()</code> 解析配置文件，并覆盖默认配置。<h2 id=3-chu-shi-hua-fu-wu-qi>3. 初始化服务器</h2><p><code>initServer()</code> 是启动流程中最核心的函数：<ul><li><strong>创建事件循环</strong>：<code>aeCreateEventLoop()</code>。<li><strong>分配 DB 内存</strong>：<code>server.db = zmalloc(sizeof(redisDb)*server.dbnum)</code>。<li><strong>监听端口</strong>：<code>listenToPort()</code>，绑定 TCP/UDP 端口。<li><strong>创建时间事件</strong>：<code>aeCreateTimeEvent</code>，注册 <code>serverCron</code>（Redis 的心跳函数）。<li><strong>创建文件事件</strong>：<code>aeCreateFileEvent</code>，注册 <code>acceptTcpHandler</code>，开始接受客户端连接。</ul><h2 id=4-jia-zai-shu-ju>4. 加载数据</h2><ul><li><strong>加载 AOF/RDB</strong>：<code>loadDataFromDisk()</code>。如果开启了 AOF，优先加载 AOF；否则加载 RDB。</ul><h2 id=5-kai-shi-shi-jian-xun-huan>5. 开始事件循环</h2><p><code>aeMain()</code>：进入死循环，开始处理事件。<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>void</span><span style=color:#88c0d0> aeMain</span><span style=color:#eceff4>(</span><span>aeEventLoop </span><span style=color:#81a1c1>*</span><span>eventLoop</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>    eventLoop</span><span style=color:#81a1c1>-></span><span>stop</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    while</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span>eventLoop</span><span style=color:#81a1c1>-></span><span>stop</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        aeProcessEvents</span><span style=color:#eceff4>(</span><span>eventLoop</span><span style=color:#eceff4>,</span><span> AE_ALL_EVENTS</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>至此，Redis 启动完成，开始等待客户端的请求。</div></div></section>