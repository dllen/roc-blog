<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Redis 源码阅读：15. DB 结构 (键空间与过期字典) | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/redis/> /redis </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2026-01-11</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Redis 源码阅读：15. DB 结构 (键空间与过期字典)</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p>Redis 是一个 Key-Value 数据库，每个数据库实例都由 <code>redisDb</code> 结构体表示。<h2 id=1-redisdb-jie-gou-ti>1. redisDb 结构体</h2><p>在 <code>server.h</code> 中：<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>typedef struct</span><span> redisDb </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    dict </span><span style=color:#81a1c1>*</span><span>dict</span><span style=color:#81a1c1>;</span><span style=color:#616e88>                 // 键空间 (Key Space)，保存所有的键值对</span></span>
<span class=giallo-l><span>    dict </span><span style=color:#81a1c1>*</span><span>expires</span><span style=color:#81a1c1>;</span><span style=color:#616e88>              // 过期字典，保存所有设置了过期时间的 Key</span></span>
<span class=giallo-l><span>    dict </span><span style=color:#81a1c1>*</span><span>blocking_keys</span><span style=color:#81a1c1>;</span><span style=color:#616e88>        // 处于阻塞状态的 Key (如 BLPOP)</span></span>
<span class=giallo-l><span>    dict </span><span style=color:#81a1c1>*</span><span>ready_keys</span><span style=color:#81a1c1>;</span><span style=color:#616e88>           // 解除阻塞的 Key</span></span>
<span class=giallo-l><span>    dict </span><span style=color:#81a1c1>*</span><span>watched_keys</span><span style=color:#81a1c1>;</span><span style=color:#616e88>         // 被 WATCH 命令监控的 Key (用于事务)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    int</span><span> id</span><span style=color:#81a1c1>;</span><span style=color:#616e88>                     // 数据库 ID (0-15)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    long long</span><span> avg_ttl</span><span style=color:#81a1c1>;</span><span style=color:#616e88>          // 平均 TTL (用于统计)</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span> redisDb</span><span style=color:#81a1c1>;</span></span></code></pre><h2 id=2-jian-kong-jian-key-space>2. 键空间 (Key Space)</h2><p><code>dict *dict</code> 是数据库的核心。<ul><li>Key: 总是 String 对象。<li>Value: 可以是 String, List, Hash 等任何 Redis 对象。</ul><p>当我们执行 <code>GET key</code> 时，Redis 实际上就是在这个 <code>dict</code> 中查找 Key。 当我们执行 <code>FLUSHDB</code> 时，就是清空这个 <code>dict</code> 和 <code>expires</code>。<h2 id=3-guo-qi-zi-dian-expires>3. 过期字典 (Expires)</h2><p><code>dict *expires</code> 专门用于存储 Key 的过期时间。<ul><li>Key: 指向键空间中的同一个 String 对象 (复用指针，不浪费内存)。<li>Value: <code>long long</code> 类型的 UNIX 时间戳 (毫秒精度)。</ul><p>当我们执行 <code>TTL key</code> 时，Redis 会去 <code>expires</code> 字典中查找并计算剩余时间。 如果一个 Key 没有设置过期时间，它就不会出现在 <code>expires</code> 字典中。</div></div></section>