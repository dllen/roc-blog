<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Redis 源码阅读：开篇与源码地图 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/redis/> /redis </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2026-01-10</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Redis 源码阅读：开篇与源码地图</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p>Redis 作为全球最流行的内存数据库，其代码质量一直被开发者称道。它用纯 C 语言编写，没有复杂的依赖，代码风格简洁明快，是学习 C 语言网络编程、数据结构设计以及系统架构的绝佳范本。<p>本系列博客将带你深入 Redis 源码，从底层数据结构到核心事件模型，再到集群架构，一步步揭开 Redis 高性能背后的秘密。<h2 id=1-wei-shen-me-yao-du-redis-yuan-ma>1. 为什么要读 Redis 源码？</h2><p>在日常工作中，我们可能只需要掌握 Redis 的 API 和运维命令就能应付大多数场景。但如果你想进阶，阅读源码是必经之路：<ol><li><strong>知其所以然</strong>：了解 <code>SET</code>, <code>GET</code> 背后发生了什么，<code>HSET</code> 在什么情况下会从 ZipList 转换为 HashTable，有助于我们写出更高效的业务代码。<li><strong>排查疑难杂症</strong>：当生产环境出现莫名其妙的延迟或内存飙升时，源码级的理解能帮你快速定位病灶。<li><strong>学习系统设计</strong>：Redis 的事件循环（Event Loop）、渐进式 Rehash、RDB/AOF 持久化机制，都是系统设计中的经典案例。<li><strong>C 语言进阶</strong>：Redis 展示了如何用 C 语言实现面向对象（redisObject）、泛型数据结构（dict）等高级特性。</ol><h2 id=2-zhun-bei-gong-zuo>2. 准备工作</h2><h3 id=huo-qu-yuan-ma>获取源码</h3><p>建议直接从 GitHub Clone，方便切换分支和查看历史提交。<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>git</span><span style=color:#a3be8c> clone https://github.com/redis/redis.git</span></span>
<span class=giallo-l><span style=color:#88c0d0>cd</span><span style=color:#a3be8c> redis</span></span>
<span class=giallo-l><span style=color:#616e88># 建议切换到一个稳定版本，例如 7.0 或 7.2</span></span>
<span class=giallo-l><span style=color:#88c0d0>git</span><span style=color:#a3be8c> checkout</span><span style=color:#b48ead> 7.2.4</span></span></code></pre><h3 id=kai-fa-huan-jing>开发环境</h3><p>虽然 Redis 可以在 Linux/macOS 上直接编译运行，但为了方便阅读和跳转，推荐使用 IDE：<ul><li><strong>CLion</strong>: JetBrains 出品，C/C++ 开发神器，代码跳转和分析非常强大（收费/教育版免费）。<li><strong>VS Code</strong>: 配合 C/C++ 插件，轻量且免费。</ul><h3 id=bian-yi-yu-diao-shi>编译与调试</h3><p>Redis 的编译非常简单，没有 autotools/cmake 的复杂配置，直接 Make 即可。<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>make</span></span>
<span class=giallo-l><span style=color:#616e88># 编译带有调试信息的版本，方便 GDB/LLDB 调试</span></span>
<span class=giallo-l><span style=color:#88c0d0>make</span><span style=color:#a3be8c> noopt</span></span></code></pre><h2 id=3-yuan-ma-mu-lu-gai-lan>3. 源码目录概览</h2><p>打开 Redis 源码目录，你会看到以下核心文件夹：<ul><li><strong><code>src/</code></strong>: <strong>核心战场</strong>。Redis 的所有源代码都在这里。<li><strong><code>deps/</code></strong>: Redis 依赖的第三方库。Redis 倾向于将依赖库源码包含进来，保证编译的一致性。 <ul><li><code>hiredis</code>: 官方 C 客户端库。<li><code>jemalloc</code>: 默认的高性能内存分配器。<li><code>lua</code>: Lua 脚本引擎。<li><code>linenoise</code>: 命令行编辑库（用于 redis-cli）。</ul><li><strong><code>tests/</code></strong>: 测试用例。Redis 的测试覆盖率很高，使用 Tcl 编写。<li><strong><code>utils/</code></strong>: 工具脚本，如集群创建脚本等。<li><strong><code>redis.conf</code></strong>: 默认配置文件，包含详细的注释，本身就是一份很好的文档。</ul><h2 id=4-he-xin-dai-ma-di-tu-src>4. 核心代码地图 (src/)</h2><p>进入 <code>src/</code> 目录，几百个文件可能会让你眼花缭乱。我们可以按功能模块将它们分类：<h3 id=4-1-fu-wu-qi-qi-dong-yu-shi-jian-xun-huan-the-engine>4.1. 服务器启动与事件循环 (The Engine)</h3><p>这是 Redis 的心脏。<ul><li><strong><code>server.c</code> / <code>server.h</code></strong>: 全局入口。包含 <code>main</code> 函数，服务器初始化，主循环 <code>aeMain</code>。<code>server</code> 结构体保存了整个服务器的运行状态。<li><strong><code>ae.c</code> (Async Event)</strong>: 自封装的事件库。支持 epoll (Linux), kqueue (macOS), select 等多路复用技术。Redis 高并发的基石。</ul><h3 id=4-2-wang-luo-mo-xing-networking>4.2. 网络模型 (Networking)</h3><ul><li><strong><code>networking.c</code></strong>: 处理客户端连接、请求解析、响应发送。<li><strong><code>anet.c</code></strong>: 对 Socket API 的底层封装（bind, listen, accept, connect）。</ul><h3 id=4-3-ji-chu-shu-ju-jie-gou-data-structures>4.3. 基础数据结构 (Data Structures)</h3><p>Redis 造了很多轮子，为了追求极致的性能和内存效率。<ul><li><strong><code>sds.c</code> (Simple Dynamic String)</strong>: 增强版字符串，二进制安全，O(1) 获取长度。<li><strong><code>adlist.c</code></strong>: 双向链表。<li><strong><code>dict.c</code></strong>: 字典（哈希表）。Redis 的核心，KV 存储的基石。支持渐进式 Rehash。<li><strong><code>intset.c</code></strong>: 整数集合。当 Set 中只有整数且数量较少时使用，极省内存。<li><strong><code>zipmap.c</code> / <code>ziplist.c</code> / <code>listpack.c</code></strong>: 压缩列表。内存紧凑型结构，用于存储元素较少的 List/Hash/ZSet。注意：<code>listpack</code> 正在逐渐替代 <code>ziplist</code>。<li><strong><code>t_zset.c</code></strong>: 跳表 (Skiplist) 的实现，用于 ZSet。</ul><h3 id=4-4-dui-xiang-xi-tong-object-system>4.4. 对象系统 (Object System)</h3><ul><li><strong><code>object.c</code></strong>: 定义了 <code>redisObject</code> 结构体。Redis 所有的 Value（String, List, Hash…）在内部都封装为 <code>redisObject</code>。它实现了引用计数、LRU/LFU 信息记录等。</ul><h3 id=4-5-shu-ju-lei-xing-shi-xian-data-types>4.5. 数据类型实现 (Data Types)</h3><p>连接底层数据结构和用户命令的桥梁。<ul><li><code>t_string.c</code>: String 命令实现 (SET, GET…)<li><code>t_list.c</code>: List 命令实现 (LPUSH, LPOP…)<li><code>t_hash.c</code>: Hash 命令实现 (HSET, HGET…)<li><code>t_set.c</code>: Set 命令实现 (SADD, SMEMBERS…)<li><code>t_zset.c</code>: ZSet 命令实现 (ZADD, ZRANGE…)</ul><h3 id=4-6-chi-jiu-hua-persistence>4.6. 持久化 (Persistence)</h3><ul><li><strong><code>rdb.c</code></strong>: RDB 快照持久化。<li><strong><code>aof.c</code></strong>: AOF 日志持久化。</ul><h3 id=4-7-fen-bu-shi-te-xing>4.7. 分布式特性</h3><ul><li><strong><code>replication.c</code></strong>: 主从复制。<li><strong><code>sentinel.c</code></strong>: 哨兵模式，高可用切换。<li><strong><code>cluster.c</code></strong>: Redis Cluster 集群实现。</ul><h2 id=5-tui-jian-yue-du-lu-jing>5. 推荐阅读路径</h2><p>直接从 <code>main</code> 函数开始读通常会陷入细节的泥潭。我推荐的“由底向上，由点到面”的阅读顺序：<ol><li><strong>阶段一：底层基石</strong> <ul><li>先看 <code>sds.c</code>，最简单，热热身。<li>接着看 <code>adlist.c</code> 和 <code>dict.c</code>，理解 Redis 如何存数据。<li>浏览 <code>ziplist.c</code>/<code>listpack.c</code>，体会 Redis 对内存的“抠门”。</ul><li><strong>阶段二：对象系统</strong> <ul><li>阅读 <code>object.c</code> 和 <code>server.h</code> 中的 <code>redisObject</code> 定义，理解“类型”与“编码”的区别。</ul><li><strong>阶段三：事件驱动</strong> <ul><li>死磕 <code>ae.c</code>，理解 Redis 的 IO 多路复用模型。这是 Redis 快的最主要原因。</ul><li><strong>阶段四：请求处理流</strong> <ul><li>从 <code>server.c</code> 的 <code>main</code> 入手，看服务器初始化。<li>追踪一个命令的生命周期：<code>networking.c</code> (readQueryFromClient) -> <code>processInputBuffer</code> -> <code>processCommand</code> -> <code>call</code> -> <code>addReply</code>。</ul><li><strong>阶段五：进阶功能</strong> <ul><li>RDB/AOF、复制、集群、Lua 脚本等，根据兴趣按需阅读。</ul></ol><h2 id=jie-yu>结语</h2><p>Redis 源码是一座宝库。不要试图一次看完所有代码，抓住主线，理解核心思想才是关键。下一篇，我们将从 Redis 最基础的数据结构 —— <strong>SDS (Simple Dynamic String)</strong> 开始，揭开它比 C 字符串好用在哪里的秘密。</div></div></section>