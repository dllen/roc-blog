<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Redis 源码阅读：10. List, Hash, Set, ZSet 的编码演进 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/redis/> /redis </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2026-01-10</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Redis 源码阅读：10. List, Hash, Set, ZSet 的编码演进</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p>Redis 的集合类型（List, Hash, Set, ZSet）都有两种编码：一种用于<strong>少量数据</strong>（省内存），一种用于<strong>大量数据</strong>（高性能）。<h2 id=1-list>1. List</h2><ul><li><strong>编码</strong>：<code>quicklist</code> (Redis 3.2+)<li><strong>说明</strong>：List 现在只有一种编码 <code>quicklist</code>，它是 ZipList 和 LinkedList 的混合体。</ul><h2 id=2-hash>2. Hash</h2><ul><li><strong>编码 1：listpack</strong> (旧版本为 ziplist) <ul><li><strong>条件</strong>： <ul><li>所有键值对的键和值的字符串长度都 < <code>hash-max-listpack-value</code> (默认 64)。<li>键值对数量 < <code>hash-max-listpack-entries</code> (默认 512)。</ul><li><strong>特点</strong>：O(N) 查找，省内存。</ul><li><strong>编码 2：hashtable</strong> (即 dict) <ul><li><strong>条件</strong>：超过上述任一阈值。<li><strong>特点</strong>：O(1) 查找，内存占用较高。</ul></ul><h2 id=3-set>3. Set</h2><ul><li><strong>编码 1：intset</strong> <ul><li><strong>条件</strong>： <ul><li>所有元素都是<strong>整数</strong>。<li>元素数量 < <code>set-max-intset-entries</code> (默认 512)。</ul><li><strong>特点</strong>：O(log N) 查找，极省内存。</ul><li><strong>编码 2：hashtable</strong> (即 dict) <ul><li><strong>条件</strong>：不满足上述条件。<li><strong>特点</strong>：Value 全部为 NULL 的 Dict。</ul></ul><h2 id=4-zset-sorted-set>4. ZSet (Sorted Set)</h2><ul><li><strong>编码 1：listpack</strong> (旧版本为 ziplist) <ul><li><strong>条件</strong>： <ul><li>元素长度 < <code>zset-max-listpack-value</code> (默认 64)。<li>元素数量 < <code>zset-max-listpack-entries</code> (默认 128)。</ul><li><strong>结构</strong>：元素和 Score 紧挨着存储。</ul><li><strong>编码 2：skiplist</strong> <ul><li><strong>结构</strong>：同时包含一个 <code>dict</code> (用于 O(1) 查 Score) 和一个 <code>zskiplist</code> (用于范围查找)。<li><strong>注意</strong>：虽然名字叫 skiplist 编码，但实际上它是 dict + skiplist 的组合体。</ul></ul><h2 id=5-zong-jie>5. 总结</h2><p>Redis 的这种动态编码策略，体现了它对<strong>内存效率</strong>的极致追求。在阅读源码时，你会发现大量的代码都在处理这些编码转换（<code>convertAndCreate</code> 等函数）。</div></div></section>