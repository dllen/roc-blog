<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Redis 源码阅读：23. 事务 (Transaction) | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/redis/> /redis </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2026-01-11</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Redis 源码阅读：23. 事务 (Transaction)</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><p>Redis 的事务由 <code>MULTI</code>, <code>EXEC</code>, <code>DISCARD</code>, <code>WATCH</code> 命令组成。 代码主要在 <code>src/multi.c</code>。<h2 id=1-shi-wu-zhi-xing-liu-cheng>1. 事务执行流程</h2><ol><li><strong>MULTI</strong>：开启事务。客户端状态 <code>c->flags</code> 加上 <code>CLIENT_MULTI</code>。<li><strong>命令入队</strong>：后续发送的命令（除了 EXEC/DISCARD/WATCH）不会立即执行，而是被放入一个队列 (<code>c->mstate.commands</code>) 中，并返回 <code>QUEUED</code>。<li><strong>EXEC</strong>：执行事务。Redis 遍历队列，依次执行所有命令，并将所有结果一次性返回。</ol><h2 id=2-watch-ji-zhi-le-guan-suo>2. WATCH 机制 (乐观锁)</h2><p><code>WATCH key</code> 用于监视一个或多个 Key。 如果在事务执行（EXEC）之前，被监视的 Key 被其他客户端修改了，那么整个事务将<strong>中断执行</strong>，返回 <code>(nil)</code>。<p><strong>实现</strong>： Redis 维护一个 <code>watched_keys</code> 字典。 当执行写命令时，会检查修改的 Key 是否在 <code>watched_keys</code> 中。如果是，则将监视该 Key 的所有客户端标记为 <code>CLIENT_DIRTY_CAS</code>。 当客户端执行 <code>EXEC</code> 时，如果检测到自己被标记为 <code>CLIENT_DIRTY_CAS</code>，则拒绝执行事务。<h2 id=3-acid-te-xing-fen-xi>3. ACID 特性分析</h2><ul><li><strong>原子性 (Atomicity)</strong>：Redis 事务<strong>不完全满足</strong>原子性。 <ul><li>如果命令入队时就报错（如语法错误），整个事务不执行（原子性）。<li>如果入队成功，但执行时报错（如对 String 用了 List 命令），<strong>该条命令失败，但其他命令继续执行</strong>。Redis <strong>不支持回滚 (Rollback)</strong>。</ul><li><strong>一致性 (Consistency)</strong>：满足。<li><strong>隔离性 (Isolation)</strong>：满足。Redis 单线程执行命令，事务期间不会被插入其他命令。<li><strong>持久性 (Durability)</strong>：取决于 AOF/RDB 配置。</ul></div></div></section>