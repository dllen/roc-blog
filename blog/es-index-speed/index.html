<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Elasticsearch 索引性能优化实践 | 码农的自留地</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto px-auto xl:px-0 w-full xl:w-1/2 flex place-content-between py-16 xl:py-8 font-sans text-6xl xl:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><div class="container mx-auto w-full xl:w-1/2 mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl xl:text-base">2025-10-19</div><h1 class="w-full xl:w-2/3 mt-4 mb-8 font-serif text-8xl xl:text-4xl text-slate-900 dark:text-slate-300">Elasticsearch 索引性能优化实践</h1><div class="mt-2 mb-6 flex flex-wrap gap-2"></div><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class="prose dark:prose-invert prose-pre:rounded-none prose-headings:bg-amber-100 prose-headings:text-slate-800 dark:prose-headings:bg-indigo-900 prose-headings:font-normal dark:prose-headings:text-slate-300 prose-headings:p-2 prose-headings:w-max prose-headings:font-serif prose-2xl xl:prose-base"><h2 id=bei-jing-yu-mu-biao>背景与目标</h2><ul><li>背景：在日志/指标/业务数据持续摄入场景下，索引性能直接影响数据可用性与费用成本（CPU、IO 与磁盘）。<li>目标：结合官方建议形成可落地的“索引优化清单”，同时明确风险与回滚策略。</ul><p>参考：<ul><li>Elasticsearch 6.8 索引速度优化：https://www.elastic.co/guide/en/elasticsearch/reference/6.8/tune-for-indexing-speed.html#_disable_refresh_and_replicas_for_initial_loads<li>Elastic Docs 索引速度优化：https://www.elastic.co/docs/deploy-manage/production-guidance/optimize-performance/indexing-speed</ul><h2 id=yi-ye-qing-dan-quick-wins>一页清单（Quick Wins）</h2><ul><li>使用 <code>_bulk</code> 批量写入，按基准测试选择合适批次大小（建议请求体控制在数十 MB 内）。<li>提高 <code>index.refresh_interval</code>（如 30s），减少段切分与后续合并压力；初始大批量加载可临时设置为 <code>-1</code>。<li>初始批量加载时将 <code>index.number_of_replicas: 0</code>，完成后恢复副本数。<li>用多线程/多进程并发发送 bulk，监控 <code>429 TOO_MANY_REQUESTS</code> 并使用指数退避重试。<li>优先使用自动生成 <code>_id</code>，避免查重开销；写入密集的索引给足 index buffer。<li>给文件系统缓存留出足够内存（机器内存至少一半给 FS cache，合理控制 JVM heap）。<li>采用本地 SSD，避免远程文件系统；需要时用 RAID0 进行条带化，并通过副本与快照保障容错。</ul><h2 id=pi-liang-xie-ru-yu-bing-fa>批量写入与并发</h2><ul><li>批量大小优化：在单节点/单分片做基准测试，逐步增加批次（100→200→400→…），当速度趋于平稳即为合适大小；过大批次会导致内存压力与失败重试成本升高。<li>并发与退避：多线程/多进程并发发送 bulk；遇到 <code>429</code>（<code>EsRejectedExecutionException</code>）说明集群承压，应暂停并指数退避重试。</ul><h2 id=shua-xin-yu-fu-ben-chu-shi-jia-zai-de-jia-su-ce-lue>刷新与副本：初始加载的加速策略</h2><ul><li>提高刷新间隔：减少新段创建频率，降低合并压力并提升写入吞吐。</ul><pre class=language-json data-lang=json><code class=language-json data-lang=json>PUT my-index/_settings
{
  "index": {
    "refresh_interval": "30s"
  }
}
</code></pre><ul><li>初始加载禁用刷新与副本（风险可控）：</ul><pre class=language-json data-lang=json><code class=language-json data-lang=json>PUT my-index/_settings
{
  "index": {
    "refresh_interval": "-1",
    "number_of_replicas": 0
  }
}
</code></pre><ul><li>加载完成后恢复设置：</ul><pre class=language-json data-lang=json><code class=language-json data-lang=json>PUT my-index/_settings
{
  "index": {
    "refresh_interval": "1s",
    "number_of_replicas": 1
  }
}
</code></pre><ul><li>风险提示：在 <code>replicas=0</code> 与 <code>refresh=-1</code> 期间，任一分片丢失会导致数据丢失；仅在受控窗口期执行并做好快照/备份。</ul><h2 id=id-ce-lue-yu-suo-yin-huan-chong>ID 策略与索引缓冲</h2><ul><li>自动 ID：使用自动生成 <code>_id</code> 可跳过“同分片查重”，显著降低写入开销，尤其在索引规模增长后。<li>索引 Buffer：为重写入分片提升 <code>indices.memory.index_buffer_size</code>，最多让“单个重索引分片”获得约 512MB 的索引缓冲。</ul><pre class=language-json data-lang=json><code class=language-json data-lang=json>PUT _cluster/settings
{
  "persistent": {
    "indices.memory.index_buffer_size": "20%"
  }
}
</code></pre><ul><li>说明：默认 10% 通常足够（10GB 堆约 1GB buffer，可支撑两个重写入分片）；超过 512MB 对单分片收益有限。</ul><h2 id=wen-jian-xi-tong-huan-cun-yu-cun-chu-jie-zhi>文件系统缓存与存储介质</h2><ul><li>FS Cache：将机器内存至少一半留给文件系统缓存以缓冲 IO；避免系统发生 swap（禁用交换或设置 swappiness 很小）。<li>存储介质：优先本地 SSD；避免 NFS/SMB 远程文件系统；在云环境下使用有保障的 IOPS（如 EBS 的 provisioned IOPS）。<li>RAID0 条带化：提升单分片吞吐，但任一盘故障会破坏索引；通过副本与跨节点冗余降低风险，并定期快照。</ul><h2 id=jian-kong-yu-hui-tui>监控与回退</h2><ul><li>监控项：bulk 吞吐与失败率、<code>429</code> 比例、刷新/合并耗时、磁盘水位、线程池队列。<li>回退策略：一旦出现持续 <code>429</code> 或 IO 饱和，降低并发与批次大小；必要时临时提升刷新间隔或扩容集群资源。</ul><h2 id=feng-xian-yu-quan-heng>风险与权衡</h2><ul><li>刷新与副本调低：提升吞吐但降低数据与查询可用性；必须在窗口期执行，结束后及时恢复。<li>批量与并发过高：可能导致内存压力与失败后重试成本显著增加；基准测试与节流至关重要。<li>自动 <code>_id</code>：牺牲“指定 ID 的幂等写入能力”，但换取显著吞吐提升；如需幂等可在上层做去重/幂等逻辑。</ul><h2 id=can-kao>参考</h2><ul><li>Elasticsearch 6.8：Tune for indexing speed（禁用刷新与副本等） <ul><li>https://www.elastic.co/guide/en/elasticsearch/reference/6.8/tune-for-indexing-speed.html#_disable_refresh_and_replicas_for_initial_loads</ul><li>Elastic Docs：Optimize indexing speed（批量、并发与退避等） <ul><li>https://www.elastic.co/docs/deploy-manage/production-guidance/optimize-performance/indexing-speed</ul></ul></div></div></section>